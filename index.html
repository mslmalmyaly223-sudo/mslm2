<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<meta http-equiv="Content-Security-Policy" content="default-src 'self' https://www.gstatic.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://fonts.googleapis.com https://fonts.gstatic.com; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.gstatic.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; connect-src 'self' https://*.firebaseio.com https://*.googleapis.com https://api.deepseek.com; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com;">
<title>المساعد في السادس | Sixth Assistant</title>

<!-- Firebase v9 (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- pdf.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>try{pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';}catch{}</script>

<link rel="manifest" href="manifest.json">
	<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	
<!-- Tesseract.js -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<!-- MathJax -->
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<style>
:root {
    --bg:#0c0d10;
    --panel:#13151a;
    --card:#0f1116;
    --stroke:#242833;
    --text:#e9ecf1;
    --muted:#9aa4b2;
    --brand:#4a6bff;
    --ok:#2ecc71;
    --err:#e74c3c;
    --user-dark:#2e333d;
    --bot-dark:#0f1320;
    --user-light:#3b57ff;
    --bot-light:#ffffff;
    --safe-area-top: env(safe-area-inset-top, 0px);
    --safe-area-bottom: env(safe-area-inset-bottom, 0px);
}
:root.light{
    --bg:#f6f7fb;
    --panel:#ffffff;
    --card:#ffffff;
    --stroke:#dbe1ea;
    --text:#0b1220;
    --muted:#5b6473;
    --brand:#3b57ff;
    --ok:#1f9d5a;
    --err:#cf3434
}
*{
    box-sizing:border-box;
    -webkit-tap-highlight-color:transparent;
    user-select:none;
    -webkit-user-select:none
}
html,body{
    height:100vh;
    height: calc(100vh - var(--safe-area-top) - var(--safe-area-bottom));
    margin: 0;
    padding: 0;
}
body{
    background:var(--bg);
    color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,"Tajawal",sans-serif;
    overflow:hidden;
    padding-top: var(--safe-area-top);
    padding-bottom: var(--safe-area-bottom);
}
.hidden{display:none}

/* Toast صغير للتأكيد السريع */
.toast{
    position:fixed;
    inset-inline:0;
    top:12px;
    margin:auto;
    max-width:520px;
    background:#121826;
    color:#fff;
    border:1px solid var(--stroke);
    border-radius:12px;
    padding:10px 14px;
    text-align:center;
    z-index:999;
    opacity:0;
    transform:translateY(-8px);
    transition:.2s
}
.toast.show{
    opacity:1;
    transform:translateY(0)
}

/* Boot Animation جديد */
#boot{
    position:fixed;
    inset:0;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    background:var(--bg);
    z-index:100;
    color:var(--muted);
    gap:20px
}
.boot-logo{
    width:120px;
    height:120px;
    animation:logoFloat 3s ease-in-out infinite
}
.boot-title{
    font-size:32px;
    font-weight:900;
    background:linear-gradient(135deg,#4a6bff,#6d83ff);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    background-clip:text;
    animation:textGlow 2s ease-in-out infinite alternate
}
.boot-subtitle{
    font-size:16px;
    color:var(--muted);
    margin-top:-10px
}
.boot-loading{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:8px;
    margin-top:20px
}
.boot-progress{
    width:200px;
    height:4px;
    background:var(--stroke);
    border-radius:2px;
    overflow:hidden
}
.boot-progress-bar{
    height:100%;
    background:var(--brand);
    width:0%;
    transition:width 0.3s ease
}
.boot-text{
    font-size:14px;
    color:var(--muted)
}

@keyframes logoFloat{
    0%,100%{transform:translateY(0px)}
    50%{transform:translateY(-10px)}
}
@keyframes textGlow{
    0%{filter:drop-shadow(0 0 5px rgba(74,107,255,0.3))}
    100%{filter:drop-shadow(0 0 15px rgba(74,107,255,0.6))}
}
@keyframes letterWave{
    0%,100%{transform:translateY(0px)}
    25%{transform:translateY(-5px)}
    50%{transform:translateY(0px)}
    75%{transform:translateY(5px)}
}

.letter{
    display:inline-block;
    animation:letterWave 2s ease-in-out infinite
}
.letter:nth-child(1){animation-delay:0s}
.letter:nth-child(2){animation-delay:0.1s}
.letter:nth-child(3){animation-delay:0.2s}
.letter:nth-child(4){animation-delay:0.3s}
.letter:nth-child(5){animation-delay:0.4s}
.letter:nth-child(6){animation-delay:0.5s}
.letter:nth-child(7){animation-delay:0.6s}
.letter:nth-child(8){animation-delay:0.7s}
.letter:nth-child(9){animation-delay:0.8s}
.letter:nth-child(10){animation-delay:0.9s}
.letter:nth-child(11){animation-delay:1.0s}

#root{
    position:fixed;
    inset:0;
    display:none;
    grid-template-columns:280px 1fr;
    width:100vw;
    height:100vh;
    height: calc(100vh - var(--safe-area-top) - var(--safe-area-bottom));
}

/* Sidebar */
.sidebar{
    background:var(--panel);
    border-inline-end:1px solid var(--stroke);
    display:flex;
    flex-direction:column;
    min-width:260px;
    z-index:30
}
.side-head{
    padding:10px;
    border-bottom:1px solid var(--stroke);
    display:flex;
    align-items:center;
    gap:8px
}
.toggle{
    width:42px;
    height:42px;
    border-radius:12px;
    border:1px solid var(--stroke);
    background:#141821;
    color:#fff;
    font-weight:900;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer
}
:root.light .toggle{
    background:#eef1f8;
    color:#0b1220
}
.sub-badge{
    margin-inline-start:auto;
    font-size:12px;
    padding:8px 10px;
    border:1px solid var(--stroke);
    border-radius:999px;
    background:#0e1422;
    white-space:nowrap
}
:root.light .sub-badge{
    background:#eef2fb;
    color:#0b1220
}
.btn{
    height:48px;
    border-radius:12px;
    border:1px solid var(--stroke);
    background:#141821;
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    font-weight:700;
    cursor:pointer;
    padding:0 14px
}
:root.light .btn{
    background:#eef1f8;
    color:#0b1220
}
.btn.primary{
    background:var(--brand);
    border-color:transparent;
    color:#fff
}
.btn.flat{
    background:transparent
}
.btn[disabled]{
    opacity:.6;
    cursor:not-allowed
}
.list{
    flex:1;
    overflow:auto;
    padding:8px 6px
}
.item{
    padding:10px 12px;
    border-radius:10px;
    border:1px solid transparent;
    display:flex;
    align-items:center;
    gap:8px
}
.item:hover{
    background:#151a23
}
:root.light .item:hover{
    background:#eef2fb
}
.item.active{
    background:#0f1420;
    border-color:#2b3342
}
:root.light .item.active{
    background:#eaf0ff;
    border-color:#cfd9ff
}
.item-title{
    flex:1;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis
}
.item-ops{
    display:flex;
    gap:6px
}
.side-foot{
    padding:10px;
    border-top:1px solid var(--stroke);
    display:flex;
    flex-direction:column;
    gap:8px
}
.small{
    font-size:12px;
    color:var(--muted)
}
#sideOverlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.35);
    display:none;
    z-index:20
}

/* Main */
.main{
    display:grid;
    grid-template-rows:auto 1fr auto;
    min-width:0;
    min-height:0;
    position:relative;
    z-index:10;
    background:#0b0d12
}
:root.light .main{
    background:#f6f7fb
}
.topbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:8px 14px;
    border-bottom:1px solid var(--stroke);
    background:linear-gradient(180deg,#0d1016,#0c0d10);
    min-height:50px;
    max-height:50px;
}
:root.light .topbar{
    background:linear-gradient(180deg,#ffffff,#f1f3f8)
}
.topbar .left{
    display:flex;
    gap:8px;
    align-items:center
}

/* Intelligence Selector في الشريط العلوي */
.intelligence-selector{
    position:relative;
    display:flex;
    align-items:center;
    margin:0 auto
}
.intelligence-trigger{
    display:flex;
    align-items:center;
    gap:8px;
    background:var(--panel);
    border:1px solid var(--stroke);
    border-radius:20px;
    padding:8px 16px;
    font-size:14px;
    font-weight:600;
    cursor:pointer;
    transition:all 0.2s
}
.intelligence-trigger:hover{
    background:var(--card)
}
.intelligence-dropdown{
    position:absolute;
    top:100%;
    left:50%;
    transform:translateX(-50%);
    margin-top:8px;
    background:var(--panel);
    border:1px solid var(--stroke);
    border-radius:12px;
    padding:8px;
    min-width:120px;
    box-shadow:0 8px 24px rgba(0,0,0,0.3);
    z-index:100;
    display:none
}
.intelligence-dropdown.show{
    display:block
}
.intelligence-option{
    display:flex;
    align-items:center;
    gap:8px;
    padding:10px 12px;
    border-radius:8px;
    cursor:pointer;
    transition:all 0.2s
}
.intelligence-option:hover{
    background:var(--card)
}
.intelligence-option.active{
    background:var(--brand);
    color:#fff
}
.intelligence-option[disabled]{
    opacity:0.5;
    cursor:not-allowed;
    background:transparent
}
.intelligence-option[disabled]:hover{
    background:transparent
}

/* Messages */
.msgs{
    overflow:auto;
    -webkit-overflow-scrolling:touch;
    min-height:0;
    background:#0a0c11;
    padding:12px;
    padding-bottom:88px;
    height: calc(100vh - 120px);
}
:root.light .msgs{
    background:#f6f7fb
}
.msg {
    max-width: 92%;
    padding: 12px 14px;
    border-radius: 16px;
    margin: 8px 0;
    border: 1px solid var(--stroke);
    line-height: 1.5;
    word-wrap: break-word;
    white-space: pre-wrap;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,"Tajawal",sans-serif;
    font-size: 14px;
    position: relative;
    -webkit-user-select: none;
    user-select: none;
}
.msg.user{
    margin-right:auto;
    background:var(--user-dark);
    color:#e9ecf1
}
.msg.bot{
    margin-left:auto;
    background:var(--bot-dark);
    border-color:#283047
}
:root.light .msg.user{
    background:var(--user-light);
    color:#fff
}
:root.light .msg.bot{
    background:#fff;
    border-color:#dbe1ea;
    color:#0b1220
}
.empty-hero{
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    height:100%;
    gap:8px;
    color:#cfd6e6;
    text-align:center
}
.empty-hero .name{
    font-size:24px;
    font-weight:900;
    color:#dbe5ff
}
.empty-hero .sub{
    font-size:16px;
    color:#a7b1c6
}
.logoMark{
    width:84px;
    height:84px
}

/* Subscription Banner */
.subscription-banner{
    background:linear-gradient(135deg,#4a6bff,#6d83ff);
    color:white;
    padding:16px;
    border-radius:12px;
    margin:16px;
    text-align:center;
    border:1px solid #5a7bff
}
.subscription-banner h3{
    margin:0 0 8px 0;
    font-size:18px
}
.subscription-banner p{
    margin:0 0 12px 0;
    font-size:14px;
    opacity:0.9
}
.subscription-banner .btn{
    background:white;
    color:#4a6bff;
    border:none;
    font-weight:700
}

/* Math messages */
.msg.math{
    direction:ltr;
    text-align:left;
    max-width:98%
}
.msg.math .mjx-container{
    font-size:10%
}

/* Input row */
.inputRow{
    display:flex;
    gap:8px;
    padding:8px 12px;
    border-top:1px solid var(--stroke);
    background:#0e1016;
    position:sticky;
    bottom:0;
    min-height:60px;
    max-height:60px;
}
:root.light .inputRow{
    background:#ffffff
}
.input{
    flex:1;
    height:44px;
    border-radius:22px;
    border:1px solid transparent;
    background:#0b0e16;
    color:var(--text);
    padding:0 14px;
    outline:none;
    -webkit-user-select:text;
    user-select:text;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,"Tajawal",sans-serif;
}
:root.light .input{
    background:#f8faff;
    color:#0b1220
}
.send,.attach{
    width:44px;
    min-width:44px;
    height:44px;
    border-radius:50%;
    border:1px solid var(--stroke);
    display: flex;
    align-items: center;
    justify-content: center;
}
.send{
    background:var(--brand);
    color:#fff;
    font-weight:900;
}
.attach{
    background:#1d2330;
    color:#fff;
    font-size:22px;
    font-weight:900;
}

/* تحسينات جديدة لرفع الصور */
.attachment-container{
    position:relative;
    margin-bottom:8px
}
.attachment-preview{
    position:relative;
    display:inline-block
}
.attachment-preview img{
    max-width:200px;
    border-radius:12px;
    border:1px solid var(--stroke)
}
.attach-chip {
    display: flex;
    align-items: center;
    gap: 10px;
    background: #161b26;
    border: 1px solid var(--stroke);
    border-radius: 14px;
    padding: 8px 12px;
    max-width: 65%;
}

.attach-chip .thumb{
    width:28px;
    height:28px;
    border-radius:6px;
    overflow:hidden;
    border:1px solid var(--stroke)
}
.attach-chip .thumb img{
    width:100%;
    height:100%;
    object-fit:cover
}
.attach-chip .name{
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width:220px
}
.attach-chip .status {
    display: flex;
    flex-direction: column;
    gap: 2px;
    margin-inline-start: auto;
    text-align: left;
}

.attach-chip .size {
    font-size: 11px;
    color: var(--muted);
}

.attach-chip .x{
    margin-inline-start:auto;
    cursor:pointer;
    border-radius:50%;
    width:24px;
    height:24px;
    display:flex;
    align-items:center;
    justify-content:center;
    border:1px solid var(--stroke)
}
.attach-wrap{
    position:absolute;
    bottom:70px;
    right:14px
}

.attachment-status.analyzing {
    background: #f39c12;
    color: white;
    padding: 2px 6px;
    border-radius: 6px;
    font-size: 11px;
}

.attachment-status.processing {
    background: #3498db;
    color: white;
    padding: 2px 6px;
    border-radius: 6px;
    font-size: 11px;
}

.attachment-status.ready {
    background: #27ae60;
    color: white;
    padding: 2px 6px;
    border-radius: 6px;
    font-size: 11px;
}

/* زر النسخ */
.copy-btn{
    position:absolute;
    top:8px;
    left:8px;
    background:rgba(0,0,0,0.7);
    color:white;
    border:none;
    border-radius:6px;
    padding:4px 8px;
    font-size:12px;
    cursor:pointer;
    opacity:0;
    transition:opacity 0.2s
}
.msg:hover .copy-btn{
    opacity:1
}

/* Pages */
.page{
    position:fixed;
    inset:0;
    background:var(--panel);
    display:none;
    z-index:40;
    padding:14px;
    border:1px solid var(--stroke);
    overflow:auto
}
.page .head{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:10px
}
.block{
    padding:10px;
    border-bottom:1px solid var(--stroke)
}
.block .title{
    font-weight:800;
    margin-bottom:6px
}

/* Subscription Plans */
.subscription-plans{
    display:flex;
    flex-direction:column;
    gap:12px;
    margin-top:16px
}
.plan-card{
    background:var(--card);
    border:2px solid var(--stroke);
    border-radius:16px;
    padding:20px;
    text-align:center;
    transition:all 0.3s
}
.plan-card.featured{
    border-color:var(--brand);
    background:linear-gradient(135deg,var(--card),#1a1f2e)
}
.plan-card .price{
    font-size:28px;
    font-weight:900;
    color:var(--brand);
    margin:8px 0
}
.plan-card .duration{
    color:var(--muted);
    font-size:14px;
    margin-bottom:12px
}
.plan-card .features{
    text-align:right;
    margin:16px 0;
    font-size:14px
}
.plan-card .feature{
    display:flex;
    align-items:center;
    gap:8px;
    margin:8px 0
}
.plan-card .feature::before{
    content:"✓";
    color:var(--ok);
    font-weight:bold
}
.plan-card .buy-btn{
    width:100%;
    background:var(--brand);
    color:#fff;
    border:none;
    border-radius:12px;
    padding:12px;
    font-weight:700;
    cursor:pointer;
    margin-top:8px
}

/* Admin cards */
.cards{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:12px
}
.cardStat{
    background:var(--card);
    border:1px solid var(--stroke);
    border-radius:14px;
    padding:14px
}
.cardStat .name{
    font-weight:800;
    font-size:14px;
    color:var(--muted);
    margin-bottom:8px
}
.cardStat .num{
    font-weight:900;
    font-size:26px
}

/* AUTH (Home with 2 buttons) */
.auth{
    display:none;
    align-items:center;
    justify-content:center;
    position:fixed;
    inset:0
}
.authCard{
    width:92%;
    max-width:420px;
    background:var(--panel);
    border:1px solid var(--stroke);
    border-radius:16px;
    padding:20px;
    text-align:center
}
.authBtns{
    display:flex;
    flex-direction:column;
    gap:12px;
    margin-top:20px
}
.logoRow{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:12px
}
.brandName{
    font-weight:900;
    font-size:24px;
    background:linear-gradient(135deg,#4a6bff,#6d83ff);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    background-clip:text
}
.tosRow{
    display:flex;
    align-items:center;
    gap:8px;
    color:var(--muted);
    font-size:12px;
    margin-top:8px;
    justify-content:center
}

/* Paywall */
.paywall{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.65);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:60
}
.paybox{
    width:92%;
    max-width:420px;
    background:var(--panel);
    border:1px solid var(--stroke);
    border-radius:14px;
    padding:16px;
    text-align:center
}
.paybox .tg{
    display:inline-flex;
    align-items:center;
    gap:8px;
    background:#229ED9;
    border:1px solid #229ED9;
    color:#fff;
    border-radius:10px;
    padding:10px 14px;
    font-weight:800;
    cursor:pointer;
    text-decoration:none
}

a{
    color:#9eb6ff
}

/* Mobile */
@media (max-width:900px){
  #root{
    grid-template-columns:0 1fr
  }
  .sidebar{
    transform:translateX(100%);
    transition:transform .25s
  }
  .sidebar.open{
    transform:translateX(0)
  }
  .subscription-plans{
    flex-direction:column
  }
  .plan-card{
    width:100%
  }
}

/* Theme Toggle */
.theme-toggle{
    display:none
}
</style>
</head>
<body>

<div id="toast" class="toast"></div>

<!-- Boot Animation جديد -->
<div id="boot">
  <svg class="boot-logo" viewBox="0 0 128 128" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="Logo">
    <defs>
      <linearGradient id="g" x1="0" y1="0" x2="128" y2="128">
        <stop stop-color="#6d83ff"/>
        <stop offset="1" stop-color="#3b57ff"/>
      </linearGradient>
    </defs>
    <path d="M16 46L64 26l48 20-48 20-48-20Z" fill="url(#g)"/>
    <path d="M32 58l32 14 32-14v14c0 10-14 18-32 18s-32-8-32-18V58Z" fill="#2a2f43"/>
    <circle cx="104" cy="73" r="6" fill="#4a6bff"/>
    <circle cx="42" cy="94" r="6" fill="#7ea0ff"/><circle cx="86" cy="94" r="6" fill="#7ea0ff"/>
    <path d="M42 94h44" stroke="#9fb3ff" stroke-width="3" stroke-linecap="round"/>
  </svg>
  
  <div class="boot-title">
    <span class="letter">ا</span>
    <span class="letter">ل</span>
    <span class="letter">م</span>
    <span class="letter">س</span>
    <span class="letter">ا</span>
    <span class="letter">ع</span>
    <span class="letter">د</span>
    <span class="letter">&nbsp;</span>
    <span class="letter">ف</span>
    <span class="letter">ي</span>
    <span class="letter">&nbsp;</span>
    <span class="letter">ا</span>
    <span class="letter">ل</span>
    <span class="letter">س</span>
    <span class="letter">ا</span>
    <span class="letter">د</span>
    <span class="letter">س</span>
  </div>
  
  <div class="boot-subtitle">Sixth Assistant</div>
  
  <div class="boot-loading">
    <div class="boot-progress">
      <div class="boot-progress-bar" id="bootProgress"></div>
    </div>
    <div class="boot-text" id="bootText">جاري تحميل الحساب...</div>
  </div>
</div>

<!-- AUTH HOME -->
<section class="auth" id="auth">
  <div class="authCard">
    <div class="logoRow">
      <!-- شعار -->
      <svg class="logoMark" viewBox="0 0 128 128" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="Logo">
        <defs><linearGradient id="g" x1="0" y1="0" x2="128" y2="128"><stop stop-color="#6d83ff"/><stop offset="1" stop-color="#3b57ff"/></linearGradient></defs>
        <path d="M16 46L64 26l48 20-48 20-48-20Z" fill="url(#g)"/>
        <path d="M32 58l32 14 32-14v14c0 10-14 18-32 18s-32-8-32-18V58Z" fill="#2a2f43"/>
        <circle cx="104" cy="73" r="6" fill="#4a6bff"/>
        <circle cx="42" cy="94" r="6" fill="#7ea0ff"/><circle cx="86" cy="94" r="6" fill="#7ea0ff"/>
        <path d="M42 94h44" stroke="#9fb3ff" stroke-width="3" stroke-linecap="round"/>
      </svg>
      <div class="brandName">المساعد في السادس</div>
      <div style="color:var(--muted);font-size:14px;margin-top:-8px">Sixth Assistant</div>
    </div>

    <div class="authBtns">
      <button class="btn primary" id="btnGoSignup">📝 إنشاء حساب جديد</button>
      <button class="btn" id="btnGoPw">🔐 تسجيل الدخول</button>
    </div>

    <label class="tosRow"><input type="checkbox" id="tos"> <span>أوافق على <a href="#" id="privacyLink">سياسة الخصوصية</a></span></label>
    <div id="authError" style="color:var(--err);margin-top:6px;font-size:13px"></div>
  </div>
</section>

<!-- Password Login -->
<div class="page" id="pageLoginPw">
  <div class="head">
    <h3 style="margin:0">🔐 تسجيل الدخول</h3>
    <button class="btn flat" data-back>رجوع</button>
  </div>
  <div class="block">
    <input class="input" id="emailLogin" placeholder="البريد الإلكتروني" autocomplete="email" inputmode="email">
    <div style="height:8px"></div>
    <input class="input" id="passLogin" type="password" placeholder="كلمة السر" autocomplete="current-password">
    <div style="height:12px"></div>
    <button class="btn primary" id="loginBtn"><span id="loginTxt">تسجيل الدخول</span><span id="loginSpin" class="hidden">… جاري تسجيل الدخول</span></button>
    <div style="margin-top:8px"><a href="#" id="reset">هل نسيت كلمة السر؟</a></div>
  </div>
</div>

<!-- Signup -->
<div class="page" id="pageSignup">
  <div class="head">
    <h3 style="margin:0">📝 إنشاء حساب جديد</h3>
    <button class="btn flat" data-back>رجوع</button>
  </div>
  <div class="block">
    <input class="input" id="emailSignup" placeholder="البريد الإلكتروني" autocomplete="email" inputmode="email">
    <div style="height:8px"></div>
    <input class="input" id="passSignup" type="password" placeholder="كلمة السر" autocomplete="new-password">
    <div style="height:8px"></div>
    <input class="input" id="passSignup2" type="password" placeholder="تأكيد كلمة المرور" autocomplete="new-password">
    <div style="height:12px"></div>
    <button class="btn primary" id="signupBtn"><span id="signupTxt">إنشاء حساب</span><span id="signupSpin" class="hidden">… جاري إنشاء الحساب</span></button>
    <div id="signupMsg" style="margin-top:8px;color:var(--ok)"></div>
  </div>
</div>

<!-- Privacy Policy Page -->
<div class="page" id="pagePrivacy">
  <div class="head">
    <h3 style="margin:0">سياسة الخصوصية</h3>
    <button class="btn flat" data-back>رجوع</button>
  </div>
  <div class="block">
    <div class="title">مقدمة</div>
    <p>نحن في "المساعد في السادس" نحرص على حماية خصوصيتك وبياناتك الشخصية. هذه السياسة توضح كيفية جمع واستخدام وحماية معلوماتك.</p>
    
    <div class="title">البيانات التي نجمعها</div>
    <p>• معلومات الحساب: البريد الإلكتروني فقط لأغراض المصادقة<br>
    • بيانات المحادثات: المحادثات والملفات المرفوعة لأغراض التعليم فقط<br>
    • بيانات الاستخدام: عدد المحادثات والرسائل لإدارة النظام</p>
    
    <div class="title">كيف نستخدم بياناتك</div>
    <p>• تقديم خدمات المساعدة الدراسية<br>
    • تحسين جودة الخدمة<br>
    • التواصل معك عند الحاجة<br>
    • الالتزام بالمتطلبات القانونية</p>
    
    <div class="title">حماية البيانات</div>
    <p>• نستخدم تشفير البيانات أثناء النقل والتخزين<br>
    • نلتزم بمعايير الأمان العالمية<br>
    • لا نشارك بياناتك مع أطراف ثالثة</p>
    
    <div class="title">حقوقك</div>
    <p>• الحق في الوصول لبياناتك<br>
    • الحق في تصحيح البيانات<br>
    • الحق في حذف حسابك وبياناتك<br>
    • الحق في سحب الموافقة</p>
    
    <p>لأي استفسارات حول الخصوصية، راسلنا على:
  <a href="mailto:mslmalmyaly2006@gmail.com">mslmalmyaly2006@gmail.com</a>
</p>
  </div>
</div>

<!-- Delete Account Page -->
<div class="page" id="pageDeleteAccount">
  <div class="head">
    <h3 style="margin:0">حذف الحساب والبيانات</h3>
    <button class="btn flat" data-back>رجوع</button>
  </div>
  <div class="block">
    <div class="title">⚠️ تحذير مهم</div>
    <p>هذا الإجراء لا يمكن التراجع عنه. سيؤدي إلى:</p>
    <ul style="color:var(--err);margin:10px 0;padding-right:20px">
      <li>حذف جميع محادثاتك بشكل دائم</li>
      <li>حذف جميع الملفات المرفوعة</li>
      <li>حذف معلومات حسابك</li>
      <li>فقدان جميع البيانات المرتبطة بحسابك</li>
    </ul>
    
    <div style="margin:20px 0">
      <label style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
        <input type="checkbox" id="confirmDelete1">
        <span>أتفهم أن هذا الإجراء لا يمكن التراجع عنه</span>
      </label>
      <label style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
        <input type="checkbox" id="confirmDelete2">
        <span>أوافق على حذف جميع بياناتي بشكل دائم</span>
      </label>
      <label style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="confirmDelete3">
        <span>أدرك أنني سأفقد الوصول إلى جميع محادثاتي</span>
      </label>
    </div>
    
    <button class="btn" id="deleteAccountBtn" style="background:var(--err);color:white;border:none" disabled>حذف الحساب والبيانات بشكل دائم</button>
    <div id="deleteMsg" style="margin-top:8px"></div>
  </div>
</div>

<!-- App -->
<section id="root">
  <div id="sideOverlay"></div>

  <aside class="sidebar" id="sidebar">
    <div class="side-head">
      <button class="toggle" id="closeSide" title="إغلاق">✕</button>
      <div id="subBadge" class="sub-badge">—</div>
    </div>
    <div class="list" id="chatList"></div>
    <div class="side-foot">
      <div class="small" id="userEmail">—</div>
      
      <button class="btn" id="subscriptionBtn" title="الاشتراك المدفوع">💎 الاشتراك المدفوع</button>
      <button class="btn" id="themeToggleSidebar" title="تبديل السمة">ليلي</button>
      
      <!-- زر الإعدادات الجديد -->
      <button class="btn" id="settingsBtn" title="الإعدادات">⚙️ الإعدادات</button>
      
      <button class="btn" id="adminBtn" title="لوحة التحكم" style="display:none">👑 لوحة التحكم</button>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="left">
        <button class="toggle" id="openSide" title="القائمة">☰</button>
      </div>
      
      <!-- محدد مستوى الذكاء في الشريط العلوي (في الوسط) -->
      <div class="intelligence-selector" id="intelligenceSelector">
        <div class="intelligence-trigger" id="intelligenceTrigger">
          <span id="intelligenceDisplay">ذكاء 50%</span>
          <span>▼</span>
        </div>
        <div class="intelligence-dropdown" id="intelligenceDropdown">
          <div class="intelligence-option" data-level="50">ذكاء 50%</div>
          <div class="intelligence-option" data-level="100">ذكاء 100%</div>
        </div>
      </div>
      
      <div class="right"><button class="btn primary" id="startChatTop">+ محادثة جديدة</button></div>
    </div>

    <div class="msgs" id="msgs"></div>

    <div class="inputRow" id="inputRow">
      <input class="input" id="input" placeholder="اكتب سؤالك هنا…" autocomplete="off" inputmode="text">
      <button class="attach" id="attach" title="إضافة">+</button>
      <button class="send" id="send">➤</button>
      <input id="imgFile" type="file" class="hidden" accept="image/*">
      <div id="attachWrap" class="attach-wrap hidden"></div>
    </div>
  </main>
</section>

<!-- صفحة الإعدادات الجديدة -->
<div class="page" id="pageSettings">
  <div class="head">
    <h3 style="margin:0">⚙️ الإعدادات</h3>
    <button class="btn flat" data-back>رجوع</button>
  </div>
  
  <div class="block">
    <div class="title">إعدادات الحساب</div>
    <div class="small" style="margin-bottom:12px" id="settingsUserEmail">—</div>
    
    <button class="btn" id="privacyBtn" style="width:100%;margin-bottom:8px">📄 سياسة الخصوصية</button>
    <button class="btn" id="deleteAccountBtnSettings" style="width:100%;margin-bottom:8px;color:var(--err)">🗑️ حذف حسابي</button>
    <button class="btn" id="logoutBtn" style="width:100%;color:var(--err)">🚪 تسجيل الخروج</button>
  </div>
</div>

<!-- Subscription Plans Page -->
<div class="page" id="pageSubscription">
  <div class="head">
    <h3 style="margin:0">💎 الاشتراك المدفوع</h3>
    <button class="btn flat" data-back>رجوع</button>
  </div>
  
  <div class="block">
    <div class="title">مقارنة الخطط</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
      <div style="text-align:center;padding:12px;background:var(--card);border-radius:12px">
        <h4 style="margin:0 0 8px 0">🆓 مجاني</h4>
        <div style="font-size:12px;color:var(--muted)">للبدء</div>
      </div>
      <div style="text-align:center;padding:12px;background:var(--brand);color:white;border-radius:12px">
        <h4 style="margin:0 0 8px 0">💎 مميز</h4>
        <div style="font-size:12px;opacity:0.9">الأفضل</div>
      </div>
    </div>
    
    <div style="margin-top:16px">
      <div class="feature" style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--stroke)">
        <span>عدد المحادثات</span>
        <div>
          <span style="color:var(--err)">3 فقط</span>
          <span style="margin:0 8px">→</span>
          <span style="color:var(--ok)">غير محدود</span>
        </div>
      </div>
      <div class="feature" style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--stroke)">
        <span>الرسائل لكل محادثة</span>
        <div>
          <span style="color:var(--err)">50 رسالة</span>
          <span style="margin:0 8px">→</span>
          <span style="color:var(--ok)">غير محدود</span>
        </div>
      </div>
      <div class="feature" style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--stroke)">
        <span>مستوى الذكاء</span>
        <div>
          <span style="color:var(--err)">50% فقط</span>
          <span style="margin:0 8px">→</span>
          <span style="color:var(--ok)">100% كامل</span>
        </div>
      </div>
    </div>
  </div>

  <div class="block">
    <div class="title">اختر خطتك المفضلة</div>
    <div class="subscription-plans">
      <div class="plan-card">
        <div class="price">$5</div>
        <div class="duration">10 أيام</div>
        <div class="features">
          <div class="feature">محادثات غير محدودة</div>
          <div class="feature">رسائل غير محدودة</div>
          <div class="feature">ذكاء 100% كامل</div>
          <div class="feature">دعم فوري</div>
        </div>
        <button class="buy-btn" data-plan="5">شراء من متجر التطبيقات</button>
      </div>
      
      <div class="plan-card featured">
        <div class="price">$10</div>
        <div class="duration">20 يوم</div>
        <div class="features">
          <div class="feature">محادثات غير محدودة</div>
          <div class="feature">رسائل غير محدودة</div>
          <div class="feature">ذكاء 100% كامل</div>
          <div class="feature">دعم فوري</div>
          <div class="feature">الأكثر شعبية</div>
        </div>
        <button class="buy-btn" data-plan="10">شراء من متجر التطبيقات</button>
      </div>
      
      <div class="plan-card">
        <div class="price">$15</div>
        <div class="duration">30 يوم</div>
        <div class="features">
          <div class="feature">محادثات غير محدودة</div>
          <div class="feature">رسائل غير محدودة</div>
          <div class="feature">ذكاء 100% كامل</div>
          <div class="feature">دعم فوري</div>
        </div>
        <button class="buy-btn" data-plan="15">شراء من متجر التطبيقات</button>
      </div>
    </div>
  </div>
</div>

<!-- Admin Hub -->
<div class="page" id="pageHub">
  <div class="head"><h3 style="margin:0">لوحة تحكم المالك</h3><button class="btn" data-back>رجوع</button></div>
  <div class="hr" style="height:1px;background:var(--stroke);margin:10px 0"></div>
  <div class="block"><button class="btn" id="tileUsers">👥 إحصاءات المستخدمين</button></div>
  <div class="block"><button class="btn" id="tileSubs">⏰ إدارة الاشتراكات</button></div>
  <div class="block"><button class="btn" id="tileTrain">🧠 تعليم الذكاء</button></div>
</div>

<!-- Users page -->
<div class="page" id="pageUsers">
  <div class="head"><h3 style="margin:0">👥 إحصاءات المستخدمين</h3><button class="btn" data-back>رجوع</button></div>
  <div class="hr" style="height:1px;background:var(--stroke);margin:10px 0"></div>
  <div class="cards">
    <div class="cardStat"><div class="name">عدد المستخدمين</div><div class="num" id="statTotal">—</div></div>
    <div class="cardStat"><div class="name">النشطون الآن</div><div class="num" id="statActiveNow">—</div></div>
    <div class="cardStat"><div class="name">مستخدمو اليوم</div><div class="num" id="statUsersToday">—</div></div>
    <div class="cardStat"><div class="name">رسائل اليوم</div><div class="num" id="statMsgsToday">—</div></div>
  </div>
</div>

<!-- Subs page -->
<div class="page" id="pageSubs">
  <div class="head"><h3 style="margin:0">⏰ إدارة الاشتراكات</h3><button class="btn" data-back>رجوع</button></div>
  <div class="hr" style="height:1px;background:var(--stroke);margin:10px 0"></div>

  <div class="block">
    <div class="title">➕ إضافة اشتراك مدفوع</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <input class="input" id="subEmail" placeholder="بريد المستخدم">
      <select class="input" id="subPlan" style="width:140px">
        <option value="5">10 أيام - $5</option>
        <option value="10">20 يوم - $10</option>
        <option value="15">30 يوم - $15</option>
      </select>
      <button class="btn primary" id="addSubscription">تنفيذ</button>
    </div>
    <div id="subMsg" style="margin-top:8px;color:var(--ok)"></div>
  </div>

  <div class="block">
    <div class="title">🛑 إلغاء الاشتراك فورًا</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <input class="input" id="cancelEmail" placeholder="بريد المستخدم">
      <button class="btn" id="cancelSub">إلغاء الاشتراك</button>
    </div>
    <div id="cancelMsg" style="margin-top:8px;color:var(--ok)"></div>
  </div>
</div>

<!-- Train page -->
<div class="page" id="pageTrain">
  <div class="head"><h3 style="margin:0">🧠 تعليم الذكاء</h3><button class="btn" data-back>رجوع</button></div>
  <div class="hr" style="height:1px;background:var(--stroke);margin:10px 0"></div>
  
  <div class="block">
    <div class="title">⚙️ أوامر النظام (قواعد المنع/السماح)</div>
    <textarea class="input" style="min-height:140px" id="trainRule" placeholder="اكتب أوامر/قواعد للنظام…"></textarea>
    <div style="height:8px"></div>
    <button class="btn primary" id="saveRule">حفظ الأوامر (قواعد)</button>
    <div id="ruleMsg" style="margin-top:8px;color:var(--ok)"></div>
  </div>
  
  <div class="block">
    <div class="title">📝 إضافة معلومات</div>
    <textarea class="input" style="min-height:140px" id="trainInfoText" placeholder="أضف معلومات ومعارف يردّ بها الذكاء…"></textarea>
    <div style="height:8px"></div>
    <button class="btn primary" id="saveInfo">حفظ المعلومات</button>
    <div id="infoMsg" style="margin-top:8px;color:var(--ok)"></div>
  </div>
  
  <div class="block">
    <div class="title">📚 إضافة ملفات PDF</div>
    <input type="file" id="pdfInput" accept=".pdf" multiple class="hidden">
    <div style="display:flex; gap:8px; flex-wrap:wrap">
      <button class="btn" id="pickPdf">اختيار ملفات PDF</button>
      <button class="btn primary" id="processPdfs">معالجة الملفات</button>
    </div>
    <div style="height:8px"></div>
    <div id="fileList"></div>
    <div style="height:10px"></div>
    <div style="height:8px;background:#0b0f18;border:1px solid var(--stroke);border-radius:6px;overflow:hidden">
      <div class="bar" id="pdfBar" style="height:100%;background:var(--brand);width:0%"></div>
    </div>
    <div id="trainInfo" style="margin-top:8px;color:var(--muted);font-size:13px;white-space:pre-wrap"></div>
  </div>
</div>

<!-- Paywall -->
<div class="paywall" id="paywall">
  <div class="paybox">
    <h3 style="margin:0 0 6px 0">انتهت تجربتك المجانية</h3>
    <p>لقد استهلكت الحد المسموح به في الخطة المجانية.</p>
    <div style="margin:12px 0;padding:12px;background:#f8f9fa;border-radius:8px;text-align:right">
      <div>📊 المستخدم: <span id="usedChats">0</span>/3 محادثات</div>
      <div>💬 الرسائل: <span id="usedMessages">0</span>/50 رسالة</div>
    </div>
    <button class="btn primary" onclick="openPage('#pageSubscription')">💎 ترقية الآن</button>
    <div class="hr" style="height:1px;background:var(--stroke);margin:12px 0"></div>
    <button class="btn" id="closePaywall">حسنًا</button>
  </div>
</div>

<script>
/* ===== أدوات عامة ===== */
const $=(s)=>document.querySelector(s);
const saveLocal=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v));}catch{}};
const loadLocal=(k,d=null)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d;}catch{return d;}};
const SAFE_TOKENS=/[^\sA-Za-z0-9\u0600-\u06FF\u2070-\u209F\u2190-\u21FF\u2200-\u22FF\u00B0\u03A0-\u03FF\(\)\[\]\{\}\+\-\*\/=<>^_%.,:;|\\~√∑∆±°μπΩαβγδεζηθικλμνξοπρστυφχψω×÷‰₁₂₃₄₅₆₇₈₉]/g;
const toast=(t)=>{const el=document.getElementById('toast');el.textContent=t;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),1800)}

const ADMIN_EMAIL="mslmalmyaly223@gmail.com";
const firebaseConfig={apiKey:"AIzaSyD915Zh1Gzl60Z9Y5SBlls1S4tedgzU6hE",authDomain:"student-market-5940e.firebaseapp.com",projectId:"student-market-5940e",storageBucket:"student-market-5940e.appspot.com"};
const AI_ENDPOINT = "https://api.deepseek.com/v1/chat/completions";
const AI_KEY = "sk-ff429bca45194b3c87dacda66d63bfb5";

let THEME=loadLocal("THEME","dark");
let USER_INTELLIGENCE_LEVEL=loadLocal("USER_INTELLIGENCE_LEVEL",50);

function applyTheme(){ 
    if(THEME==="light") {
        document.documentElement.classList.add("light");
        $("#themeToggleSidebar").textContent="نهاري";
    } else {
        document.documentElement.classList.remove("light");
        $("#themeToggleSidebar").textContent="ليلي";
    } 
}

/* ===== نظام الذكاء المحسن ===== */
function setupIntelligenceSelector() {
    const trigger = $("#intelligenceTrigger");
    const dropdown = $("#intelligenceDropdown");
    const display = $("#intelligenceDisplay");
    
    function updateDisplay() {
        display.textContent = `ذكاء ${USER_INTELLIGENCE_LEVEL}%`;
    }
    
    function updateOptions() {
        const options = dropdown.querySelectorAll('.intelligence-option');
        options.forEach(option => {
            const level = parseInt(option.dataset.level);
            option.classList.toggle('active', level === USER_INTELLIGENCE_LEVEL);
            
            if (level === 100 && !canUseFullIntelligence()) {
                option.setAttribute('disabled', 'true');
                option.title = "يتطلب اشتراكًا مدفوعًا";
            } else {
                option.removeAttribute('disabled');
                option.title = "";
            }
        });
    }
    
    trigger.onclick = (e) => {
        e.stopPropagation();
        dropdown.classList.toggle('show');
    };
    
    dropdown.querySelectorAll('.intelligence-option').forEach(option => {
        option.onclick = (e) => {
            e.stopPropagation();
            const level = parseInt(option.dataset.level);
            
            if (level === 100 && !canUseFullIntelligence()) {
                toast("يتطلب اشتراكًا مدفوعًا لاستخدام الذكاء الكامل");
                return;
            }
            
            USER_INTELLIGENCE_LEVEL = level;
            saveLocal("USER_INTELLIGENCE_LEVEL", USER_INTELLIGENCE_LEVEL);
            updateDisplay();
            updateOptions();
            dropdown.classList.remove('show');
            toast(`تم تغيير مستوى الذكاء إلى ${level}%`);
        };
    });
    
    document.addEventListener('click', () => {
        dropdown.classList.remove('show');
    });
    
    updateDisplay();
    updateOptions();
}

function canUseFullIntelligence() {
    return userProfileCache?.subscribed === true;
}

// تبديل السمة
$("#themeToggleSidebar").onclick = () => {
    THEME = THEME === "dark" ? "light" : "dark";
    saveLocal("THEME", THEME);
    applyTheme();
    closeSidebar();
};

$("#openSide")?.addEventListener("click",()=>{ $("#sidebar").classList.add("open"); $("#sideOverlay").style.display="block"; });
$("#closeSide")?.addEventListener("click",closeSidebar);
$("#sideOverlay")?.addEventListener("click",closeSidebar);
function closeSidebar(){ $("#sidebar").classList.remove("open"); $("#sideOverlay").style.display="none"; }

/* Firebase */
try {
    firebase.initializeApp(firebaseConfig);
} catch (error) {
    if (!/already exists/.test(error.message)) {
        console.error('خطأ في تهيئة Firebase:', error);
    }
}
const auth=firebase.auth(), db=firebase.firestore();
try{auth.useDeviceLanguage();}catch{}
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});

/* Boot/App/Auth */
const boot=$("#boot"), app=$("#root"), authView=$("#auth");
function showBoot(){ boot.style.display="flex"; app.style.display="none"; authView.style.display="none"; }
function showApp(){ boot.style.display="none"; app.style.display="grid"; authView.style.display="none"; }
function showAuth(){ boot.style.display="none"; app.style.display="none"; authView.style.display="flex"; }
showBoot();

// محاكاة تحميل التطبيق مع شريط التقدم
function simulateBootProgress() {
    let progress = 0;
    const progressBar = $("#bootProgress");
    const bootText = $("#bootText");
    const messages = [
        "جاري تحميل الحساب...",
        "جاري تهيئة البيانات...", 
        "جاري تحميل المحادثات...",
        "جاهز للاستخدام!"
    ];
    
    const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 100) progress = 100;
        
        progressBar.style.width = progress + "%";
        
        if (progress < 30) {
            bootText.textContent = messages[0];
        } else if (progress < 60) {
            bootText.textContent = messages[1];
        } else if (progress < 90) {
            bootText.textContent = messages[2];
        } else {
            bootText.textContent = messages[3];
        }
        
        if (progress >= 100) {
            clearInterval(interval);
        }
    }, 300);
}

// بدء محاكاة التحميل
setTimeout(simulateBootProgress, 1000);

/* حالة عامة */
let me=null,currentChatId=null,canChat=true;
let index=null,knowledgeChunks=[],rulesMemo="";
const msgs=$("#msgs"),input=$("#input"),inputRow=$("#inputRow");
let pageStack=[];
let attachedImage=null;
let attachToken=0;
const attachWrap=$("#attachWrap");
const ENABLE_OCR=true;

// تخزين تاريخ المحادثة الحالية
let currentChatHistory = [];

// إحصائيات الاستخدام
let userUsage = {
    chatCount: 0,
    messageCount: 0,
    maxChats: 3,
    maxMessagesPerChat: 50
};

/* ===== إصلاح التركيز/الكتابة على الجوال ===== */
function scrollIntoViewIfNeeded(el){ 
    try{ 
        el.scrollIntoView({block:"nearest", behavior:"smooth"}); 
    }catch{} 
}

// إصلاح التمرير - السماح بالتمرير للخلف
msgs.addEventListener('scroll', function() {
    // السماح بالتمرير الطبيعي
});

// إصلاح التركيز على الإدخال
["focusin","click","touchend"].forEach(ev=>{
    document.addEventListener(ev,(e)=>{
        const t=e.target;
        if(t && (t.tagName==="INPUT"||t.tagName==="TEXTAREA")) {
            setTimeout(()=>{
                if(document.activeElement === t) {
                    scrollIntoViewIfNeeded(t);
                }
            },100);
        }
    },{passive:true});
});

// إصلاح النقر على الرسائل - لا يسرق التركيز
msgs.addEventListener("click",(e)=>{
    if(e.target.classList.contains('msg')) {
        setTimeout(() => input.focus(), 50);
    }
},{passive:true});

let streamingEl=null, streamedText="";
let isStreaming=false;
let currentStream={id:null,chatId:null,controller:null};
function cancelCurrentStream(){
    if(currentStream.controller){ try{ currentStream.controller.abort(); }catch{} }
    currentStream={id:null,chatId:null,controller:null};
    isStreaming=false; streamingEl=null; streamedText="";
}

/* ضبط ارتفاع الرسائل */
function adjustMsgsPadding(){ const h=inputRow.getBoundingClientRect().height; msgs.style.paddingBottom=(h+16)+"px"; }
new ResizeObserver(adjustMsgsPadding).observe(inputRow);

/* ===== نظام الاشتراك الجديد ===== */
let userProfileCache=null,timerId=null;
function watchUserProfileCountdown(){
    return db.collection("users").doc(me.uid).onSnapshot(async (s)=>{
        userProfileCache=s.data()||{};
        await loadUserUsage();
        renderUsageBadge();
        setupIntelligenceSelector();
        if(timerId) clearInterval(timerId);
        timerId=setInterval(renderUsageBadge,1000);
    });
}

async function loadUserUsage() {
    try {
        const chatsSnap = await db.collection("chats")
            .where("uid", "==", me.uid)
            .get();
        
        userUsage.chatCount = chatsSnap.size;
        
        if (currentChatId) {
            const messagesSnap = await db.collection("chats")
                .doc(currentChatId)
                .collection("messages")
                .get();
            
            userUsage.messageCount = messagesSnap.size;
        } else {
            userUsage.messageCount = 0;
        }
        
    } catch (error) {
        console.error('Error loading user usage:', error);
    }
}

function renderUsageBadge(){
    try{
        const p=userProfileCache||{};
        
        if (p.blocked === true) {
            $("#subBadge").textContent="تم إلغاء اشتراكك";
            canChat=false; 
            return;
        }

        const canCreateMoreChats = userUsage.chatCount < userUsage.maxChats;
        const canSendMoreMessages = userUsage.messageCount < userUsage.maxMessagesPerChat;
        
        canChat = p.subscribed === true || (canCreateMoreChats && canSendMoreMessages);
        
        if (p.subscribed) {
            const subEnd = p.subscriptionEnd?.toDate ? p.subscriptionEnd.toDate() : null;
            if (subEnd) {
                const now = new Date();
                const left = subEnd - now;
                if (left <= 0) {
                    $("#subBadge").textContent = "انتهى الاشتراك";
                    canChat = false;
                    return;
                }
                const days = Math.floor(left / (24 * 60 * 60 * 1000));
                $("#subBadge").textContent = `اشتراك ${days} يوم`;
            } else {
                $("#subBadge").textContent = "مشترك 💎";
            }
        } else {
            const remainingChats = userUsage.maxChats - userUsage.chatCount;
            const remainingMessages = userUsage.maxMessagesPerChat - userUsage.messageCount;
            
            $("#subBadge").textContent = `${remainingChats} محادثة - ${remainingMessages} رسالة`;
        }
        
    } catch{ 
        $("#subBadge").textContent="—"; 
    }
}

function showPaywall() {
    $("#usedChats").textContent = userUsage.chatCount;
    $("#usedMessages").textContent = userUsage.messageCount;
    $("#paywall").style.display = "flex";
}

$("#closePaywall").onclick=()=>$("#paywall").style.display="none";

/* ===== إصلاح مشكلة سياسة الخصوصية ===== */
$("#privacyLink").onclick = (e) => {
    e.preventDefault();
    window.open('https://mslmalmyaly223-sudo.github.io/nalab-blsade/', '_blank');
};

$("#privacyBtn").onclick = () => {
    window.open('https://mslmalmyaly223-sudo.github.io/nalab-blsade/', '_blank');
};

/* ===== زر الإعدادات الجديد ===== */
$("#settingsBtn").onclick = () => {
    openPage("#pageSettings");
    closeSidebar();
};

// تحديث البريد الإلكتروني في صفحة الإعدادات
function updateSettingsEmail() {
    if (me && me.email) {
        $("#settingsUserEmail").textContent = me.email;
    }
}

// إعداد أزرار صفحة الإعدادات
$("#logoutBtn").onclick = () => {
    if (confirm("هل أنت متأكد من تسجيل الخروج؟")) {
        auth.signOut();
    }
};

/* ===== إصلاح مشكلة حذف الحساب ===== */
function setupDeleteAccount() {
    const checkboxes = [
        $("#confirmDelete1"),
        $("#confirmDelete2"), 
        $("#confirmDelete3")
    ];
    
    const deleteBtn = $("#deleteAccountBtn");
    const deleteBtnSettings = $("#deleteAccountBtnSettings");
    
    function updateDeleteButton() {
        const allChecked = checkboxes.every(cb => cb.checked);
        deleteBtn.disabled = !allChecked;
    }
    
    checkboxes.forEach(cb => {
        cb.onchange = updateDeleteButton;
    });
    
    deleteBtn.onclick = async () => {
        if (!deleteBtn.disabled) {
            if (confirm("⚠️ هل أنت متأكد من حذف حسابك وبياناتك بشكل دائم؟ هذا الإجراء لا يمكن التراجع عنه!")) {
                await deleteUserAccount();
            }
        }
    };

    // إصلاح زر حذف الحساب في الإعدادات
    deleteBtnSettings.onclick = () => {
        openPage("#pageDeleteAccount");
    };
}

async function deleteUserAccount() {
    const deleteBtn = $("#deleteAccountBtn");
    const deleteMsg = $("#deleteMsg");
    
    try {
        deleteBtn.disabled = true;
        deleteBtn.textContent = "جاري حذف البيانات...";
        deleteMsg.textContent = "جاري حذف حسابك وبياناتك...";
        deleteMsg.style.color = "var(--muted)";
        
        // حذف جميع محادثات المستخدم
        const chatsSnap = await db.collection("chats").where("uid", "==", me.uid).get();
        const deletePromises = [];
        
        for (const chatDoc of chatsSnap.docs) {
            const messagesSnap = await chatDoc.ref.collection("messages").get();
            messagesSnap.forEach(msgDoc => {
                deletePromises.push(msgDoc.ref.delete());
            });
            deletePromises.push(chatDoc.ref.delete());
        }
        
        // حذف بيانات المستخدم
        deletePromises.push(db.collection("users").doc(me.uid).delete());
        
        await Promise.all(deletePromises);
        
        // حذف الحساب من Firebase Auth
        await me.delete();
        
        deleteMsg.textContent = "✅ تم حذف حسابك وبياناتك بنجاح";
        deleteMsg.style.color = "var(--ok)";
        
        toast("تم حذف حسابك وبياناتك بنجاح");
        setTimeout(() => {
            auth.signOut();
        }, 2000);
        
    } catch (error) {
        console.error('Error deleting account:', error);
        deleteMsg.textContent = "❌ حدث خطأ أثناء حذف الحساب: " + error.message;
        deleteMsg.style.color = "var(--err)";
        deleteBtn.disabled = false;
        deleteBtn.textContent = "حذف الحساب والبيانات بشكل دائم";
    }
}

/* ===== إصلاح مشكلة رفع الصور وتحسين OCR ===== */
$("#imgFile").addEventListener("change", async (e) => {
    const f = e.target.files?.[0]; 
    if (!f) return;
    
    const myTok = ++attachToken;
    
    // التحقق من حجم الصورة
    const maxSize = 5 * 1024 * 1024; // 5MB
    if (f.size > maxSize) {
        toast("حجم الصورة كبير جداً (الحد الأقصى 5MB)");
        return;
    }

    // تحديث حالة الصورة مباشرة بنفس تصميم DeepSeek
    attachedImage = {
        name: (f.name || "image").replace(/\.\w+$/, "") + ".jpg", 
        sizeKB: Math.round(f.size / 1024),
        dataURL: "",
        status: "جار التحميل...",
        uploadProgress: 0
    };
    
    showAttachChip();
    
    const r = new FileReader();
    r.onload = () => { 
        if (myTok !== attachToken) return; 
        
        const dataURL = r.result;
        attachedImage.dataURL = dataURL;
        
        // محاكاة تقدم التحميل مثل DeepSeek
        simulateUploadProgress(myTok);
        
        input.focus(); 
    };
    r.readAsDataURL(f);
    e.target.value = "";
});

// محاكاة تقدم التحميل بنفس تصميم DeepSeek
function simulateUploadProgress(token) {
    let progress = 0;
    const progressInterval = setInterval(() => {
        if (token !== attachToken) {
            clearInterval(progressInterval);
            return;
        }
        
        progress += 10;
        if (progress >= 100) {
            progress = 100;
            clearInterval(progressInterval);
            
            // بعد اكتمال التحميل، تبدأ عملية التحليل
            if (token === attachToken && attachedImage) {
                attachedImage.status = "جار التحليل...";
                showAttachChip();
                
                // بدء عملية OCR بعد تحميل الصورة
                setTimeout(() => {
                    processImageOCR(token);
                }, 500);
            }
        } else {
            if (attachedImage) {
                attachedImage.status = `جار التحميل... ${progress}%`;
                showAttachChip();
            }
        }
    }, 100);
}

// تحسين دالة عرض الصورة المرفوعة
function showAttachChip() {
    if (!attachedImage) { 
        attachWrap.classList.add("hidden"); 
        attachWrap.innerHTML = ""; 
        return; 
    }
    
    const { name, sizeKB, dataURL, status } = attachedImage;
    
    const statusClass = status.includes("جار التحميل") ? "processing" : 
                       status.includes("جار التحليل") ? "analyzing" : 
                       "ready";
    
    attachWrap.innerHTML = `
        <div class="attach-chip">
            <div class="thumb">
                <img src="${dataURL}" alt="${name}">
            </div>
            <div class="name">${name}</div>
            <div class="status">
                <span class="attachment-status ${statusClass}">${status}</span>
                ${status.includes("جار التحميل") ? "" : `<span class="size">${sizeKB} KB</span>`}
            </div>
            <div class="x" id="removeAttach">✕</div>
        </div>`;
    
    attachWrap.classList.remove("hidden");
    
    $("#removeAttach").onclick = () => { 
        attachedImage = null; 
        ++attachToken; 
        showAttachChip(); 
        input.focus(); 
    };
}

// دالة مساعدة لتحويل DataURL إلى Blob
function dataURLtoBlob(dataURL) {
    const byteString = atob(dataURL.split(',')[1]);
    const mimeString = dataURL.split(',')[0].split(':')[1].split(';')[0];
    const ab = new ArrayBuffer(byteString.length);
    const ia = new Uint8Array(ab);
    for (let i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
    }
    return new Blob([ab], { type: mimeString });
}

// تحسين عملية OCR - إضافة معالجة أفضل للنص
async function processImageOCR(token) {
    if (!ENABLE_OCR) {
        if (token === attachToken && attachedImage) {
            attachedImage.status = "جاهز";
            attachedImage.ocrText = "";
            showAttachChip();
        }
        return;
    }
    
    try {
        if (token === attachToken && attachedImage) {
            attachedImage.status = "جار القراءة...";
            showAttachChip();
            
            // تحسين إعدادات OCR للغة العربية
            const { data: { text } } = await Tesseract.recognize(
                dataURLtoBlob(attachedImage.dataURL), 
                'ara+eng',
                {
                    logger: m => console.log(m),
                    tessedit_pageseg_mode: '6', // نص واحد موحد
                    tessedit_ocr_engine_mode: '1',
                    preserve_interword_spaces: '1'
                }
            );
            
            if (token === attachToken && attachedImage) {
                // تنظيف النص المستخرج
                const cleanedText = cleanOCRText(text || "");
                attachedImage.ocrText = cleanedText;
                attachedImage.status = "جاهز";
                showAttachChip();
                toast("تم قراءة الصورة بنجاح");
                console.log('OCR Result:', cleanedText);
            }
        }
    } catch (ocrError) {
        console.log('OCR Error:', ocrError);
        if (token === attachToken && attachedImage) {
            attachedImage.ocrText = "";
            attachedImage.status = "جاهز";
            showAttachChip();
            toast("تم تحميل الصورة بنجاح");
        }
    }
}

// دالة تنظيف نص OCR
function cleanOCRText(text) {
    return text
        .replace(/\n\s*\n/g, '\n') // إزالة الأسطر الفارغة
        .replace(/\s+/g, ' ') // إزالة المسافات الزائدة
        .replace(/[^\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFFa-zA-Z0-9\s\.,\?\!]/g, '') // إزالة الرموز غير المرغوبة
        .trim();
}

// إصلاح زر إرفاق الصور
$("#attach").onclick = () => {
    $("#imgFile").click();
};

/* ===== إصلاح مشكلة التفاعل أثناء البث ===== */
// السماح بفتح القائمة الجانبية وإنشاء محادثات جديدة أثناء البث
$("#openSide").addEventListener("click", (e) => {
    e.stopPropagation();
    $("#sidebar").classList.add("open"); 
    $("#sideOverlay").style.display="block"; 
});

$("#startChatTop").onclick = async (e) => {
    e.stopPropagation();
    if (!canChat) {
        showPaywall();
        return;
    }
    
    if (userUsage.chatCount >= userUsage.maxChats && !userProfileCache?.subscribed) {
        toast("لقد وصلت إلى الحد الأقصى للمحادثات المجانية");
        showPaywall();
        return;
    }
    
    await newChat();
};

function wantsLongExplain(t){ return /(اشرح|شرح|فسر|وضح|فسرلي|شرحلي|حل بالتفصيل|تفصيل|افهمني)/i.test(t||""); }
function isProblemLike(t){ return /(مساله|معادلة|احسب|حل|جد|مثال|قانون|مول|تركيز|معايره|اتزان|حركه|مجال|كيمياء|فيزياء|رياضيات|علم|سؤال)/i.test(t||""); }

/* ===== نظام الإرسال المحسن مع إصلاح مشكلة الصور ===== */
async function onSend(){
    if(!canChat){ 
        showPaywall();
        return; 
    }
    
    // التحقق من حدود الرسائل
    if (userUsage.messageCount >= userUsage.maxMessagesPerChat && !userProfileCache?.subscribed) {
        toast("لقد وصلت إلى الحد الأقصى للرسائل في هذه المحادثة");
        showPaywall();
        return;
    }
    
    const userTxt = $("#input").value.trim();
    if (!userTxt && !attachedImage) {
        toast("يرجى كتابة رسالة أو إرفاق صورة");
        return;
    }

    // إلغاء أي عملية إرسال سابقة
    cancelCurrentStream();

    // إخفاء النص فوراً من حقل الإدخال
    $("#input").value = "";

    // تعطيل زر الإرسال مؤقتاً
    const sendBtn = $("#send");
    sendBtn.disabled = true;
    sendBtn.innerHTML = "⏳";

    try {
        // عرض رسالة المستخدم فوراً
        renderMsg(null, { 
            role: "user", 
            text: userTxt || "[صورة فقط]", 
            imageDataURL: attachedImage?.dataURL || null 
        });
        
        if (!currentChatId) await newChat();
        
        // حفظ رسالة المستخدم في قاعدة البيانات
        await db.collection("chats").doc(currentChatId).collection("messages")
            .add({ 
                role: "user", 
                text: userTxt || "[صورة فقط]", 
                imageDataURL: attachedImage?.dataURL || null, 
                clientTs: Date.now(), 
                ts: firebase.firestore.FieldValue.serverTimestamp() 
            });
            
        await db.collection("chats").doc(currentChatId).update({ 
            clientUpdated: Date.now(), 
            updatedAt: firebase.firestore.FieldValue.serverTimestamp() 
        });

        // إعداد النص النهائي للإرسال مع تحسين معالجة الصور
        let finalPrompt = "";
        if (attachedImage) {
            const ocr = attachedImage.ocrText && attachedImage.ocrText.trim() ? attachedImage.ocrText.trim() : "";
            
            if (ocr) {
                finalPrompt = [
                    "لدي صورة تحتوي على النص التالي:",
                    "```",
                    ocr,
                    "```",
                    userTxt ? ("سؤالي حول هذه الصورة هو: " + userTxt) : "رجاءً حلل هذه الصورة وأجب عن محتواها",
                    "إذا كانت تحتوي على مسألة رياضية أو علمية، قدم الحل خطوة بخطوة باستخدام الرموز الرياضية المناسبة."
                ].filter(Boolean).join("\n\n");
            } else {
                finalPrompt = userTxt || "رجاءً حلل هذه الصورة وأشرح محتواها";
            }
        } else {
            finalPrompt = userTxt;
        }
        
        // تنظيف المرفقات بعد استخدامها مباشرة
        attachedImage = null; 
        ++attachToken; 
        showAttachChip();

        // تحديد نوع الرد
        const wantsLong = wantsLongExplain(userTxt) || isProblemLike(finalPrompt);
        const problem = isProblemLike(finalPrompt);

        // تحميل المعرفة إذا لزم الأمر
        if (!index) { 
            try { 
                await loadKnowledgeFromDB(); 
            } catch(e) {} 
        }

        // البحث في المعرفة
        const ctxPieces = retrieve(finalPrompt, 8);
        const ctx = ctxPieces.join("\n---\n");

        // إعداد البث
        const reqId = Math.random().toString(36).slice(2);
        const controller = new AbortController();
        currentStream = { id: reqId, chatId: currentChatId, controller };

        // بدء البث
        startStreaming();
        
        try {
            await streamAI(ctx, finalPrompt, { 
                wantsLong, 
                isProblem: problem, 
                signal: controller.signal, 
                reqId 
            });
        } catch (e) {
            if (e.name === "AbortError") return;
            
            endStreaming(reqId);
            renderMsg(null, { role: "bot", text: "تعذّر البث، سأرسل الرد دفعة واحدة…" });
            await callAIOnce(ctx, finalPrompt, { wantsLong, isProblem: problem });
        }
        
    } catch (error) {
        console.error('Error in onSend:', error);
        toast('❌ حدث خطأ في إرسال الرسالة');
    } finally {
        // إعادة تمكين زر الإرسال
        sendBtn.disabled = false;
        sendBtn.innerHTML = "➤";
    }
}

// إضافة استماع فعال لزر الإرسال
$("#send").onclick = onSend;

// السماح بالإرسال بالضغط على Enter
$("#input").addEventListener("keypress", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        onSend();
    }
});

function startStreaming(){
    isStreaming = true;
    streamingEl = document.createElement("div");
    streamingEl.className = "msg bot";
    streamingEl.dataset.role = "bot";
    streamingEl.textContent = "";
    streamedText="";
    msgs.appendChild(streamingEl);
    msgs.scrollTo({top: msgs.scrollHeight + 1000, behavior: "smooth"});
}

function pushChunk(txt, reqId){
    if(currentStream.id!==reqId) return;
    if(!streamingEl) startStreaming();
    streamingEl.textContent += txt;
    streamedText += txt;
    msgs.scrollTo({top: msgs.scrollHeight + 1000});
}

function endStreaming(reqId){
    if(currentStream.id!==reqId) return;
    if(!streamingEl){ isStreaming=false; streamedText=""; return; }
    const cleaned = cleanAI(streamedText||"");
    const html = cleaned.replace(/</g,"&lt;").replace(/>/g,"&gt;");
    const isMath = /\\(frac|sqrt|sum|Delta|pi|times|div|rightarrow|left|right|alpha|beta|gamma|delta)|\$\$|H_2O|CO_2/i.test(cleaned);
    const finalEl = document.createElement("div");
    finalEl.className = `msg bot${isMath?" math":""}`;
    finalEl.dataset.role="bot";
    
    // إضافة زر النسخ
    const copyBtn = document.createElement("button");
    copyBtn.className = "copy-btn";
    copyBtn.textContent = "نسخ الرسالة";
    copyBtn.onclick = (e) => {
        e.stopPropagation();
        copyMessageText(cleaned);
    };
    finalEl.appendChild(copyBtn);
    
    const box = document.createElement("div"); 
    box.style.cssText = "font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Tajawal', sans-serif; line-height: 1.6;";
    box.innerHTML = html; 
    finalEl.appendChild(box);
    streamingEl.replaceWith(finalEl);
    if(isMath && window.MathJax) MathJax.typesetPromise([finalEl]).catch(()=>{});
    streamingEl = null; isStreaming=false;
    streamedText = cleaned;
}

/* تنظيف تكرارات الذكاء */
function cleanAI(s){
    if(!s) return s;
    let x=(s||"").replace(/\r/g,"").replace(/[ \t]+\n/g,"\n").replace(/\n{3,}/g,"\n\n").trim();
    const paras=x.split(/\n{2,}/).map(p=>p.trim()).filter(Boolean);
    const out=[]; const seen=new Set();
    for(const p of paras){ const key=p.replace(/\s+/g," "); if(!seen.has(key)){ out.push(p); seen.add(key);} }
    x=out.join("\n\n");
    if(x.length>120){
        const mid=Math.floor(x.length/2);
        const a=x.slice(0,mid).trim(), b=x.slice(mid).trim();
        if(a===b) x=a;
    }
    return x;
}

/* AI - نظام محسن مع دعم كامل للرموز */
function sysPrompt({wantsLong,isProblem}){
    let prompt = [
        "أنت مساعد دراسي ذكي جدًا متخصص في منهج السادس العلمي.",
        "يجب أن تكون إجاباتك دقيقة ومفصلة ومناسبة لجميع المستويات.",
        "ركز فقط على المواد الدراسية ولا تتحدث عن مواضيع أخرى.",
        "التزم بالمنهج الدراسي ولا تخرج عنه.",
        wantsLong ? "اكتب شرحًا تفصيليًا مع خطوات مرقمة وعناوين فرعية." : "أجب بوضوح وإيجاز مع الحفاظ على الدقة العلمية.",
        "استخدم الرموز الرياضية والكيميائية والفيزيائية بشكل صحيح باستخدام LaTeX: $$ .. $$ أو \\( .. \\)",
        "**الرموز الرياضية**: \\(\\alpha, \\beta, \\gamma, \\delta, \\Delta, \\pi, \\theta, \\lambda, \\mu, \\sigma, \\sum, \\prod, \\int, \\sqrt{}, \\frac{}{}, \\binom{}{}, \\times, \\div, \\pm, \\mp, \\leq, \\geq, \\neq, \\approx, \\equiv, \\propto, \\rightarrow, \\leftrightarrow, \\in, \\subset, \\cup, \\cap, \\forall, \\exists, \\therefore, \\because, \\angle, \\parallel, \\perp, \\circ, \\degree\\)",
        "**الرموز الكيميائية**: \\(H_2O, CO_2, CH_4, NaCl, H_2SO_4, NaOH, HCl, CaCO_3, Fe_2O_3, Al_2O_3, Mg(OH)_2\\)",
        "**الرموز الفيزيائية**: \\(F = ma, E = mc^2, v = \\frac{d}{t}, a = \\frac{\\Delta v}{\\Delta t}, P = \\frac{F}{A}, W = F \\cdot d, P = \\frac{W}{t}\\)",
        isProblem ? "للمسائل: استخدم خطوات مرقمة 1,2,3… مع تبرير علمي موجز لكل خطوة." : "",
        "قدم أمثلة توضيحية عند الحاجة.",
        "استخدم الإيموجي المناسب بلطف 🧠✨📚🔍",
        "تذكر السياق والمحادثة السابقة للإجابة بشكل مترابط.",
        "استخدم الخطوات المنطقية والتبريرات العلمية.",
        "**ترتيب الإجابة**: مقدمة ← خطوات الحل ← نتيجة ← ملخص."
    ].filter(Boolean).join("\n");

    if (rulesMemo) {
        prompt += "\n\n### الأوامر والتعليمات:\n" + rulesMemo;
    }

    if (knowledgeChunks.length > 0) {
        const recentKnowledge = knowledgeChunks.slice(0, 5).join("\n\n");
        prompt += "\n\n### المعرفة المرجعية:\n" + recentKnowledge;
    }

    return prompt;
}

async function streamAI(context, user, {wantsLong,isProblem,signal,reqId}){
    try {
        const messages = [
            {
                role: "system", 
                content: sysPrompt({wantsLong, isProblem})
            },
            { role: "user", content: user }
        ];

        const body = {
            model: "deepseek-chat",
            messages: messages,
            stream: true,
            max_tokens: USER_INTELLIGENCE_LEVEL === 100 ? 4000 : 2000
        };

        const res = await fetch(AI_ENDPOINT, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${AI_KEY}`
            },
            body: JSON.stringify(body),
            signal
        });

        if (!res.ok) {
            throw new Error(`HTTP ${res.status}`);
        }

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        
        while (true) {
            const {done, value} = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');

            for (const line of lines) {
                if (line.startsWith('data: ') && !line.includes('[DONE]')) {
                    try {
                        const data = JSON.parse(line.slice(6));
                        const content = data.choices[0]?.delta?.content;
                        if (content) {
                            pushChunk(content, reqId);
                        }
                    } catch (e) {
                        // تجاهل أخطاء الـ JSON
                    }
                }
            }
        }

        const finalText = cleanAI(streamedText);
        endStreaming(reqId);
        await appendMessageStore("bot", finalText, null, currentStream.chatId);

    } catch (error) {
        if (error.name !== "AbortError") {
            throw error;
        }
    }
}

// إضافة الدالة المفقودة callAIOnce
async function callAIOnce(context, user, {wantsLong, isProblem}) {
    try {
        const messages = [
            {
                role: "system", 
                content: sysPrompt({wantsLong, isProblem})
            },
            { role: "user", content: user }
        ];

        const body = {
            model: "deepseek-chat",
            messages: messages,
            max_tokens: USER_INTELLIGENCE_LEVEL === 100 ? 4000 : 2000
        };

        const res = await fetch(AI_ENDPOINT, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${AI_KEY}`
            },
            body: JSON.stringify(body)
        });

        if (!res.ok) {
            throw new Error(`HTTP ${res.status}`);
        }

        const data = await res.json();
        const responseText = data.choices[0]?.message?.content || "لا توجد إجابة";
        
        const cleaned = cleanAI(responseText);
        renderMsg(null, {role: "bot", text: cleaned});
        await appendMessageStore("bot", cleaned, null, currentChatId);
        
        return cleaned;
    } catch (error) {
        console.error('AI Error:', error);
        const errorMsg = "عذرًا، حدث خطأ في الاتصال بالذكاء الاصطناعي. يرجى المحاولة مرة أخرى.";
        renderMsg(null, {role: "bot", text: errorMsg});
        await appendMessageStore("bot", errorMsg, null, currentChatId);
        throw error;
    }
}

/* ===== احصاءات ===== */
async function refreshUserStats(){
    if(me?.email!==ADMIN_EMAIL){
        $("#statTotal").textContent="—";
        $("#statActiveNow").textContent="—";
        $("#statUsersToday").textContent="—";
        $("#statMsgsToday").textContent="—";
        return alert("ليس لديك صلاحية.");
    }
    const now=new Date(); const startOfDay=new Date(now.getFullYear(),now.getMonth(),now.getDate());
    const usersSnap=await db.collection("users").get();
    const totalUsers=usersSnap.size;
    const fiveMinAgo=new Date(now.getTime()-5*60*1000);
    let activeNow=0, usersToday=0;
    usersSnap.forEach(d=>{
        const u=d.data(); const la=u.lastActive?.toDate?u.lastActive.toDate():null;
        if(la){ if(la>=fiveMinAgo) activeNow++; if(la>=startOfDay) usersToday++; }
    });
    let msgsToday=0;
    const chatsSnap=await db.collection("chats").where("updatedAt",">=", firebase.firestore.Timestamp.fromDate(startOfDay)).get().catch(()=>({docs:[]}));
    for(const ch of (chatsSnap.docs||[])){
        const mSnap=await db.collection("chats").doc(ch.id).collection("messages").where("ts",">=", firebase.firestore.Timestamp.fromDate(startOfDay)).get().catch(()=>({size:0}));
        msgsToday+=(mSnap.size||0);
    }
    $("#statTotal").textContent=totalUsers;
    $("#statActiveNow").textContent=activeNow;
    $("#statUsersToday").textContent=usersToday;
    $("#statMsgsToday").textContent=msgsToday;
}

/* ===== صفحات ===== */
function openPage(id){ const el=$(id); if(!el) return; el.style.display="block"; pageStack.push(id); }
function goBack(){
    if(pageStack.length<=1){ pageStack=[]; document.querySelectorAll(".page").forEach(p=>p.style.display="none"); return; }
    const cur=pageStack.pop(); if(cur) $(cur).style.display="none"; const prev=pageStack[pageStack.length-1]; if(prev) $(prev).style.display="block";
}
document.querySelectorAll("[data-back]").forEach(b=>b.addEventListener("click",goBack));

// أزرار الاشتراك
$("#subscriptionBtn").onclick = () => openPage("#pageSubscription");

$("#adminBtn").onclick=()=>{ if(me?.email!==ADMIN_EMAIL){ alert("ليس لديك صلاحية."); return; } openPage("#pageHub"); };
$("#tileUsers").onclick=()=>{ $("#pageHub").style.display="none"; openPage("#pageUsers"); refreshUserStats(); };
$("#tileSubs").onclick =()=>{ $("#pageHub").style.display="none"; openPage("#pageSubs"); };
$("#tileTrain").onclick=()=>{ $("#pageHub").style.display="none"; openPage("#pageTrain"); };

/* ===== اشتراكات: إضافة + إلغاء ===== */
$("#addSubscription").onclick=async ()=>{
    if(me?.email!==ADMIN_EMAIL) return alert("ليس لديك صلاحية.");
    const email=($("#subEmail").value||"").trim();
    const plan=parseInt($("#subPlan").value||"5",10);
    if(!email) return alert("أدخل البريد.");
    
    const planDays = {
        5: 10,
        10: 20,
        15: 30
    };
    
    const days = planDays[plan] || 10;
    
    const q=await db.collection("users").where("email","==",email).limit(1).get();
    if(q.empty) return $("#subMsg").textContent="المستخدم غير موجود.";
    const ref=q.docs[0].ref;
    
    const now=new Date();
    const newEnd=new Date(now.getTime() + (days * 24 * 60 * 60 * 1000));
    
    await ref.update({
        subscribed: true,
        subscriptionEnd: firebase.firestore.Timestamp.fromDate(newEnd),
        blocked: false
    });
    
    $("#subMsg").textContent=`تم تفعيل الاشتراك لمدة ${days} يوم. النهاية: ${newEnd.toLocaleDateString('ar-SA')}`;
    $("#subEmail").value = "";
};

$("#cancelSub").onclick=async ()=>{
    if(me?.email!==ADMIN_EMAIL) return alert("ليس لديك صلاحية.");
    const email=($("#cancelEmail").value||"").trim();
    if(!email) return alert("اكتب بريد المستخدم.");
    const q=await db.collection("users").where("email","==",email).limit(1).get();
    if(q.empty) return $("#cancelMsg").textContent="المستخدم غير موجود.";
    const ref=q.docs[0].ref;
    await ref.update({
        subscribed: false,
        subscriptionEnd: null,
        blocked: true,
        canceledAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    $("#cancelMsg").textContent="تم إلغاء الاشتراك فورًا. سيظهر للمستخدم Paywall حتى يعيد الاشتراك.";
    $("#cancelEmail").value = "";
};

// إدارة الموارد
function cleanup() {
    if (unsubProfile) {
        unsubProfile();
        unsubProfile = null;
    }
    if (unSubMsgs) {
        unSubMsgs();
        unSubMsgs = null;
    }
    if (timerId) {
        clearInterval(timerId);
        timerId = null;
    }
    cancelCurrentStream();
}

window.addEventListener('beforeunload', cleanup);
window.addEventListener("load",()=>{ applyTheme(); adjustMsgsPadding(); });

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/mslm2/sw.js')
    .then(function(registration) {
      console.log('SW registered');
    });
}

/* ===== تهيئة التطبيق بعد التحميل ===== */
document.addEventListener('DOMContentLoaded', function() {
    // إعداد حذف الحساب
    setupDeleteAccount();
    
    // إعداد سياسة الخصوصية
    $("#privacyLink").onclick = (e) => {
        e.preventDefault();
        window.open('https://mslmalmyaly223-sudo.github.io/nalab-blsade/', '_blank');
    };

    $("#privacyBtn").onclick = () => {
        window.open('https://mslmalmyaly223-sudo.github.io/nalab-blsade/', '_blank');
    };
});

/* حفظ رسالة */
async function appendMessageStore(role,text,imageDataURL=null, forceChatId=null){
    const chatId = forceChatId || currentChatId;
    if(!chatId) return;
    const ref=db.collection("chats").doc(chatId).collection("messages");
    await ref.add({ role, text, imageDataURL, clientTs: Date.now(), ts: firebase.firestore.FieldValue.serverTimestamp() });
    await db.collection("chats").doc(chatId).update({ clientUpdated: Date.now(), updatedAt:firebase.firestore.FieldValue.serverTimestamp() });
    try{ await db.collection("users").doc(me.uid).update({ lastActive: firebase.firestore.FieldValue.serverTimestamp() }); }catch{}
}

/* ===== نظام المعرفة المحسن ===== */
function arNormalize(s){ return (s||"").replace(/[\u0610-\u061A\u064B-\u065F\u06D6-\u06ED]/g,'').replace(/[أإآ]/g,'ا').replace(/ى/g,'ي').replace(/ؤ/g,'و').replace(/ئ/g,'ي').replace(/ة/g,'ه').replace(/[ـ]+/g,'').toLowerCase(); }
function chunkAll(texts){ 
    const arr=[]; 
    texts.forEach(t=>{ 
        const clean=(t||"").replace(/(\.|\!|\؟|\?|؛)/g,'$1\n'); 
        const parts=clean.split(/\n+/).map(x=>x.trim()).filter(Boolean); 
        let buf=""; 
        for(const line of parts){ 
            if((buf+" "+line).length<=700) buf=(buf?buf+" ":"")+line; 
            else { if(buf) arr.push(buf); buf=line; } 
        } 
        if(buf) arr.push(buf); 
    }); 
    return arr.slice(-2000);
}

function buildIndex(chunks){
    const tokenize=s=>arNormalize(s).replace(SAFE_TOKENS," ").split(/\s+/).filter(w=>w.length>1);
    const docs=chunks.map(c=>({text:c,toks:tokenize(c)}));
    const df=new Map(); docs.forEach(d=>{[...new Set(d.toks)].forEach(w=>df.set(w,(df.get(w)||0)+1));});
    const N=docs.length||1;
    docs.forEach(d=>{
        const tf=new Map(); d.toks.forEach(w=>tf.set(w,(tf.get(w)||0)+1));
        d.vec=new Map();
        tf.forEach((f,w)=>{ const idf=Math.log((N+1)/((df.get(w)||1)+1))+1; d.vec.set(w,(f/d.toks.length)*idf);});
        delete d.toks;
    });
    index={docs,df:N?df:new Map(),N,tokenize};
}

function retrieve(q,k=8){
    if(!index||!index.docs.length) return [];
    const qT=index.tokenize(q);
    const tf=new Map(); qT.forEach(w=>tf.set(w,(tf.get(w)||0)+1));
    const qV=new Map(); tf.forEach((f,w)=>{ const idf=Math.log((index.N+1)/((index.df.get(w)||1)+1))+1; qV.set(w,(f/qT.length)*idf);});
    const qn=norm(qV);
    const scored=index.docs.map(d=>({text:d.text,score:dot(qV,d.vec)/(qn*norm(d.vec))})).sort((a,b)=>b.score-a.score).slice(0,k);
    return scored.filter(s=>s.score>0.01).map(s=>s.text);
    function dot(a,b){let s=0;a.forEach((va,wa)=>{s+=va*(b.get(wa)||0)});return s}
    function norm(v){let s=0;v.forEach(x=>s+=x*x);return Math.sqrt(s)||1}
}

async function loadKnowledgeFromDB(){
    try {
        const s=await db.collection("knowledge").orderBy("createdAt","desc").limit(2000).get();
        const infoTexts=[]; 
        rulesMemo="";
        s.docs.forEach(d=>{
            const x=d.data(); 
            const t=(x.type||"").toLowerCase();
            if(t==="pdf" || t==="info" || t==="text"){
                const joined=[x.note?`ملاحظة: ${x.note}`:"",x.text||""].join("\n").trim();
                if(joined) infoTexts.push(joined);
            }else if(t==="rule"){ 
                if(x.text) rulesMemo=(rulesMemo?rulesMemo+"\n":"")+x.text; 
            }
        });
        knowledgeChunks=chunkAll(infoTexts); 
        buildIndex(knowledgeChunks);
        console.log('تم تحميل المعرفة:', knowledgeChunks.length, 'قطعة، الأوامر:', rulesMemo.length, 'حرف');
    } catch(e) {
        console.error('خطأ في تحميل المعرفة:', e);
    }
}

/* حالة محادثة فارغة */
function renderEmptyHero(){
    msgs.innerHTML="";
    const wrap=document.createElement("div");
    wrap.className="empty-hero";
    
    if (!canChat || (userUsage.chatCount >= userUsage.maxChats && !userProfileCache?.subscribed)) {
        const banner = document.createElement("div");
        banner.className = "subscription-banner";
        banner.innerHTML = `
            <h3>انتهت تجربتك المجانية</h3>
            <p>لقد استهلكت الحد المسموح به في الخطة المجانية</p>
            <div style="margin:12px 0;text-align:right">
                <div>📊 المستخدم: ${userUsage.chatCount}/3 محادثات</div>
                <div>💬 الرسائل: ${userUsage.messageCount}/50 رسالة</div>
            </div>
            <button class="btn" onclick="openPage('#pageSubscription')">💎 ترقية الآن</button>
        `;
        wrap.appendChild(banner);
    } else {
        wrap.innerHTML=`
            <svg class="logoMark" viewBox="0 0 128 128" fill="none" xmlns="http://www.w3.org/2000/svg">
                <defs><linearGradient id="gh" x1="0" y1="0" x2="128" y2="128"><stop stop-color="#6d83ff"/><stop offset="1" stop-color="#3b57ff"/></linearGradient></defs>
                <path d="M16 46L64 26l48 20-48 20-48-20Z" fill="url(#gh)"/>
                <path d="M32 58l32 14 32-14v14c0 10-14 18-32 18s-32-8-32-18V58Z" fill="#2a2f43"/>
                <circle cx="104" cy="73" r="6" fill="#4a6bff"/>
                <circle cx="42" cy="94" r="6" fill="#7ea0ff"/><circle cx="86" cy="94" r="6" fill="#7ea0ff"/>
                <path d="M42 94h44" stroke="#9fb3ff" stroke-width="3" stroke-linecap="round"/>
            </svg>
            <div class="name">مرحبًا، أنا المساعد في السادس</div>
            <div class="sub">كيف يمكنني مساعدتك اليوم؟</div>
        `;
    }
    msgs.appendChild(wrap);
}

function watchMessages(chatId){
    return db.collection("chats").doc(chatId).collection("messages").orderBy("clientTs","asc")
        .onSnapshot(snap=>{
            if(isStreaming) return;
            
            currentChatHistory = [];
            let firstUserMessage = null;
            
            snap.forEach(doc=>{
                const msg = doc.data();
                currentChatHistory.push({
                    role: msg.role,
                    content: msg.text || ""
                });
                
                if (msg.role === "user" && !firstUserMessage) {
                    firstUserMessage = msg.text;
                }
            });
            
            userUsage.messageCount = snap.size;
            renderUsageBadge();
            
            if (firstUserMessage && snap.size === 1) {
                updateChatTitle(chatId, firstUserMessage);
            }
            
            if(snap.empty){ 
                renderEmptyHero(); 
                return; 
            }
            msgs.innerHTML="";
            snap.forEach(doc=>{ renderMsg(doc.id, doc.data()); });
            msgs.scrollTo({top:msgs.scrollHeight+1000});
        });
}

async function loadChat(id){
    try {
        cancelCurrentStream();
        currentChatId=id; 
        currentChatHistory = [];
        setActiveChatItem(id);
        msgs.innerHTML="";
        if(unSubMsgs) unSubMsgs();
        unSubMsgs=watchMessages(id);
        
        await loadUserUsage();
    } catch (error) {
        console.error('Error loading chat:', error);
        toast('❌ حدث خطأ في تحميل المحادثة');
    }
}

/* ===== تحديث تلقائي لأسماء المحادثات ===== */
async function updateChatTitle(chatId, firstMessage) {
    if (!firstMessage || firstMessage.length < 3) return;
    
    const title = firstMessage.length > 30 ? firstMessage.substring(0, 30) + '...' : firstMessage;
    
    try {
        await db.collection("chats").doc(chatId).update({
            title: title,
            clientUpdated: Date.now(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        const updatedCache = CHAT_CACHE.map(chat => 
            chat.id === chatId ? {...chat, title} : chat
        );
        cacheSet(updatedCache);
        
        const chatItem = document.querySelector(`.item[data-id="${chatId}"] .item-title`);
        if (chatItem) {
            chatItem.textContent = title;
        }
    } catch (error) {
        console.error('Error updating chat title:', error);
    }
}

/* ===== عرض رسالة محسنة مع زر النسخ ===== */
function renderMsg(id, m){
    const isMath=/\\(frac|sqrt|sum|Delta|pi|times|div|rightarrow|left|right|alpha|beta|gamma|delta|epsilon|zeta|eta|theta|iota|kappa|lambda|mu|nu|xi|omicron|pi|rho|sigma|tau|upsilon|phi|chi|psi|omega|hbar|partial|nabla|infty|cdot|pm|mp|times|div|leq|geq|neq|approx|equiv|propto|perp|parallel|angle|circ|degree|vec|hat|tilde|dot|ddot|prime|int|oint|sum|prod|lim|exp|log|ln|sin|cos|tan|cot|sec|csc|arcsin|arccos|arctan|sinh|cosh|tanh|coth|sech|csch|det|dim|gcd|hom|ker|lg|ln|log|max|min|Pr|sup)|\$\$|H_2O|CO_2|CH_4|NaCl|H_2SO_4|NaOH|HCl/i.test(m.text||"");
    const who=m.role==="user"?"user":"bot";
    const img=m.imageDataURL||null;
    const html=(m.text||"").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    const el=document.createElement("div");
    el.className=`msg ${who}`+(isMath?" math":"");
    if(id) el.dataset.mid=id;
    el.dataset.role=m.role;
    
    if (who === "bot") {
        const copyBtn = document.createElement("button");
        copyBtn.className = "copy-btn";
        copyBtn.textContent = "نسخ الرسالة";
        copyBtn.onclick = (e) => {
            e.stopPropagation();
            copyMessageText(m.text);
        };
        el.appendChild(copyBtn);
    }
    
    if(img){ 
        const container = document.createElement("div");
        container.className = "attachment-container";
        
        const im=new Image(); 
        im.className="attachment"; 
        im.src=img; 
        im.style.maxWidth="200px";
        im.style.borderRadius="8px";
        container.appendChild(im);
        
        el.appendChild(container); 
    }
    const box=document.createElement("div"); 
    box.style.cssText = "font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Tajawal', sans-serif; line-height: 1.6; word-wrap: break-word;";
    box.innerHTML=html; 
    el.appendChild(box);
    msgs.appendChild(el);
    if(isMath && window.MathJax) {
        MathJax.typesetPromise([el]).catch(()=>{});
    }
}

// دالة نسخ نص الرسالة
function copyMessageText(text) {
    navigator.clipboard.writeText(text).then(() => {
        toast("تم نسخ الرسالة بنجاح");
    }).catch(() => {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand("copy");
        document.body.removeChild(textArea);
        toast("تم نسخ الرسالة بنجاح");
    });
}

/* ===== نظام الدفع المباشر مع متجر التطبيقات ===== */
document.querySelectorAll(".buy-btn").forEach(btn => {
    btn.onclick = async () => {
        const plan = btn.dataset.plan;
        const planPrices = {
            "5": { price: "$5", days: 10 },
            "10": { price: "$10", days: 20 }, 
            "15": { price: "$15", days: 30 }
        };
        
        const selectedPlan = planPrices[plan];
        
        try {
            if (window.Android && window.Android.purchaseSubscription) {
                window.Android.purchaseSubscription(plan, selectedPlan.price, selectedPlan.days);
            } else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.purchaseSubscription) {
                window.webkit.messageHandlers.purchaseSubscription.postMessage({
                    plan: plan,
                    price: selectedPlan.price,
                    days: selectedPlan.days
                });
            } else {
                const playStoreUrl = `https://play.google.com/store/apps/details?id=com.your.app&referrer=subscription_plan_${plan}`;
                window.open(playStoreUrl, '_blank');
            }
            
            toast(`جاري فتح متجر التطبيقات للاشتراك ${selectedPlan.price}`);
            
        } catch (error) {
            console.error('خطأ في فتح متجر التطبيقات:', error);
            toast('خطأ في فتح متجر التطبيقات');
        }
    };
});

// إضافة دالة لمعالجة نتيجة الشراء
window.handlePurchaseResult = function(success, planId) {
    if (success) {
        toast('✅ تم تفعيل الاشتراك بنجاح!');
        setTimeout(() => {
            location.reload();
        }, 2000);
    } else {
        toast('❌ فشلت عملية الشراء');
    }
};

/* ===== نظام تسجيل الدخول المحسن (بدون Google) ===== */
function mustAcceptTOS(){ return $("#tos").checked; }
function showErr(t){ $("#authError").textContent=t; setTimeout(()=>$("#authError").textContent="",5000); }

// تحديث أزرار التسجيل
$("#btnGoPw").onclick   =()=>{ if(!mustAcceptTOS()) return showErr("وافق على الشروط أولاً."); openPage("#pageLoginPw"); };
$("#btnGoSignup").onclick=()=>{ if(!mustAcceptTOS()) return showErr("وافق على الشروط أولاً."); openPage("#pageSignup"); };

/* Password Login */
$("#loginBtn").onclick=async ()=>{
    const email=$("#emailLogin").value.trim(), pass=$("#passLogin").value.trim();
    if(!email||!pass) return alert("أدخل البريد وكلمة السر.");
    const btn=$("#loginBtn"), txt=$("#loginTxt"), spin=$("#loginSpin");
    btn.disabled=true; txt.classList.add("hidden"); spin.classList.remove("hidden");
    try{
        await auth.signInWithEmailAndPassword(email, pass);
    }catch(e){
        alert(e.message);
        btn.disabled=false; txt.classList.remove("hidden"); spin.classList.add("hidden");
    }
};

/* Reset password */
$("#reset").onclick=async (e)=>{
    e.preventDefault();
    const email=prompt("أدخل بريدك:");
    if(email){ try{ await auth.sendPasswordResetEmail(email); alert("تم الإرسال."); }catch(err){ alert(err.message);} }
};

/* Signup */
$("#signupBtn").onclick=async ()=>{
    const email=$("#emailSignup").value.trim();
    const p1=$("#passSignup").value.trim();
    const p2=$("#passSignup2").value.trim();
    if(!email||!p1||!p2) return alert("أكمل الحقول المطلوبة.");
    if(p1!==p2) return alert("كلمتا السر غير متطابقتين.");
    const btn=$("#signupBtn"), txt=$("#signupTxt"), spin=$("#signupSpin");
    btn.disabled=true; txt.classList.add("hidden"); spin.classList.remove("hidden");
    try{
        await auth.createUserWithEmailAndPassword(email,p1);
        $("#signupMsg").textContent="تم إنشاء الحساب";
    }catch(e){ alert(e.message); }
    btn.disabled=false; txt.classList.remove("hidden"); spin.classList.add("hidden");
};

/* onAuthStateChanged */
let initStarted=false, unsubProfile=null, unSubMsgs=null;
let CHAT_CACHE = loadLocal("CHAT_CACHE", []);

auth.onAuthStateChanged(async (u)=>{
    if(u){
        me=u;
        $("#userEmail").textContent=u.email||"";
        $("#settingsUserEmail").textContent=u.email||"";
        $("#adminBtn").style.display=(me?.email===ADMIN_EMAIL)?"block":"none";
        
        document.querySelectorAll(".page").forEach(p=>p.style.display="none");
        pageStack = [];
        
        fastAfterAuth();
    }else{
        showAuth();
    }
});

function fastAfterAuth(note){
    try{
        applyTheme(); adjustMsgsPadding(); showApp();
        setupIntelligenceSelector();
        setupDeleteAccount();
        updateSettingsEmail();
        if(note) toast(note);
        if(!initStarted){ 
            initStarted=true; 
            setTimeout(() => initApp(), 100);
        }
    }catch(e){console.error('fastAfterAuth error:', e)}
}

async function initApp(){
    try{
        console.log('بدء تهيئة التطبيق...');
        await ensureUserDoc();
        console.log('تم إنشاء مستند المستخدم');
        
        unsubProfile = watchUserProfileCountdown();
        console.log('تم ربط ملف المستخدم');
        
        bindChatList();
        console.log('تم ربط قائمة المحادثات');
        
        // تحميل المعرفة في الخلفية
        setTimeout(() => loadKnowledgeFromDB().catch(()=>{}), 500);
        
        // إنشاء محادثة جديدة تلقائياً
        await newChat();
        console.log('تم إنشاء محادثة جديدة');
        
    }catch(e){
        console.error('خطأ في initApp:', e);
        toast('حدث خطأ في تهيئة التطبيق');
    }
}

/* إنشاء/تحديث مستند المستخدم */
async function ensureUserDoc(){
    try {
        const ref=db.collection("users").doc(me.uid);
        const userDoc = await ref.get();
        
        if (!userDoc.exists) {
            await ref.set({
                email: me.email||null,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                trialStart: firebase.firestore.FieldValue.serverTimestamp(),
                subscribed: false,
                subscriptionEnd: null,
                blocked: false,
                lastActive: firebase.firestore.FieldValue.serverTimestamp()
            });
        } else {
            await ref.update({
                lastActive: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
    } catch (error) {
        console.error('Error in ensureUserDoc:', error);
        throw error;
    }
}

/* ===== قائمة المحادثات المحسنة ===== */
function cacheSet(list){ CHAT_CACHE=list; saveLocal("CHAT_CACHE", list); }

function insertChatRowDom(id, title){
    const list=$("#chatList");
    if(list.querySelector(`.item[data-id="${id}"]`)) return;
    const row=document.createElement("div");
    row.className="item"+(id===currentChatId?" active":"");
    row.dataset.id=id;

    const t=document.createElement("div"); t.className="item-title"; t.textContent=title||"—";
    const ops=document.createElement("div"); ops.className="item-ops";

    const edit=document.createElement("button"); edit.className="btn"; edit.textContent="✏️";
    edit.onclick=async (e)=>{
        e.stopPropagation();
        const nt=prompt("اسم جديد:", (t.textContent||"").trim() || "محادثة");
        if(nt && nt!==t.textContent){
            t.textContent = nt;
            try{ await db.collection("chats").doc(id).update({title:nt, clientUpdated:Date.now(), updatedAt:firebase.firestore.FieldValue.serverTimestamp()}); }catch{}
            const arr = [{id, title:nt}, ...CHAT_CACHE.filter(x=>x.id!==id)];
            cacheSet(arr);
        }
    };
    const del=document.createElement("button"); del.className="btn"; del.textContent="🗑️";
    del.onclick=async (e)=>{ e.stopPropagation(); if(confirm("حذف المحادثة؟")) await deleteChat(id); };

    ops.appendChild(edit); ops.appendChild(del);
    row.appendChild(t); row.appendChild(ops);
    row.onclick=()=>{ loadChat(id); closeSidebar(); };
    list.prepend(row);
}

function bindChatList(){
    $("#chatList").innerHTML="";
    CHAT_CACHE.forEach(c=>insertChatRowDom(c.id, c.title));

    db.collection("chats").where("uid","==",me.uid).orderBy("clientUpdated","desc")
        .onSnapshot(snap=>{
            const list=$("#chatList"); 
            const arr=[];
            snap.forEach(doc=>{
                const c=doc.data(); const id=doc.id;
                arr.push({id, title:c.title||"محادثة"});
                insertChatRowDom(id, c.title||"محادثة");
            });
            cacheSet(arr);
            setActiveChatItem(currentChatId);
        }, ()=>{
            if($("#chatList").children.length===0){
                CHAT_CACHE.forEach(c=>insertChatRowDom(c.id, c.title));
            }
        });
}

function setActiveChatItem(id){
    document.querySelectorAll("#chatList .item").forEach(x=>x.classList.toggle("active", x.dataset.id===id));
}

async function newChat(){
    try {
        cancelCurrentStream();
        currentChatHistory = [];
        
        const ref=await db.collection("chats").add({
            uid:me.uid, 
            title:"محادثة جديدة",
            clientUpdated: Date.now(),
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        currentChatId=ref.id;
        insertChatRowDom(ref.id, "محادثة جديدة");
        const arr=[{id:ref.id, title:"محادثة جديدة"}, ...CHAT_CACHE.filter(x=>x.id!==ref.id)];
        cacheSet(arr);
        setActiveChatItem(ref.id);
        loadChat(ref.id);
        
        // تحديث إحصائيات المحادثات
        userUsage.chatCount++;
        renderUsageBadge();
        
        return ref.id;
    } catch (error) {
        console.error('Error creating new chat:', error);
        toast('❌ حدث خطأ في إنشاء المحادثة');
        throw error;
    }
}

async function deleteChat(id){
    try{
        if(unSubMsgs && currentChatId===id){ unSubMsgs(); unSubMsgs=null; }
        const row=document.querySelector(`#chatList .item[data-id="${id}"]`); if(row) row.remove();
        cacheSet(CHAT_CACHE.filter(x=>x.id!==id));

        const ref=db.collection("chats").doc(id);
        const msgsSnap=await ref.collection("messages").get();
        const batch=db.batch(); msgsSnap.forEach(d=>batch.delete(ref.collection("messages").doc(d.id))); await batch.commit();
        await ref.delete();

        if(currentChatId===id){
            currentChatId=null; 
            currentChatHistory = [];
            msgs.innerHTML="";
            if(CHAT_CACHE[0]) loadChat(CHAT_CACHE[0].id);
            else await newChat();
        }
        
        // تحديث إحصائيات المحادثات
        userUsage.chatCount = Math.max(0, userUsage.chatCount - 1);
        renderUsageBadge();
        
    }catch(e){ alert(e.message||e); }
}
</script>
</body>
</html>
