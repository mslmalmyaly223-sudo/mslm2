<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ ÙÙŠ Ø§Ù„Ø³Ø§Ø¯Ø³ | Sixth Assistant</title>

<!-- Firebase v9 (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- pdf.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>try{pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';}catch{}</script>

<!-- Tesseract.js -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<!-- MathJax -->
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<style>
:root{--bg:#0c0d10;--panel:#13151a;--card:#0f1116;--stroke:#242833;--text:#e9ecf1;--muted:#9aa4b2;--brand:#4a6bff;--ok:#2ecc71;--err:#e74c3c;--user-dark:#2e333d;--bot-dark:#0f1320;--user-light:#3b57ff;--bot-light:#ffffff}
:root.light{--bg:#f6f7fb;--panel:#ffffff;--card:#ffffff;--stroke:#dbe1ea;--text:#0b1220;--muted:#5b6473;--brand:#3b57ff;--ok:#1f9d5a;--err:#cf3434}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Tajawal",sans-serif;overflow:hidden}
.hidden{display:none}

/* Boot */
#boot{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--bg);z-index:100;color:var(--muted);gap:10px}
#boot .dot{width:8px;height:8px;border-radius:50%;background:var(--muted);animation:b 1s infinite}
#boot .dot:nth-child(2){animation-delay:.15s}
#boot .dot:nth-child(3){animation-delay:.3s}
@keyframes b{0%,80%,100%{opacity:.2;transform:translateY(0)}40%{opacity:1;transform:translateY(-6px)}}

#root{position:fixed;inset:0;display:none;grid-template-columns:280px 1fr;width:100vw;height:100vh}

/* Sidebar */
.sidebar{background:var(--panel);border-inline-end:1px solid var(--stroke);display:flex;flex-direction:column;min-width:260px;z-index:30}
.side-head{padding:10px;border-bottom:1px solid var(--stroke);display:flex;align-items:center;gap:8px}
.toggle{width:42px;height:42px;border-radius:12px;border:1px solid var(--stroke);background:#141821;color:#fff;font-weight:900;display:flex;align-items:center;justify-content:center;cursor:pointer}
:root.light .toggle{background:#eef1f8;color:#0b1220}
.sub-badge{margin-inline-start:auto;font-size:12px;padding:8px 10px;border:1px solid var(--stroke);border-radius:999px;background:#0e1422;white-space:nowrap}
:root.light .sub-badge{background:#eef2fb;color:#0b1220}
.btn{height:48px;border-radius:12px;border:1px solid var(--stroke);background:#141821;color:#fff;display:flex;align-items:center;justify-content:center;gap:8px;font-weight:700;cursor:pointer;padding:0 14px}
:root.light .btn{background:#eef1f8;color:#0b1220}
.btn.primary{background:var(--brand);border-color:transparent;color:#fff}
.btn.flat{background:transparent}
.btn[disabled]{opacity:.6;cursor:not-allowed}
.list{flex:1;overflow:auto;padding:8px 6px}
.item{padding:10px 12px;border-radius:10px;border:1px solid transparent;display:flex;align-items:center;gap:8px}
.item:hover{background:#151a23}:root.light .item:hover{background:#eef2fb}
.item.active{background:#0f1420;border-color:#2b3342}:root.light .item.active{background:#eaf0ff;border-color:#cfd9ff}
.item-title{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.item-ops{display:flex;gap:6px}
.side-foot{padding:10px;border-top:1px solid var(--stroke);display:flex;flex-direction:column;gap:8px}
.small{font-size:12px;color:var(--muted)}
#sideOverlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:20}

/* Main */
.main{display:grid;grid-template-rows:auto 1fr auto;min-width:0;min-height:0;position:relative;z-index:10;background:#0b0d12}
:root.light .main{background:#f6f7fb}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--stroke);background:linear-gradient(180deg,#0d1016,#0c0d10)}
:root.light .topbar{background:linear-gradient(180deg,#ffffff,#f1f3f8)}
.topbar .left{display:flex;gap:8px;align-items:center}

/* Messages */
.msgs{overflow:auto;-webkit-overflow-scrolling:touch;min-height:0;background:#0a0c11;padding:16px;padding-bottom:88px}
:root.light .msgs{background:#f6f7fb}
.msg{max-width:92%;padding:12px 14px;border-radius:16px;margin:8px 0;border:1px solid var(--stroke);line-height:1.6;word-wrap:break-word;white-space:pre-wrap}
.msg.user{margin-right:auto;background:var(--user-dark);color:#e9ecf1}
.msg.bot{margin-left:auto;background:var(--bot-dark);border-color:#283047}
:root.light .msg.user{background:var(--user-light);color:#fff}
:root.light .msg.bot{background:#fff;border-color:#dbe1ea;color:#0b1220}
.empty-hero{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:8px;color:#cfd6e6;text-align:center}
.empty-hero .name{font-size:24px;font-weight:900;color:#dbe5ff}
.empty-hero .sub{font-size:16px;color:#a7b1c6}
.logoMark{width:84px;height:84px}

/* Math messages */
.msg.math{direction:ltr;text-align:left;max-width:98%}
.msg.math .mjx-container{font-size:110%}

/* Input row */
.inputRow{display:flex;gap:8px;padding:10px 12px;border-top:1px solid var(--stroke);background:#0e1016;position:sticky;bottom:0}
:root.light .inputRow{background:#ffffff}
.input{flex:1;height:48px;border-radius:22px;border:1px solid transparent;background:#0b0e16;color:var(--text);padding:0 14px;outline:none;-webkit-user-select:text;user-select:text}
:root.light .input{background:#f8faff;color:#0b1220}
.send,.attach{width:52px;min-width:52px;border-radius:50%;border:1px solid var(--stroke)}
.send{background:var(--brand);color:#fff;font-weight:900}
.attach{background:#1d2330;color:#fff;font-size:22px;font-weight:900;line-height:48px}
.attach-chip{display:flex;align-items:center;gap:10px;background:#161b26;border:1px solid var(--stroke);border-radius:14px;padding:8px 10px;max-width:65%}
.attach-chip .thumb{width:28px;height:28px;border-radius:6px;overflow:hidden;border:1px solid var(--stroke)}
.attach-chip .thumb img{width:100%;height:100%;object-fit:cover}
.attach-chip .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px}
.attach-chip .x{margin-inline-start:auto;cursor:pointer;border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;border:1px solid var(--stroke)}
.attach-wrap{position:absolute;bottom:70px;right:14px}

/* Pages */
.page{position:fixed;inset:0;background:var(--panel);display:none;z-index:40;padding:14px;border:1px solid var(--stroke);overflow:auto}
.page .head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.block{padding:10px;border-bottom:1px solid var(--stroke)}
.block .title{font-weight:800;margin-bottom:6px}

/* Admin cards */
.cards{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.cardStat{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:14px}
.cardStat .name{font-weight:800;font-size:14px;color:var(--muted);margin-bottom:8px}
.cardStat .num{font-weight:900;font-size:26px}

/* AUTH (Home with 3 buttons) */
.auth{display:none;align-items:center;justify-content:center;position:fixed;inset:0}
.authCard{width:92%;max-width:520px;background:var(--panel);border:1px solid var(--stroke);border-radius:16px;padding:16px;text-align:center}
.authBtns{display:flex;flex-direction:column;gap:10px;margin-top:12px}
.logoRow{display:flex;flex-direction:column;align-items:center;gap:8px}
.brandName{font-weight:900;font-size:22px}
.tosRow{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:12px;margin-top:6px;justify-content:center}

/* Paywall */
.paywall{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:60}
.paybox{width:92%;max-width:420px;background:var(--panel);border:1px solid var(--stroke);border-radius:14px;padding:16px;text-align:center}
.paybox .tg{display:inline-flex;align-items:center;gap:8px;background:#229ED9;border:1px solid #229ED9;color:#fff;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer;text-decoration:none}

a{color:#9eb6ff}

/* Mobile */
@media (max-width:900px){
  #root{grid-template-columns:0 1fr}
  .sidebar{transform:translateX(100%);transition:transform .25s}
  .sidebar.open{transform:translateX(0)}
}
</style>
</head>
<body>

<!-- Boot -->
<div id="boot">
  <span>Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„</span>
  <div class="dot"></div><div class="dot"></div><div class="dot"></div>
</div>

<!-- AUTH HOME -->
<section class="auth" id="auth">
  <div class="authCard">
    <div class="logoRow">
      <!-- Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯ -->
      <svg class="logoMark" viewBox="0 0 128 128" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="Logo">
        <defs><linearGradient id="g" x1="0" y1="0" x2="128" y2="128"><stop stop-color="#6d83ff"/><stop offset="1" stop-color="#3b57ff"/></linearGradient></defs>
        <path d="M16 46L64 26l48 20-48 20-48-20Z" fill="url(#g)"/>
        <path d="M32 58l32 14 32-14v14c0 10-14 18-32 18s-32-8-32-18V58Z" fill="#2a2f43"/>
        <circle cx="104" cy="73" r="6" fill="#4a6bff"/>
        <circle cx="42" cy="94" r="6" fill="#7ea0ff"/><circle cx="86" cy="94" r="6" fill="#7ea0ff"/>
        <path d="M42 94h44" stroke="#9fb3ff" stroke-width="3" stroke-linecap="round"/>
      </svg>
      <div class="brandName">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ ÙÙŠ Ø§Ù„Ø³Ø§Ø¯Ø³</div>
    </div>

    <div class="authBtns">
      <button class="btn" id="btnGoGoogle">Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Google ğŸŒ</button>
      <button class="btn" id="btnGoPw">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ğŸ”</button>
      <button class="btn" id="btnGoSignup">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ ğŸ“</button>
    </div>

    <label class="tosRow"><input type="checkbox" id="tos"> <span>Ø£ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø®ØµÙˆØµÙŠØ©</span></label>
    <div id="authError" style="color:var(--err);margin-top:6px;font-size:13px"></div>
  </div>
</section>

<!-- Google page -->
<div class="page" id="pageGoogle">
  <div class="head">
    <h3 style="margin:0">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Google</h3>
    <button class="btn flat" data-back>Ø±Ø¬ÙˆØ¹</button>
  </div>
  <div class="block">
    <div class="title">Ø§Ø®ØªØ± Ø­Ø³Ø§Ø¨Ù‹Ø§ Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ</div>
    <p style="color:var(--muted)">Ø³ÙŠÙÙØªØ­ Ù…ÙÙ†ØªÙ‚ÙŠ Ø­Ø³Ø§Ø¨Ø§Øª Google.</p>
    <button class="btn primary" id="googleBtn">
      <span id="gTxt">ÙØªØ­ Ù…ÙÙ†ØªÙ‚ÙŠ Ø­Ø³Ø§Ø¨Ø§Øª Google</span>
      <span id="gSpin" class="hidden">â€¦ Ø¬Ø§Ø±Ù Ø§Ù„ÙØªØ­</span>
    </button>
    <div id="gErr" style="color:var(--err);margin-top:8px;font-size:13px"></div>
  </div>
</div>

<!-- Password Login -->
<div class="page" id="pageLoginPw">
  <div class="head">
    <h3 style="margin:0">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
    <button class="btn flat" data-back>Ø±Ø¬ÙˆØ¹</button>
  </div>
  <div class="block">
    <input class="input" id="emailLogin" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" autocomplete="email" inputmode="email">
    <div style="height:8px"></div>
    <input class="input" id="passLogin" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" autocomplete="current-password">
    <div style="height:12px"></div>
    <button class="btn primary" id="loginBtn"><span id="loginTxt">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span><span id="loginSpin" class="hidden">â€¦ Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span></button>
    <div style="margin-top:8px"><a href="#" id="reset">Ù‡Ù„ Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ØŸ</a></div>
  </div>
</div>

<!-- Signup -->
<div class="page" id="pageSignup">
  <div class="head">
    <h3 style="margin:0">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h3>
    <button class="btn flat" data-back>Ø±Ø¬ÙˆØ¹</button>
  </div>
  <div class="block">
    <input class="input" id="emailSignup" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" autocomplete="email" inputmode="email">
    <div style="height:8px"></div>
    <input class="input" id="passSignup" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" autocomplete="new-password">
    <div style="height:8px"></div>
    <input class="input" id="passSignup2" type="password" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" autocomplete="new-password">
    <div style="height:12px"></div>
    <button class="btn primary" id="signupBtn"><span id="signupTxt">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</span><span id="signupSpin" class="hidden">â€¦ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨</span></button>
    <div id="signupMsg" style="margin-top:8px;color:var(--ok)"></div>
  </div>
</div>

<!-- App -->
<section id="root">
  <div id="sideOverlay"></div>

  <aside class="sidebar" id="sidebar">
    <div class="side-head">
      <button class="toggle" id="closeSide" title="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
      <div id="subBadge" class="sub-badge">â€”</div>
    </div>
    <div class="list" id="chatList"></div>
    <div class="side-foot">
      <div class="small" id="userEmail">â€”</div>
      <button class="btn" id="adminBtn" title="Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…" style="display:none">ğŸ‘‘ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
      <button class="btn" id="logout">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="left"><button class="toggle" id="openSide" title="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">â˜°</button></div>
      <div class="right"><button class="btn primary" id="startChatTop">+ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©</button></div>
    </div>

    <div class="msgs" id="msgs"></div>

    <div class="inputRow" id="inputRow">
      <input class="input" id="input" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§â€¦" autocomplete="off" inputmode="text">
      <button class="attach" id="attach" title="Ø¥Ø¶Ø§ÙØ©">+</button>
      <button class="send" id="send">â¤</button>
      <input id="imgFile" type="file" class="hidden" accept="image/*">
      <div id="attachWrap" class="attach-wrap hidden"></div>
    </div>
  </main>
</section>

<!-- Admin Hub -->
<div class="page" id="pageHub">
  <div class="head"><h3 style="margin:0">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø§Ù„Ùƒ</h3><button class="btn" data-back>Ø±Ø¬ÙˆØ¹</button></div>
  <div class="hr" style="height:1px;background:var(--stroke);margin:10px 0"></div>
  <div class="block"><button class="btn" id="tileUsers">ğŸ‘¥ Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button></div>
  <div class="block"><button class="btn" id="tileSubs">â° Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</button></div>
  <div class="block"><button class="btn" id="tileTrain">ğŸ§  ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø°ÙƒØ§Ø¡</button></div>
</div>

<!-- Users page -->
<div class="page" id="pageUsers">
  <div class="head"><h3 style="margin:0">ğŸ‘¥ Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3><button class="btn" data-back>Ø±Ø¬ÙˆØ¹</button></div>
  <div class="hr" style="height:1px;background:var(--stroke);margin:10px 0"></div>
  <div class="cards">
    <div class="cardStat"><div class="name">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div><div class="num" id="statTotal">â€”</div></div>
    <div class="cardStat"><div class="name">Ø§Ù„Ù†Ø´Ø·ÙˆÙ† Ø§Ù„Ø¢Ù†</div><div class="num" id="statActiveNow">â€”</div></div>
    <div class="cardStat"><div class="name">Ù…Ø³ØªØ®Ø¯Ù…Ùˆ Ø§Ù„ÙŠÙˆÙ…</div><div class="num" id="statUsersToday">â€”</div></div>
    <div class="cardStat"><div class="name">Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙŠÙˆÙ…</div><div class="num" id="statMsgsToday">â€”</div></div>
  </div>
</div>

<!-- Subs page -->
<div class="page" id="pageSubs">
  <div class="head"><h3 style="margin:0">â° Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</h3><button class="btn" data-back>Ø±Ø¬ÙˆØ¹</button></div>
  <div class="hr" style="height:1px;background:var(--stroke);margin:10px 0"></div>

  <div class="block">
    <div class="title">â• Ø²ÙŠØ§Ø¯Ø© Ù…Ø¯Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <input class="input" id="subEmail" placeholder="Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
      <input class="input" id="subDays" type="number" placeholder="Ø£ÙŠØ§Ù…" style="width:130px">
      <button class="btn primary" id="addDays">ØªÙ†ÙÙŠØ°</button>
    </div>
    <div id="subMsg" style="margin-top:8px;color:var(--ok)"></div>
  </div>

  <div class="block">
    <div class="title">ğŸ›‘ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙˆØ±Ù‹Ø§</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <input class="input" id="cancelEmail" placeholder="Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
      <button class="btn" id="cancelSub">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</button>
    </div>
    <div id="cancelMsg" style="margin-top:8px;color:var(--ok)"></div>
  </div>
</div>

<!-- Train page -->
<div class="page" id="pageTrain">
  <div class="head"><h3 style="margin:0">ğŸ§  ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø°ÙƒØ§Ø¡</h3><button class="btn" data-back>Ø±Ø¬ÙˆØ¹</button></div>
  <div class="block">
    <div class="title">âš™ï¸ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù†Ø¸Ø§Ù… (Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù…Ù†Ø¹/Ø§Ù„Ø³Ù…Ø§Ø­)</div>
    <textarea class="input" style="min-height:140px" id="trainRule" placeholder="Ø§ÙƒØªØ¨ Ø£ÙˆØ§Ù…Ø±/Ù‚ÙˆØ§Ø¹Ø¯ Ù„Ù„Ù†Ø¸Ø§Ù…â€¦"></textarea>
    <div style="height:8px"></div>
    <button class="btn primary" id="saveRule">Ø­ÙØ¸ Ø§Ù„Ø£ÙˆØ§Ù…Ø± (Ù‚ÙˆØ§Ø¹Ø¯)</button>
  </div>
  <div class="block">
    <div class="title">ğŸ“ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</div>
    <textarea class="input" style="min-height:140px" id="trainInfoText" placeholder="Ø£Ø¶Ù Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙˆÙ…Ø¹Ø§Ø±Ù ÙŠØ±Ø¯Ù‘ Ø¨Ù‡Ø§ Ø§Ù„Ø°ÙƒØ§Ø¡â€¦"></textarea>
    <div style="height:8px"></div>
    <button class="btn" id="saveInfo">Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</button>
  </div>
  <div class="block">
    <div class="title">ğŸ“š Ø¥Ø¶Ø§ÙØ© Ù…Ù„ÙØ§Øª PDF</div>
    <input type="file" id="pdfInput" accept=".pdf" multiple class="hidden">
    <div style="display:flex; gap:8px; flex-wrap:wrap">
      <button class="btn" id="pickPdf">Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„ÙØ§Øª PDF</button>
      <button class="btn primary" id="processPdfs">Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„ÙØ§Øª</button>
    </div>
    <div style="height:8px"></div>
    <div id="fileList"></div>
    <div style="height:10px"></div>
    <div style="height:8px;background:#0b0f18;border:1px solid var(--stroke);border-radius:6px;overflow:hidden"><div class="bar" id="pdfBar" style="height:100%;background:var(--brand);width:0%"></div></div>
    <div id="trainInfo" style="margin-top:8px;color:var(--muted);font-size:13px;white-space:pre-wrap"></div>
  </div>
</div>

<!-- Paywall -->
<div class="paywall" id="paywall">
  <div class="paybox">
    <h3 style="margin:0 0 6px 0">Ø§Ù†ØªÙ‡Øª ØªØ¬Ø±Ø¨ØªÙƒ/Ø§Ø´ØªØ±Ø§ÙƒÙƒ</h3>
    <p>Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ.</p>
    <a class="tg" href="https://t.me/MSLM_ALMYALY" target="_blank">ğŸ“¨ Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ</a>
    <div class="hr" style="height:1px;background:var(--stroke);margin:12px 0"></div>
    <button class="btn" id="closePaywall">Ø­Ø³Ù†Ù‹Ø§</button>
  </div>
</div>

<script>
/* ===== Ø£Ø¯ÙˆØ§Øª Ø¹Ø§Ù…Ø© ===== */
const $=(s)=>document.querySelector(s);
const saveLocal=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v));}catch{}};
const loadLocal=(k,d=null)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d;}catch{return d;}};
const SAFE_TOKENS=/[^\sA-Za-z0-9\u0600-\u06FF\u2070-\u209F\u2190-\u21FF\u2200-\u22FF\u00B0\u03A0-\u03FF\(\)\[\]\{\}\+\-\*\/=<>^_%.,:;|\\~âˆšâˆ‘âˆ†Â±Â°Î¼Ï€Î©Î±Î²Î³Î´ÎµÎ¶Î·Î¸Î¹ÎºÎ»Î¼Î½Î¾Î¿Ï€ÏÏƒÏ„Ï…Ï†Ï‡ÏˆÏ‰Ã—Ã·â€°â‚â‚‚â‚ƒâ‚„â‚…â‚†â‚‡â‚ˆâ‚‰]/g;

const ADMIN_EMAIL="mslmalmyaly223@gmail.com";
const firebaseConfig={apiKey:"AIzaSyD915Zh1Gzl60Z9Y5SBlls1S4tedgzU6hE",authDomain:"student-market-5940e.firebaseapp.com",projectId:"student-market-5940e",storageBucket:"student-market-5940e.appspot.com"};
const AI_ENDPOINT="https://api.deepseek.com/v1/chat/completions";
const AI_KEY="sk-235e2c7845b146ff8da73040e8c9e3b0";

let THEME=loadLocal("THEME","dark");
function applyTheme(){ if(THEME==="light") document.documentElement.classList.add("light"); else document.documentElement.classList.remove("light"); }
$("#openSide")?.addEventListener("click",()=>{ $("#sidebar").classList.add("open"); $("#sideOverlay").style.display="block"; });
$("#closeSide")?.addEventListener("click",closeSidebar);
$("#sideOverlay")?.addEventListener("click",closeSidebar);
function closeSidebar(){ $("#sidebar").classList.remove("open"); $("#sideOverlay").style.display="none"; }

/* Firebase */
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(), db=firebase.firestore();
auth.useDeviceLanguage?.();

/* Boot/App/Auth */
const boot=$("#boot"), app=$("#root"), authView=$("#auth");
function showBoot(){ boot.style.display="flex"; app.style.display="none"; authView.style.display="none"; }
function showApp(){ boot.style.display="none"; app.style.display="grid"; authView.style.display="none"; }
function showAuth(){ boot.style.display="none"; app.style.display="none"; authView.style.display="flex"; }
showBoot();

/* Ø­Ø§Ù„Ø© Ø¹Ø§Ù…Ø© */
let me=null,currentChatId=null,canChat=true;
let index=null,knowledgeChunks=[],rulesMemo="";
const msgs=$("#msgs"),input=$("#input"),inputRow=$("#inputRow");
let pageStack=[];
let attachedImage=null;
let attachToken=0; // Ù„Ù…Ù†Ø¹ ØªØ­Ø¯ÙŠØ«Ø§Øª OCR Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©
const attachWrap=$("#attachWrap");
const ENABLE_OCR=true;

/* ===== Ø§ØµÙ„Ø§Ø­Ø§Øª Ø§Ù„ØªØ±ÙƒÙŠØ²/Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„ ===== */
function scrollIntoViewIfNeeded(el){ try{ el.scrollIntoView({block:"center", behavior:"smooth"}); }catch{} }
["focusin","click","touchend"].forEach(ev=>{
  document.addEventListener(ev,(e)=>{
    const t=e.target;
    if(t && (t.tagName==="INPUT"||t.tagName==="TEXTAREA")) setTimeout(()=>scrollIntoViewIfNeeded(t),60);
  },{passive:true});
});
msgs.addEventListener("click",()=>input.focus(),{passive:true});

let streamingEl=null, streamedText="";
let isStreaming=false;
let currentStream={id:null,chatId:null,controller:null};
function cancelCurrentStream(){
  if(currentStream.controller){ try{ currentStream.controller.abort(); }catch{} }
  currentStream={id:null,chatId:null,controller:null};
  isStreaming=false; streamingEl=null; streamedText="";
}

/* Ø¶Ø¨Ø· Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
function adjustMsgsPadding(){ const h=inputRow.getBoundingClientRect().height; msgs.style.paddingBottom=(h+16)+"px"; }
new ResizeObserver(adjustMsgsPadding).observe(inputRow);

/* ===== Ø§Ø´ØªØ±Ø§Ùƒ ÙˆØªØ¬Ø±Ø¨Ø© ===== */
let userProfileCache=null,timerId=null;
function watchUserProfileCountdown(){
  db.collection("users").doc(me.uid).onSnapshot(s=>{
    userProfileCache=s.data()||{};
    renderDaysBadge();
    if(timerId) clearInterval(timerId);
    timerId=setInterval(renderDaysBadge,1000);
  });
}
function renderDaysBadge(){
  try{
    const p=userProfileCache||{};
    // Ø§Ø°Ø§ ÙƒØ§Ù† Ù…Ø­Ø¸ÙˆØ± (Ø§Ù„ØºØ§Ø¡ Ø§Ø´ØªØ±Ø§Ùƒ) â€” Ù†ÙˆÙ‚Ù ÙƒÙ„Ø´ÙŠ ÙÙˆØ±Ø§Ù‹
    if (p.blocked === true) {
      $("#subBadge").textContent="ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ø´ØªØ±Ø§ÙƒÙƒ";
      canChat=false; $("#paywall").style.display="flex"; return;
    }

    const start=p.trialStart?.toDate?p.trialStart.toDate():new Date();
    const endTrial=new Date(start.getTime()+3*24*60*60*1000);
    const subEnd=p.subscriptionEnd?.toDate?p.subscriptionEnd.toDate():null;
    const now=new Date();
    const end=(p.subscribed&&subEnd)?subEnd:endTrial;

    const left=end-now;
    const badge=$("#subBadge");
    if(left<=0){
      badge.textContent="Ù…ØªØ¨Ù‚ÙŠ Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ø´ØªØ±Ø§ÙƒÙƒ (0 ÙŠÙˆÙ…)";
      canChat=false;
      $("#paywall").style.display="flex";
      return;
    }
    canChat=true; $("#paywall").style.display="none";

    const days=Math.floor(left/(24*60*60*1000));
    if(days>=1){ badge.textContent=`Ù…ØªØ¨Ù‚ÙŠ Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ø´ØªØ±Ø§ÙƒÙƒ (${days} ÙŠÙˆÙ…)`; }
    else{
      const h=Math.floor((left%(24*60*60*1000))/(60*60*1000));
      const m=Math.floor((left%(60*60*1000))/(60*1000));
      const s=Math.floor((left%(60*1000))/1000);
      const pad=n=>String(n).padStart(2,"0");
      badge.textContent=`Ù…ØªØ¨Ù‚ÙŠ Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ø´ØªØ±Ø§ÙƒÙƒ (${pad(h)}:${pad(m)}:${pad(s)})`;
    }
  }catch{ $("#subBadge").textContent="â€”"; }
}
$("#closePaywall").onclick=()=>$("#paywall").style.display="none";

/* ===== ØµÙØ­Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ===== */
function mustAcceptTOS(){ return $("#tos").checked; }
function showErr(t){ $("#authError").textContent=t; setTimeout(()=>$("#authError").textContent="",5000); }
$("#btnGoGoogle").onclick=()=>{ if(!mustAcceptTOS()) return showErr("ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ· Ø£ÙˆÙ„Ø§Ù‹."); openPage("#pageGoogle"); };
$("#btnGoPw").onclick   =()=>{ if(!mustAcceptTOS()) return showErr("ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ· Ø£ÙˆÙ„Ø§Ù‹."); openPage("#pageLoginPw"); };
$("#btnGoSignup").onclick=()=>{ if(!mustAcceptTOS()) return showErr("ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ· Ø£ÙˆÙ„Ø§Ù‹."); openPage("#pageSignup"); };

/* Google Auth */
$("#googleBtn").onclick=async ()=>{
  if (location.protocol==='file:') { $("#gErr").textContent="Google Ù„Ø§ ÙŠØ¹Ù…Ù„ Ù…Ù† file://. Ø§Ø³ØªØ¶Ù Ø§Ù„ØµÙØ­Ø© Ø¹Ù„Ù‰ HTTPS."; return; }
  const btn=$("#googleBtn"), t=$("#gTxt"), s=$("#gSpin");
  btn.disabled=true; t.classList.add("hidden"); s.classList.remove("hidden");
  try{
    const provider=new firebase.auth.GoogleAuthProvider();
    provider.setCustomParameters({prompt:'select_account'});
    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    await auth.signInWithRedirect(provider);
  }catch(e){
    $("#gErr").textContent=e.message||"ØªØ¹Ø°Ø± ÙØªØ­ Ù…ÙÙ†ØªÙ‚ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª.";
    btn.disabled=false; t.classList.remove("hidden"); s.classList.add("hidden");
  }
};
auth.getRedirectResult().catch(()=>{});

/* Password Login (Ù…Ø¹ Ø­Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„) */
$("#loginBtn").onclick=async ()=>{
  const email=$("#emailLogin").value.trim(), pass=$("#passLogin").value.trim();
  if(!email||!pass) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±.");
  const btn=$("#loginBtn"), txt=$("#loginTxt"), spin=$("#loginSpin");
  btn.disabled=true; txt.classList.add("hidden"); spin.classList.remove("hidden");
  try{
    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    await auth.signInWithEmailAndPassword(email, pass);
  }catch(e){ alert(e.message); btn.disabled=false; txt.classList.remove("hidden"); spin.classList.add("hidden"); }
};

/* Reset password */
$("#reset").onclick=async (e)=>{
  e.preventDefault();
  const email=prompt("Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ:");
  if(email){ try{ await auth.sendPasswordResetEmail(email); alert("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„."); }catch(err){ alert(err.message);} }
};

/* Signup (Ù…Ø¹ Ø­Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„) */
$("#signupBtn").onclick=async ()=>{
  const email=$("#emailSignup").value.trim();
  const p1=$("#passSignup").value.trim();
  const p2=$("#passSignup2").value.trim();
  if(!email||!p1||!p2) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.");
  if(p1!==p2) return alert("ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ø³Ø± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†.");
  const btn=$("#signupBtn"), txt=$("#signupTxt"), spin=$("#signupSpin");
  btn.disabled=true; txt.classList.add("hidden"); spin.classList.remove("hidden");
  try{
    await auth.createUserWithEmailAndPassword(email,p1);
    $("#signupMsg").textContent="ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.";
  }catch(e){ alert(e.message); }
  btn.disabled=false; txt.classList.remove("hidden"); spin.classList.add("hidden");
};

/* Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© */
auth.onAuthStateChanged(async (u)=>{
  const btn=$("#googleBtn"), t=$("#gTxt"), s=$("#gSpin");
  if(btn){ btn.disabled=false; t?.classList.remove("hidden"); s?.classList.add("hidden"); }

  if(u){
    me=u;
    $("#userEmail").textContent=u.email||"";
    $("#adminBtn").style.display=(me?.email===ADMIN_EMAIL)?"block":"none";
    applyTheme(); adjustMsgsPadding();
    await ensureUserDoc();
    watchUserProfileCountdown();
    bindChatList();
    await loadKnowledgeFromDB();
    await ensureFirstChat();
    showApp();
  }else{
    showAuth();
  }
});

/* Ø¥Ù†Ø´Ø§Ø¡/ØªØ­Ø¯ÙŠØ« Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
async function ensureUserDoc(){
  const ref=db.collection("users").doc(me.uid);
  await db.runTransaction(async tx=>{
    const s=await tx.get(ref);
    if(!s.exists){
      tx.set(ref,{
        email:me.email||null,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        trialStart: firebase.firestore.FieldValue.serverTimestamp(),
        subscribed:false,
        subscriptionEnd:null,
        blocked:false, // Ù…Ù‡Ù… Ù„Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙÙˆØ±ÙŠ
        lastActive: firebase.firestore.FieldValue.serverTimestamp()
      });
    }else{
      tx.update(ref,{ lastActive: firebase.firestore.FieldValue.serverTimestamp() });
    }
  });
}

/* ===== Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª ===== */
let unSubMsgs=null;
let CHAT_CACHE = loadLocal("CHAT_CACHE", []);
function cacheSet(list){ CHAT_CACHE=list; saveLocal("CHAT_CACHE", list); }

function insertChatRowDom(id, title){
  const list=$("#chatList");
  if(list.querySelector(`.item[data-id="${id}"]`)) return;
  const row=document.createElement("div");
  row.className="item"+(id===currentChatId?" active":"");
  row.dataset.id=id;

  const t=document.createElement("div"); t.className="item-title"; t.textContent=title||"â€”";
  const ops=document.createElement("div"); ops.className="item-ops";

  const edit=document.createElement("button"); edit.className="btn"; edit.textContent="âœï¸";
  edit.onclick=async (e)=>{
    e.stopPropagation();
    const nt=prompt("Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯:", (t.textContent||"").trim() || "Ù…Ø­Ø§Ø¯Ø«Ø©");
    if(nt && nt!==t.textContent){
      t.textContent = nt;
      try{ await db.collection("chats").doc(id).update({title:nt, clientUpdated:Date.now(), updatedAt:firebase.firestore.FieldValue.serverTimestamp()}); }catch{}
      const arr = [{id, title:nt}, ...CHAT_CACHE.filter(x=>x.id!==id)];
      cacheSet(arr);
    }
  };
  const del=document.createElement("button"); del.className="btn"; del.textContent="ğŸ—‘ï¸";
  del.onclick=async (e)=>{ e.stopPropagation(); if(confirm("Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©ØŸ")) await deleteChat(id); };

  ops.appendChild(edit); ops.appendChild(del);
  row.appendChild(t); row.appendChild(ops);
  row.onclick=()=>{ loadChat(id); closeSidebar(); };
  list.prepend(row);
}

function bindChatList(){
  $("#chatList").innerHTML="";
  CHAT_CACHE.forEach(c=>insertChatRowDom(c.id, c.title));

  db.collection("chats").where("uid","==",me.uid).orderBy("clientUpdated","desc")
    .onSnapshot(snap=>{
      const list=$("#chatList"); list.innerHTML="";
      const arr=[];
      snap.forEach(doc=>{
        const c=doc.data(); const id=doc.id;
        arr.push({id, title:c.title||"Ù…Ø­Ø§Ø¯Ø«Ø©"});
        insertChatRowDom(id, c.title||"Ù…Ø­Ø§Ø¯Ø«Ø©");
      });
      cacheSet(arr);
      setActiveChatItem(currentChatId);
    }, ()=>{
      if($("#chatList").children.length===0){
        CHAT_CACHE.forEach(c=>insertChatRowDom(c.id, c.title));
      }
    });
}
function setActiveChatItem(id){
  document.querySelectorAll("#chatList .item").forEach(x=>x.classList.toggle("active", x.dataset.id===id));
}

async function ensureFirstChat(){
  const existing = await db.collection("chats").where("uid","==",me.uid).limit(1).get();
  if(!existing.empty){
    currentChatId = existing.docs[0].id;
    loadChat(currentChatId);
  }else{
    await newChat();
  }
}

async function newChat(){
  cancelCurrentStream();
  const ref=await db.collection("chats").add({
    uid:me.uid, title:"Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©",
    clientUpdated: Date.now(),
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  currentChatId=ref.id;
  insertChatRowDom(ref.id, "Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©");
  const arr=[{id:ref.id, title:"Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©"}, ...CHAT_CACHE.filter(x=>x.id!==ref.id)];
  cacheSet(arr);
  setActiveChatItem(ref.id);
  loadChat(ref.id);
}
$("#startChatTop").onclick=newChat;

async function deleteChat(id){
  try{
    if(unSubMsgs && currentChatId===id){ unSubMsgs(); unSubMsgs=null; }
    const row=document.querySelector(`#chatList .item[data-id="${id}"]`); if(row) row.remove();
    cacheSet(CHAT_CACHE.filter(x=>x.id!==id));

    const ref=db.collection("chats").doc(id);
    const msgsSnap=await ref.collection("messages").get();
    const batch=db.batch(); msgsSnap.forEach(d=>batch.delete(ref.collection("messages").doc(d.id))); await batch.commit();
    await ref.delete();

    if(currentChatId===id){
      currentChatId=null; msgs.innerHTML="";
      if(CHAT_CACHE[0]) loadChat(CHAT_CACHE[0].id);
    }
  }catch(e){ alert(e.message||e); }
}

/* Ø­Ø§Ù„Ø© Ù…Ø­Ø§Ø¯Ø«Ø© ÙØ§Ø±ØºØ© */
function renderEmptyHero(){
  msgs.innerHTML="";
  const wrap=document.createElement("div");
  wrap.className="empty-hero";
  wrap.innerHTML=`
    <svg class="logoMark" viewBox="0 0 128 128" fill="none" xmlns="http://www.w3.org/2000/svg">
      <defs><linearGradient id="gh" x1="0" y1="0" x2="128" y2="128"><stop stop-color="#6d83ff"/><stop offset="1" stop-color="#3b57ff"/></linearGradient></defs>
      <path d="M16 46L64 26l48 20-48 20-48-20Z" fill="url(#gh)"/>
      <path d="M32 58l32 14 32-14v14c0 10-14 18-32 18s-32-8-32-18V58Z" fill="#2a2f43"/>
      <circle cx="104" cy="73" r="6" fill="#4a6bff"/>
      <circle cx="42" cy="94" r="6" fill="#7ea0ff"/><circle cx="86" cy="94" r="6" fill="#7ea0ff"/>
      <path d="M42 94h44" stroke="#9fb3ff" stroke-width="3" stroke-linecap="round"/>
    </svg>
    <div class="name">Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ Ø£Ù†Ø§ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ ÙÙŠ Ø§Ù„Ø³Ø§Ø¯Ø³.</div>
    <div class="sub">ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ</div>
  `;
  msgs.appendChild(wrap);
}
function watchMessages(chatId){
  return db.collection("chats").doc(chatId).collection("messages").orderBy("clientTs","asc")
    .onSnapshot(snap=>{
      if(isStreaming) return;
      if(snap.empty){ renderEmptyHero(); return; }
      msgs.innerHTML="";
      snap.forEach(doc=>{ renderMsg(doc.id, doc.data()); });
      msgs.scrollTo({top:msgs.scrollHeight+1000});
    });
}
async function loadChat(id){
  cancelCurrentStream();
  currentChatId=id; setActiveChatItem(id);
  msgs.innerHTML="";
  if(unSubMsgs) unSubMsgs();
  unSubMsgs=watchMessages(id);
}

/* Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© */
function renderMsg(id, m){
  const isMath=/\\(frac|sqrt|sum|Delta|pi|times|div|rightarrow|left|right)|\$\$/.test(m.text||"");
  const who=m.role==="user"?"user":"bot";
  const img=m.imageDataURL||null;
  const html=(m.text||"").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  const el=document.createElement("div");
  el.className=`msg ${who}`+(isMath?" math":"");
  if(id) el.dataset.mid=id;
  el.dataset.role=m.role;
  if(img){ const im=new Image(); im.className="attachment"; im.src=img; el.appendChild(im); }
  const box=document.createElement("div"); box.innerHTML=html; el.appendChild(box);
  msgs.appendChild(el);
  if(window.MathJax) MathJax.typesetPromise([el]).catch(()=>{});
}

/* Ø­ÙØ¸ Ø±Ø³Ø§Ù„Ø© */
async function appendMessageStore(role,text,imageDataURL=null, forceChatId=null){
  const chatId = forceChatId || currentChatId;
  if(!chatId) return;
  const ref=db.collection("chats").doc(chatId).collection("messages");
  await ref.add({ role, text, imageDataURL, clientTs: Date.now(), ts: firebase.firestore.FieldValue.serverTimestamp() });
  await db.collection("chats").doc(chatId).update({ clientUpdated: Date.now(), updatedAt:firebase.firestore.FieldValue.serverTimestamp() });
  try{ await db.collection("users").doc(me.uid).update({ lastActive: firebase.firestore.FieldValue.serverTimestamp() }); }catch{}
}

/* ===== Ù…Ø¹Ø±ÙØ© ===== */
function arNormalize(s){ return (s||"").replace(/[\u0610-\u061A\u064B-\u065F\u06D6-\u06ED]/g,'').replace(/[Ø£Ø¥Ø¢]/g,'Ø§').replace(/Ù‰/g,'ÙŠ').replace(/Ø¤/g,'Ùˆ').replace(/Ø¦/g,'ÙŠ').replace(/Ø©/g,'Ù‡').replace(/[Ù€]+/g,'').toLowerCase(); }
function chunkAll(texts){ const arr=[]; texts.forEach(t=>{ const clean=(t||"").replace(/(\.|\!|\ØŸ|\?|Ø›)/g,'$1\n'); const parts=clean.split(/\n+/).map(x=>x.trim()).filter(Boolean); let buf=""; for(const line of parts){ if((buf+" "+line).length<=700) buf=(buf?buf+" ":"")+line; else { if(buf) arr.push(buf); buf=line; } } if(buf) arr.push(buf); }); return arr.slice(-1500); }
function buildIndex(chunks){
  const tokenize=s=>arNormalize(s).replace(SAFE_TOKENS," ").split(/\s+/).filter(w=>w.length>1);
  const docs=chunks.map(c=>({text:c,toks:tokenize(c)}));
  const df=new Map(); docs.forEach(d=>{[...new Set(d.toks)].forEach(w=>df.set(w,(df.get(w)||0)+1));});
  const N=docs.length||1;
  docs.forEach(d=>{
    const tf=new Map(); d.toks.forEach(w=>tf.set(w,(tf.get(w)||0)+1));
    d.vec=new Map();
    tf.forEach((f,w)=>{ const idf=Math.log((N+1)/((df.get(w)||1)+1))+1; d.vec.set(w,(f/d.toks.length)*idf);});
    delete d.toks;
  });
  index={docs,df:N?df:new Map(),N,tokenize};
}
function retrieve(q,k=6){
  if(!index||!index.docs.length) return [];
  const qT=index.tokenize(q);
  const tf=new Map(); qT.forEach(w=>tf.set(w,(tf.get(w)||0)+1));
  const qV=new Map(); tf.forEach((f,w)=>{ const idf=Math.log((index.N+1)/((index.df.get(w)||1)+1))+1; qV.set(w,(f/qT.length)*idf);});
  const qn=norm(qV);
  const scored=index.docs.map(d=>({text:d.text,score:dot(qV,d.vec)/(qn*norm(d.vec))})).sort((a,b)=>b.score-a.score).slice(0,k);
  return scored.filter(s=>s.score>0.01).map(s=>s.text);
  function dot(a,b){let s=0;a.forEach((va,wa)=>{s+=va*(b.get(wa)||0)});return s}
  function norm(v){let s=0;v.forEach(x=>s+=x*x);return Math.sqrt(s)||1}
}
async function loadKnowledgeFromDB(){
  const s=await db.collection("knowledge").orderBy("createdAt","desc").limit(1000).get();
  const infoTexts=[]; rulesMemo="";
  s.docs.forEach(d=>{
    const x=d.data(); const t=(x.type||"").toLowerCase();
    if(t==="pdf" || t==="info" || t==="text"){
      const joined=[x.note?`Ù…Ù„Ø§Ø­Ø¸Ø©: ${x.note}`:"",x.text||""].join("\n").trim();
      if(joined) infoTexts.push(joined);
    }else if(t==="rule"){ if(x.text) rulesMemo=(rulesMemo?rulesMemo+"\n":"")+x.text; }
  });
  knowledgeChunks=chunkAll(infoTexts); buildIndex(knowledgeChunks);
}

/* Ø¥Ø¯Ø®Ø§Ù„ + Ù…Ø±ÙÙ‚Ø§Øª + Ø¥Ø±Ø³Ø§Ù„ */
$("#send").onclick=onSend;
$("#input").addEventListener("keydown",e=>{if(e.key==="Enter")onSend();});
$("#attach").onclick=()=>$("#imgFile").click();
$("#imgFile").addEventListener("change", async (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  const myTok=++attachToken;
  const r=new FileReader();
  r.onload=()=>{ if(myTok!==attachToken) return; const dataURL=r.result; attachedImage={name:(f.name||"image").replace(/\.\w+$/,"")+".jpg", sizeKB:Math.round(f.size/1024), dataURL}; showAttachChip(); input.focus(); };
  r.readAsDataURL(f);
  try{
    if(ENABLE_OCR){
      const {data:{text}}=await Tesseract.recognize(f,'ara+eng');
      if(myTok===attachToken && attachedImage) attachedImage.ocrText=(text||"").trim();
    }
  }catch{}
  e.target.value="";
});
function showAttachChip(){
  if(!attachedImage){ attachWrap.classList.add("hidden"); attachWrap.innerHTML=""; return; }
  const {name,sizeKB,dataURL}=attachedImage;
  attachWrap.innerHTML=`
    <div class="attach-chip">
      <div class="thumb"><img src="${dataURL}"></div>
      <div class="name">${name} Â· ${sizeKB}KB</div>
      <div class="x" id="removeAttach">âœ•</div>
    </div>`;
  attachWrap.classList.remove("hidden");
  $("#removeAttach").onclick=()=>{ attachedImage=null; ++attachToken; showAttachChip(); input.focus(); };
}

function wantsLongExplain(t){ return /(Ø§Ø´Ø±Ø­|Ø´Ø±Ø­|ÙØ³Ø±|ÙˆØ¶Ø­|ÙØ³Ø±Ù„ÙŠ|Ø´Ø±Ø­Ù„ÙŠ|Ø­Ù„ Ø¨Ø§Ù„ØªÙØµÙŠÙ„|ØªÙØµÙŠÙ„|Ø§ÙÙ‡Ù…Ù†ÙŠ)/i.test(t||""); }
function isProblemLike(t){ return /(Ù…Ø³Ø§Ù„Ù‡|Ù…Ø¹Ø§Ø¯Ù„Ø©|Ø§Ø­Ø³Ø¨|Ø­Ù„|Ø¬Ø¯|Ù…Ø«Ø§Ù„|Ù‚Ø§Ù†ÙˆÙ†|Ù…ÙˆÙ„|ØªØ±ÙƒÙŠØ²|Ù…Ø¹Ø§ÙŠØ±Ù‡|Ø§ØªØ²Ø§Ù†|Ø­Ø±ÙƒÙ‡|Ù…Ø¬Ø§Ù„)/i.test(t||""); }

async function onSend(){
  if(!canChat){ $("#paywall").style.display="flex"; return; }
  const userTxt=$("#input").value.trim();
  if(!userTxt && !attachedImage) return;

  cancelCurrentStream();

  renderMsg(null,{role:"user",text:userTxt || "[ØµÙˆØ±Ø© ÙÙ‚Ø·]",imageDataURL:attachedImage?.dataURL || null});
  if(!currentChatId) await newChat();
  await db.collection("chats").doc(currentChatId).collection("messages")
    .add({ role:"user", text:userTxt || "[ØµÙˆØ±Ø© ÙÙ‚Ø·]", imageDataURL:attachedImage?.dataURL||null, clientTs: Date.now(), ts: firebase.firestore.FieldValue.serverTimestamp() });
  await db.collection("chats").doc(currentChatId).update({ clientUpdated: Date.now(), updatedAt: firebase.firestore.FieldValue.serverTimestamp() });

  let finalPrompt="";
  if(attachedImage){
    const ocr=attachedImage.ocrText && attachedImage.ocrText.trim()? attachedImage.ocrText.trim() : "";
    finalPrompt=[
      "Ù‡Ø°Ù‡ ØµÙˆØ±Ø© Ù…Ø³Ø£Ù„Ø©/Ù†Øµ. Ø­Ù„Ù‘Ù„ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø¯Ù‚Ø©:",
      ocr?("â€” Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬ (OCR):\n"+ocr):"",
      userTxt?("â€” Ù…Ù„Ø§Ø­Ø¸ØªÙŠ/Ø³Ø¤Ø§Ù„ÙŠ:\n"+userTxt):"",
      "Ø±Ø¬Ø§Ø¡Ù‹: Ø§Ø¹Ø±Ø¶ Ø§Ù„Ø­Ù„ Ø¨Ø®Ø·ÙˆØ§Øª Ù…Ø±Ù‚Ù…Ø© ÙˆØ¨Ù€ LaTeX Ø¯Ø§Ø®Ù„ $$ .. $$ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©."
    ].filter(Boolean).join("\n\n");
  }else{
    finalPrompt=userTxt;
  }
  $("#input").value="";
  attachedImage=null; ++attachToken; showAttachChip(); // Ø¥Ø²Ø§Ù„Ø© ÙÙˆØ±ÙŠØ© ÙˆÙ†Ù‡Ø§Ø¦ÙŠØ©

  const wantsLong = wantsLongExplain(userTxt) || isProblemLike(finalPrompt);
  const problem = isProblemLike(finalPrompt);
  const ctxPieces=retrieve(finalPrompt,6);
  const ctx=ctxPieces.join("\n---\n");

  const reqId=Math.random().toString(36).slice(2);
  const controller=new AbortController();
  currentStream={id:reqId,chatId:currentChatId,controller};

  startStreaming();
  try{
    await streamAI(ctx, finalPrompt, {wantsLong,isProblem:problem,signal:controller.signal,reqId});
  }catch(e){
    if(e.name==="AbortError") return;
    endStreaming(reqId);
    renderMsg(null,{role:"bot",text:"ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¨Ø«ØŒ Ø³Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ø¯ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©â€¦"});
    await callAIOnce(ctx, finalPrompt, {wantsLong,isProblem:problem});
  }
}

/* ØªÙ†Ø¸ÙŠÙ ØªÙƒØ±Ø§Ø±Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ */
function cleanAI(s){
  if(!s) return s;
  let x=(s||"").replace(/\r/g,"").replace(/[ \t]+\n/g,"\n").replace(/\n{3,}/g,"\n\n").trim();
  const paras=x.split(/\n{2,}/).map(p=>p.trim()).filter(Boolean);
  const out=[]; const seen=new Set();
  for(const p of paras){ const key=p.replace(/\s+/g," "); if(!seen.has(key)){ out.push(p); seen.add(key);} }
  x=out.join("\n\n");
  if(x.length>120){
    const mid=Math.floor(x.length/2);
    const a=x.slice(0,mid).trim(), b=x.slice(mid).trim();
    if(a===b) x=a;
  }
  return x;
}

/* AI */
function sysPrompt({wantsLong,isProblem}){
  return [
    "Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø¯Ø±Ø§Ø³ÙŠ Ø°ÙƒÙŠ Ø¬Ø¯Ù‹Ø§.",
    wantsLong ? "Ø§ÙƒØªØ¨ Ø´Ø±Ø­Ù‹Ø§ ØªÙØµÙŠÙ„ÙŠÙ‹Ø§ Ù…Ø¹ Ø®Ø·ÙˆØ§Øª Ù…Ø±Ù‚Ù…Ø© ÙˆØ¹Ù†Ø§ÙˆÙŠÙ† ÙØ±Ø¹ÙŠØ©." : "Ø£Ø¬Ø¨ Ø¨Ø§Ø®ØªØµØ§Ø± Ø´Ø¯ÙŠØ¯ ÙˆÙˆØ§Ø¶Ø­ (Ø³Ø·Ø±Ø§Ù† ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰) Ø¥Ù„Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø³Ø£Ù„Ø© ØªØ­ØªØ§Ø¬ Ø®Ø·ÙˆØ§Øª.",
    "Ø§Ø¯Ø¹Ù… Ø§Ù„Ø±Ù…ÙˆØ² ÙˆØ§Ù„Ù„Ø§ØªÙƒØ³: $$ .. $$ Ø£Ùˆ \\( .. \\) Ù…Ø«Ù„: \\(\\Delta,\\sqrt{},\\frac{},\\sum,\\pi,\\times,\\div,\\rightarrow\\).",
    isProblem ? "Ù†Ø¸Ø±Ù‹Ø§ Ù„ÙƒÙˆÙ†Ù‡Ø§ Ù…Ø³Ø£Ù„Ø©: Ø§Ø³ØªØ®Ø¯Ù… Ø®Ø·ÙˆØ§Øª 1,2,3â€¦ Ù…Ø¹ ØªØ¨Ø±ÙŠØ± Ù…Ø®ØªØµØ± Ù„ÙƒÙ„ Ø®Ø·ÙˆØ©." : "",
    "Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø¨Ù„Ø·Ù Ø¹Ù†Ø¯ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© ğŸ™‚."
  ].filter(Boolean).join("\n");
}
function startStreaming(){
  isStreaming = true;
  streamingEl = document.createElement("div");
  streamingEl.className = "msg bot";
  streamingEl.dataset.role = "bot";
  streamingEl.textContent = "";
  streamedText="";
  msgs.appendChild(streamingEl);
  msgs.scrollTo({top: msgs.scrollHeight + 1000, behavior: "smooth"});
}
function pushChunk(txt, reqId){
  if(currentStream.id!==reqId) return;
  if(!streamingEl) startStreaming();
  streamingEl.textContent += txt;
  streamedText += txt;
  msgs.scrollTo({top: msgs.scrollHeight + 1000});
}
function endStreaming(reqId){
  if(currentStream.id!==reqId) return;
  if(!streamingEl){ isStreaming=false; streamedText=""; return; }
  const cleaned = cleanAI(streamedText||"");
  const html = cleaned.replace(/</g,"&lt;").replace(/>/g,"&gt;");
  const isMath = /\\(frac|sqrt|sum|Delta|pi|times|div|rightarrow|left|right)|\$\$/.test(cleaned);
  const finalEl = document.createElement("div");
  finalEl.className = `msg bot${isMath?" math":""}`;
  finalEl.dataset.role="bot";
  const box = document.createElement("div"); box.innerHTML = html; finalEl.appendChild(box);
  streamingEl.replaceWith(finalEl);
  if(window.MathJax) MathJax.typesetPromise([finalEl]).catch(()=>{});
  streamingEl = null; isStreaming=false;
  streamedText = cleaned;
}
async function streamAI(context, user, {wantsLong,isProblem,signal,reqId}){
  const msgsPayload=[
    {role:"system",content:sysPrompt({wantsLong,isProblem})},
    ...(context? [{role:"system",content:`Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø±Ø¬Ø¹ÙŠØ©:\n${context}`}]: []),
    {role:"user",content:user}
  ];
  const body={model:"deepseek-chat",messages:msgsPayload,temperature:isProblem?0.2:(wantsLong?0.25:0.15),top_p:0.95,max_tokens:1700,stream:true};
  const res=await fetch(AI_ENDPOINT,{method:"POST",headers:{"Content-Type":"application/json","Authorization":"Bearer "+AI_KEY},body:JSON.stringify(body),signal});
  if(!res.ok) throw new Error("HTTP "+res.status);
  const reader=res.body.getReader(); const decoder=new TextDecoder("utf-8");
  let buf="";
  while(true){
    const {value,done}=await reader.read(); if(done) break;
    if(currentStream.id!==reqId) { try{reader.cancel();}catch{} return; }
    buf+=decoder.decode(value,{stream:true});
    const parts=buf.split("\n\n"); buf=parts.pop();
    for(const part of parts){
      const line=part.trim(); if(!line.startsWith("data:")) continue;
      const payload=line.slice(5).trim(); if(payload==="[DONE]"){
        const finalText = cleanAI(streamedText);
        endStreaming(reqId);
        await appendMessageStore("bot", finalText, null, currentStream.chatId);
        return;
      }
      try{ const obj=JSON.parse(payload); const delta=obj.choices?.[0]?.delta?.content||""; if(delta) pushChunk(delta,reqId); }catch{}
    }
  }
}
async function callAIOnce(context, user, {wantsLong,isProblem}){
  const msgs = [
    {role:"system", content: sysPrompt({wantsLong,isProblem})},
    ...(context? [{role:"system", content:`Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø±Ø¬Ø¹ÙŠØ©:\n${context}`}]: []),
    {role:"user", content: user}
  ];
  const res = await fetch(AI_ENDPOINT, {
    method: "POST",
    headers: { "Content-Type":"application/json", "Authorization":"Bearer "+AI_KEY },
    body: JSON.stringify({ model:"deepseek-chat", messages: msgs, temperature:isProblem?0.2:(wantsLong?0.25:0.15), max_tokens:1700 })
  });
  if(!res.ok){ renderMsg(null,{role:"bot",text:`ÙØ´Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø°ÙƒØ§Ø¡ (HTTP ${res.status}). Ø¬Ø±Ù‘Ø¨ Ù„Ø§Ø­Ù‚Ù‹Ø§.`}); return; }
  const data = await res.json();
  const out  = cleanAI(data?.choices?.[0]?.message?.content || "ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø¯.");
  renderMsg(null,{role:"bot",text:out});
  await appendMessageStore("bot", out, null, currentChatId);
}

/* ===== Ø§Ø­ØµØ§Ø¡Ø§Øª ===== */
async function refreshUserStats(){
  if(me?.email!==ADMIN_EMAIL){
    $("#statTotal").textContent="â€”";
    $("#statActiveNow").textContent="â€”";
    $("#statUsersToday").textContent="â€”";
    $("#statMsgsToday").textContent="â€”";
    return alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©.");
  }
  const now=new Date(); const startOfDay=new Date(now.getFullYear(),now.getMonth(),now.getDate());
  const usersSnap=await db.collection("users").get();
  const totalUsers=usersSnap.size;
  const fiveMinAgo=new Date(now.getTime()-5*60*1000);
  let activeNow=0, usersToday=0;
  usersSnap.forEach(d=>{
    const u=d.data(); const la=u.lastActive?.toDate?u.lastActive.toDate():null;
    if(la){ if(la>=fiveMinAgo) activeNow++; if(la>=startOfDay) usersToday++; }
  });
  let msgsToday=0;
  const chatsSnap=await db.collection("chats").where("updatedAt",">=", firebase.firestore.Timestamp.fromDate(startOfDay)).get().catch(()=>({docs:[]}));
  for(const ch of (chatsSnap.docs||[])){
    const mSnap=await db.collection("chats").doc(ch.id).collection("messages").where("ts",">=", firebase.firestore.Timestamp.fromDate(startOfDay)).get().catch(()=>({size:0}));
    msgsToday+=(mSnap.size||0);
  }
  $("#statTotal").textContent=totalUsers;
  $("#statActiveNow").textContent=activeNow;
  $("#statUsersToday").textContent=usersToday;
  $("#statMsgsToday").textContent=msgsToday;
}

/* ===== ØµÙØ­Ø§Øª ===== */
function openPage(id){ const el=$(id); if(!el) return; el.style.display="block"; pageStack.push(id); }
function goBack(){
  if(pageStack.length<=1){ pageStack=[]; document.querySelectorAll(".page").forEach(p=>p.style.display="none"); return; }
  const cur=pageStack.pop(); if(cur) $(cur).style.display="none"; const prev=pageStack[pageStack.length-1]; if(prev) $(prev).style.display="block";
}
document.querySelectorAll("[data-back]").forEach(b=>b.addEventListener("click",goBack));
$("#adminBtn").onclick=()=>{ if(me?.email!==ADMIN_EMAIL){ alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©."); return; } openPage("#pageHub"); };
$("#tileUsers").onclick=()=>{ $("#pageHub").style.display="none"; openPage("#pageUsers"); refreshUserStats(); };
$("#tileSubs").onclick =()=>{ $("#pageHub").style.display="none"; openPage("#pageSubs"); };
$("#tileTrain").onclick=()=>{ $("#pageHub").style.display="none"; openPage("#pageTrain"); };
$("#logout").onclick=()=>auth.signOut();

/* ===== Ø§Ø´ØªØ±Ø§ÙƒØ§Øª: Ø¥Ø¶Ø§ÙØ© + Ø¥Ù„ØºØ§Ø¡ ===== */
$("#addDays").onclick=async ()=>{
  if(me?.email!==ADMIN_EMAIL) return alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©.");
  const email=($("#subEmail").value||"").trim();
  const days=parseInt($("#subDays").value||"0",10);
  if(!email || !days || days<=0) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆØ¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… (>0).");
  const q=await db.collection("users").where("email","==",email).limit(1).get();
  if(q.empty) return $("#subMsg").textContent="Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.";
  const ref=q.docs[0].ref; const doc=await ref.get(); const d=doc.data();
  const now=new Date();
  const curEnd=(d.subscribed && d.subscriptionEnd?.toDate)? d.subscriptionEnd.toDate():now;
  const base=Math.max(curEnd.getTime(), now.getTime());
  const newEnd=new Date(base + days*24*60*60*1000);
  await ref.update({subscribed:true,subscriptionEnd:firebase.firestore.Timestamp.fromDate(newEnd),blocked:false});
  $("#subMsg").textContent=`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${days} ÙŠÙˆÙ…. Ø§Ù„Ù†Ù‡Ø§ÙŠØ©: ${newEnd.toLocaleString()}`;
};
$("#cancelSub").onclick=async ()=>{
  if(me?.email!==ADMIN_EMAIL) return alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©.");
  const email=($("#cancelEmail").value||"").trim();
  if(!email) return alert("Ø§ÙƒØªØ¨ Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….");
  const q=await db.collection("users").where("email","==",email).limit(1).get();
  if(q.empty) return $("#cancelMsg").textContent="Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.";
  const ref=q.docs[0].ref;
  await ref.update({subscribed:false,subscriptionEnd:null,blocked:true,canceledAt:firebase.firestore.FieldValue.serverTimestamp()});
  $("#cancelMsg").textContent="ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙˆØ±Ù‹Ø§. Ø³ÙŠØ¸Ù‡Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Paywall Ø­ØªÙ‰ ÙŠØ¹ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ.";
};

window.addEventListener("load",()=>{ applyTheme(); adjustMsgsPadding(); });
</script>
</body>
</html>
