<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<meta http-equiv="Content-Security-Policy" content="default-src 'self' https://www.gstatic.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://fonts.googleapis.com https://fonts.gstatic.com; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.gstatic.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; connect-src 'self' https://*.firebaseio.com https://*.googleapis.com https://api.deepseek.com; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com;">
<title>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ ÙÙŠ Ø§Ù„Ø³Ø§Ø¯Ø³ | Sixth Assistant</title>

<!-- Firebase v9 (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- pdf.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>try{pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';}catch{}</script>

<link rel="manifest" href="manifest.json">
	<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	
<!-- Tesseract.js -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<!-- MathJax -->
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<style>
:root{--bg:#0c0d10;--panel:#13151a;--card:#0f1116;--stroke:#242833;--text:#e9ecf1;--muted:#9aa4b2;--brand:#4a6bff;--ok:#2ecc71;--err:#e74c3c;--user-dark:#2e333d;--bot-dark:#0f1320;--user-light:#3b57ff;--bot-light:#ffffff}
:root.light{--bg:#f6f7fb;--panel:#ffffff;--card:#ffffff;--stroke:#dbe1ea;--text:#0b1220;--muted:#5b6473;--brand:#3b57ff;--ok:#1f9d5a;--err:#cf3434}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none;-webkit-user-select:none}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Tajawal",sans-serif;overflow:hidden}
.hidden{display:none}

/* Toast ØµØºÙŠØ± Ù„Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø±ÙŠØ¹ */
.toast{position:fixed;inset-inline:0;top:12px;margin:auto;max-width:520px;background:#121826;color:#fff;border:1px solid var(--stroke);border-radius:12px;padding:10px 14px;text-align:center;z-index:999;opacity:0;transform:translateY(-8px);transition:.2s}
.toast.show{opacity:1;transform:translateY(0)}

/* Boot Animation Ø¬Ø¯ÙŠØ¯ */
#boot{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--bg);z-index:100;color:var(--muted);gap:20px}
.boot-logo{width:120px;height:120px;animation:logoFloat 3s ease-in-out infinite}
.boot-title{font-size:32px;font-weight:900;background:linear-gradient(135deg,#4a6bff,#6d83ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:textGlow 2s ease-in-out infinite alternate}
.boot-subtitle{font-size:16px;color:var(--muted);margin-top:-10px}
.boot-loading{display:flex;flex-direction:column;align-items:center;gap:8px;margin-top:20px}
.boot-progress{width:200px;height:4px;background:var(--stroke);border-radius:2px;overflow:hidden}
.boot-progress-bar{height:100%;background:var(--brand);width:0%;transition:width 0.3s ease}
.boot-text{font-size:14px;color:var(--muted)}

@keyframes logoFloat{
    0%,100%{transform:translateY(0px)}
    50%{transform:translateY(-10px)}
}
@keyframes textGlow{
    0%{filter:drop-shadow(0 0 5px rgba(74,107,255,0.3))}
    100%{filter:drop-shadow(0 0 15px rgba(74,107,255,0.6))}
}
@keyframes letterWave{
    0%,100%{transform:translateY(0px)}
    25%{transform:translateY(-5px)}
    50%{transform:translateY(0px)}
    75%{transform:translateY(5px)}
}

.letter{display:inline-block;animation:letterWave 2s ease-in-out infinite}
.letter:nth-child(1){animation-delay:0s}
.letter:nth-child(2){animation-delay:0.1s}
.letter:nth-child(3){animation-delay:0.2s}
.letter:nth-child(4){animation-delay:0.3s}
.letter:nth-child(5){animation-delay:0.4s}
.letter:nth-child(6){animation-delay:0.5s}
.letter:nth-child(7){animation-delay:0.6s}
.letter:nth-child(8){animation-delay:0.7s}
.letter:nth-child(9){animation-delay:0.8s}
.letter:nth-child(10){animation-delay:0.9s}
.letter:nth-child(11){animation-delay:1.0s}

#root{position:fixed;inset:0;display:none;grid-template-columns:280px 1fr;width:100vw;height:100vh}

/* Sidebar */
.sidebar{background:var(--panel);border-inline-end:1px solid var(--stroke);display:flex;flex-direction:column;min-width:260px;z-index:30}
.side-head{padding:10px;border-bottom:1px solid var(--stroke);display:flex;align-items:center;gap:8px}
.toggle{width:42px;height:42px;border-radius:12px;border:1px solid var(--stroke);background:#141821;color:#fff;font-weight:900;display:flex;align-items:center;justify-content:center;cursor:pointer}
:root.light .toggle{background:#eef1f8;color:#0b1220}
.sub-badge{margin-inline-start:auto;font-size:12px;padding:8px 10px;border:1px solid var(--stroke);border-radius:999px;background:#0e1422;white-space:nowrap}
:root.light .sub-badge{background:#eef2fb;color:#0b1220}
.btn{height:48px;border-radius:12px;border:1px solid var(--stroke);background:#141821;color:#fff;display:flex;align-items:center;justify-content:center;gap:8px;font-weight:700;cursor:pointer;padding:0 14px}
:root.light .btn{background:#eef1f8;color:#0b1220}
.btn.primary{background:var(--brand);border-color:transparent;color:#fff}
.btn.flat{background:transparent}
.btn[disabled]{opacity:.6;cursor:not-allowed}
.list{flex:1;overflow:auto;padding:8px 6px}
.item{padding:10px 12px;border-radius:10px;border:1px solid transparent;display:flex;align-items:center;gap:8px}
.item:hover{background:#151a23}:root.light .item:hover{background:#eef2fb}
.item.active{background:#0f1420;border-color:#2b3342}:root.light .item.active{background:#eaf0ff;border-color:#cfd9ff}
.item-title{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.item-ops{display:flex;gap:6px}
.side-foot{padding:10px;border-top:1px solid var(--stroke);display:flex;flex-direction:column;gap:8px}
.small{font-size:12px;color:var(--muted)}
#sideOverlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:20}

/* Main */
.main{display:grid;grid-template-rows:auto 1fr auto;min-width:0;min-height:0;position:relative;z-index:10;background:#0b0d12}
:root.light .main{background:#f6f7fb}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--stroke);background:linear-gradient(180deg,#0d1016,#0c0d10)}
:root.light .topbar{background:linear-gradient(180deg,#ffffff,#f1f3f8)}
.topbar .left{display:flex;gap:8px;align-items:center}

/* Intelligence Selector ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ */
.intelligence-selector{position:relative;display:flex;align-items:center;margin:0 auto}
.intelligence-trigger{display:flex;align-items:center;gap:8px;background:var(--panel);border:1px solid var(--stroke);border-radius:20px;padding:8px 16px;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.2s}
.intelligence-trigger:hover{background:var(--card)}
.intelligence-dropdown{position:absolute;top:100%;left:50%;transform:translateX(-50%);margin-top:8px;background:var(--panel);border:1px solid var(--stroke);border-radius:12px;padding:8px;min-width:120px;box-shadow:0 8px 24px rgba(0,0,0,0.3);z-index:100;display:none}
.intelligence-dropdown.show{display:block}
.intelligence-option{display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:8px;cursor:pointer;transition:all 0.2s}
.intelligence-option:hover{background:var(--card)}
.intelligence-option.active{background:var(--brand);color:#fff}
.intelligence-option[disabled]{opacity:0.5;cursor:not-allowed;background:transparent}
.intelligence-option[disabled]:hover{background:transparent}

/* Messages */
.msgs{overflow:auto;-webkit-overflow-scrolling:touch;min-height:0;background:#0a0c11;padding:16px;padding-bottom:88px}
:root.light .msgs{background:#f6f7fb}
.msg {
    max-width: 92%;
    padding: 12px 14px;
    border-radius: 16px;
    margin: 8px 0;
    border: 1px solid var(--stroke);
    line-height: 1.5;
    word-wrap: break-word;
    white-space: pre-wrap;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,"Tajawal",sans-serif;
    font-size: 14px;
    position: relative;
    -webkit-user-select: none;
    user-select: none;
}
.msg.user{margin-right:auto;background:var(--user-dark);color:#e9ecf1}
.msg.bot{margin-left:auto;background:var(--bot-dark);border-color:#283047}
:root.light .msg.user{background:var(--user-light);color:#fff}
:root.light .msg.bot{background:#fff;border-color:#dbe1ea;color:#0b1220}
.empty-hero{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:8px;color:#cfd6e6;text-align:center}
.empty-hero .name{font-size:24px;font-weight:900;color:#dbe5ff}
.empty-hero .sub{font-size:16px;color:#a7b1c6}
.logoMark{width:84px;height:84px}

/* Subscription Banner */
.subscription-banner{background:linear-gradient(135deg,#4a6bff,#6d83ff);color:white;padding:16px;border-radius:12px;margin:16px;text-align:center;border:1px solid #5a7bff}
.subscription-banner h3{margin:0 0 8px 0;font-size:18px}
.subscription-banner p{margin:0 0 12px 0;font-size:14px;opacity:0.9}
.subscription-banner .btn{background:white;color:#4a6bff;border:none;font-weight:700}

/* Math messages */
.msg.math{direction:ltr;text-align:left;max-width:98%}
.msg.math .mjx-container{font-size:10%}

/* Input row */
.inputRow{display:flex;gap:8px;padding:10px 12px;border-top:1px solid var(--stroke);background:#0e1016;position:sticky;bottom:0}
:root.light .inputRow{background:#ffffff}
.input{flex:1;height:48px;border-radius:22px;border:1px solid transparent;background:#0b0e16;color:var(--text);padding:0 14px;outline:none;-webkit-user-select:text;user-select:text;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Tajawal",sans-serif}
:root.light .input{background:#f8faff;color:#0b1220}
.send,.attach{width:52px;min-width:52px;border-radius:50%;border:1px solid var(--stroke)}
.send{background:var(--brand);color:#fff;font-weight:900}
.attach{background:#1d2330;color:#fff;font-size:22px;font-weight:900;line-height:48px}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± */
.attachment-container{position:relative;margin-bottom:8px}
.attachment-preview{position:relative;display:inline-block}
.attachment-preview img{max-width:200px;border-radius:12px;border:1px solid var(--stroke)}
.attach-chip {
    display: flex;
    align-items: center;
    gap: 10px;
    background: #161b26;
    border: 1px solid var(--stroke);
    border-radius: 14px;
    padding: 8px 12px;
    max-width: 65%;
}

.attach-chip .thumb{width:28px;height:28px;border-radius:6px;overflow:hidden;border:1px solid var(--stroke)}
.attach-chip .thumb img{width:100%;height:100%;object-fit:cover}
.attach-chip .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px}
.attach-chip .status {
    display: flex;
    flex-direction: column;
    gap: 2px;
    margin-inline-start: auto;
    text-align: left;
}

.attach-chip .size {
    font-size: 11px;
    color: var(--muted);
}

.attach-chip .x{margin-inline-start:auto;cursor:pointer;border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;border:1px solid var(--stroke)}
.attach-wrap{position:absolute;bottom:70px;right:14px}

.attachment-status.analyzing {
    background: #f39c12;
    color: white;
    padding: 2px 6px;
    border-radius: 6px;
    font-size: 11px;
}

.attachment-status.processing {
    background: #3498db;
    color: white;
    padding: 2px 6px;
    border-radius: 6px;
    font-size: 11px;
}

.attachment-status.ready {
    background: #27ae60;
    color: white;
    padding: 2px 6px;
    border-radius: 6px;
    font-size: 11px;
}

/* Ø²Ø± Ø§Ù„Ù†Ø³Ø® */
.copy-btn{position:absolute;top:8px;left:8px;background:rgba(0,0,0,0.7);color:white;border:none;border-radius:6px;padding:4px 8px;font-size:12px;cursor:pointer;opacity:0;transition:opacity 0.2s}
.msg:hover .copy-btn{opacity:1}

/* Pages */
.page{position:fixed;inset:0;background:var(--panel);display:none;z-index:40;padding:14px;border:1px solid var(--stroke);overflow:auto}
.page .head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.block{padding:10px;border-bottom:1px solid var(--stroke)}
.block .title{font-weight:800;margin-bottom:6px}

/* Subscription Plans */
.subscription-plans{display:flex;flex-direction:column;gap:12px;margin-top:16px}
.plan-card{background:var(--card);border:2px solid var(--stroke);border-radius:16px;padding:20px;text-align:center;transition:all 0.3s}
.plan-card.featured{border-color:var(--brand);background:linear-gradient(135deg,var(--card),#1a1f2e)}
.plan-card .price{font-size:28px;font-weight:900;color:var(--brand);margin:8px 0}
.plan-card .duration{color:var(--muted);font-size:14px;margin-bottom:12px}
.plan-card .features{text-align:right;margin:16px 0;font-size:14px}
.plan-card .feature{display:flex;align-items:center;gap:8px;margin:8px 0}
.plan-card .feature::before{content:"âœ“";color:var(--ok);font-weight:bold}
.plan-card .buy-btn{width:100%;background:var(--brand);color:#fff;border:none;border-radius:12px;padding:12px;font-weight:700;cursor:pointer;margin-top:8px}

/* Admin cards */
.cards{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.cardStat{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:14px}
.cardStat .name{font-weight:800;font-size:14px;color:var(--muted);margin-bottom:8px}
.cardStat .num{font-weight:900;font-size:26px}

/* AUTH (Home with 2 buttons) */
.auth{display:none;align-items:center;justify-content:center;position:fixed;inset:0}
.authCard{width:92%;max-width:420px;background:var(--panel);border:1px solid var(--stroke);border-radius:16px;padding:20px;text-align:center}
.authBtns{display:flex;flex-direction:column;gap:12px;margin-top:20px}
.logoRow{display:flex;flex-direction:column;align-items:center;gap:12px}
.brandName{font-weight:900;font-size:24px;background:linear-gradient(135deg,#4a6bff,#6d83ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.tosRow{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:12px;margin-top:8px;justify-content:center}

/* Paywall */
.paywall{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:60}
.paybox{width:92%;max-width:420px;background:var(--panel);border:1px solid var(--stroke);border-radius:14px;padding:16px;text-align:center}
.paybox .tg{display:inline-flex;align-items:center;gap:8px;background:#229ED9;border:1px solid #229ED9;color:#fff;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer;text-decoration:none}

a{color:#9eb6ff}

/* Mobile */
@media (max-width:900px){
  #root{grid-template-columns:0 1fr}
  .sidebar{transform:translateX(100%);transition:transform .25s}
  .sidebar.open{transform:translateX(0)}
  .subscription-plans{flex-direction:column}
  .plan-card{width:100%}
}

/* Theme Toggle */
.theme-toggle{display:none}
</style>
</head>
<body>

<div id="toast" class="toast"></div>

<!-- Boot Animation Ø¬Ø¯ÙŠØ¯ -->
<div id="boot">
  <svg class="boot-logo" viewBox="0 0 128 128" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="Logo">
    <defs>
      <linearGradient id="g" x1="0" y1="0" x2="128" y2="128">
        <stop stop-color="#6d83ff"/>
        <stop offset="1" stop-color="#3b57ff"/>
      </linearGradient>
    </defs>
    <path d="M16 46L64 26l48 20-48 20-48-20Z" fill="url(#g)"/>
    <path d="M32 58l32 14 32-14v14c0 10-14 18-32 18s-32-8-32-18V58Z" fill="#2a2f43"/>
    <circle cx="104" cy="73" r="6" fill="#4a6bff"/>
    <circle cx="42" cy="94" r="6" fill="#7ea0ff"/><circle cx="86" cy="94" r="6" fill="#7ea0ff"/>
    <path d="M42 94h44" stroke="#9fb3ff" stroke-width="3" stroke-linecap="round"/>
  </svg>
  
  <div class="boot-title">
    <span class="letter">Ø§</span>
    <span class="letter">Ù„</span>
    <span class="letter">Ù…</span>
    <span class="letter">Ø³</span>
    <span class="letter">Ø§</span>
    <span class="letter">Ø¹</span>
    <span class="letter">Ø¯</span>
    <span class="letter">&nbsp;</span>
    <span class="letter">Ù</span>
    <span class="letter">ÙŠ</span>
    <span class="letter">&nbsp;</span>
    <span class="letter">Ø§</span>
    <span class="letter">Ù„</span>
    <span class="letter">Ø³</span>
    <span class="letter">Ø§</span>
    <span class="letter">Ø¯</span>
    <span class="letter">Ø³</span>
  </div>
  
  <div class="boot-subtitle">Sixth Assistant</div>
  
  <div class="boot-loading">
    <div class="boot-progress">
      <div class="boot-progress-bar" id="bootProgress"></div>
    </div>
    <div class="boot-text" id="bootText">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨...</div>
  </div>
</div>

<!-- AUTH HOME -->
<section class="auth" id="auth">
  <div class="authCard">
    <div class="logoRow">
      <!-- Ø´Ø¹Ø§Ø± -->
      <svg class="logoMark" viewBox="0 0 128 128" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="Logo">
        <defs><linearGradient id="g" x1="0" y1="0" x2="128" y2="128"><stop stop-color="#6d83ff"/><stop offset="1" stop-color="#3b57ff"/></linearGradient></defs>
        <path d="M16 46L64 26l48 20-48 20-48-20Z" fill="url(#g)"/>
        <path d="M32 58l32 14 32-14v14c0 10-14 18-32 18s-32-8-32-18V58Z" fill="#2a2f43"/>
        <circle cx="104" cy="73" r="6" fill="#4a6bff"/>
        <circle cx="42" cy="94" r="6" fill="#7ea0ff"/><circle cx="86" cy="94" r="6" fill="#7ea0ff"/>
        <path d="M42 94h44" stroke="#9fb3ff" stroke-width="3" stroke-linecap="round"/>
      </svg>
      <div class="brandName">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ ÙÙŠ Ø§Ù„Ø³Ø§Ø¯Ø³</div>
      <div style="color:var(--muted);font-size:14px;margin-top:-8px">Sixth Assistant</div>
    </div>

    <div class="authBtns">
      <button class="btn primary" id="btnGoSignup">ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
      <button class="btn" id="btnGoPw">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </div>

    <label class="tosRow"><input type="checkbox" id="tos"> <span>Ø£ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ <a href="#" id="privacyLink">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</a></span></label>
    <div id="authError" style="color:var(--err);margin-top:6px;font-size:13px"></div>
  </div>
</section>

<!-- Password Login -->
<div class="page" id="pageLoginPw">
  <div class="head">
    <h3 style="margin:0">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
    <button class="btn flat" data-back>Ø±Ø¬ÙˆØ¹</button>
  </div>
  <div class="block">
    <input class="input" id="emailLogin" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" autocomplete="email" inputmode="email">
    <div style="height:8px"></div>
    <input class="input" id="passLogin" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" autocomplete="current-password">
    <div style="height:12px"></div>
    <button class="btn primary" id="loginBtn"><span id="loginTxt">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span><span id="loginSpin" class="hidden">â€¦ Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span></button>
    <div style="margin-top:8px"><a href="#" id="reset">Ù‡Ù„ Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ØŸ</a></div>
  </div>
</div>

<!-- Signup -->
<div class="page" id="pageSignup">
  <div class="head">
    <h3 style="margin:0">ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
    <button class="btn flat" data-back>Ø±Ø¬ÙˆØ¹</button>
  </div>
  <div class="block">
    <input class="input" id="emailSignup" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" autocomplete="email" inputmode="email">
    <div style="height:8px"></div>
    <input class="input" id="passSignup" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" autocomplete="new-password">
    <div style="height:8px"></div>
    <input class="input" id="passSignup2" type="password" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" autocomplete="new-password">
    <div style="height:12px"></div>
    <button class="btn primary" id="signupBtn"><span id="signupTxt">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</span><span id="signupSpin" class="hidden">â€¦ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨</span></button>
    <div id="signupMsg" style="margin-top:8px;color:var(--ok)"></div>
  </div>
</div>

<!-- Privacy Policy Page -->
<div class="page" id="pagePrivacy">
  <div class="head">
    <h3 style="margin:0">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</h3>
    <button class="btn flat" data-back>Ø±Ø¬ÙˆØ¹</button>
  </div>
  <div class="block">
    <div class="title">Ù…Ù‚Ø¯Ù…Ø©</div>
    <p>Ù†Ø­Ù† ÙÙŠ "Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ ÙÙŠ Ø§Ù„Ø³Ø§Ø¯Ø³" Ù†Ø­Ø±Øµ Ø¹Ù„Ù‰ Ø­Ù…Ø§ÙŠØ© Ø®ØµÙˆØµÙŠØªÙƒ ÙˆØ¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ©. Ù‡Ø°Ù‡ Ø§Ù„Ø³ÙŠØ§Ø³Ø© ØªÙˆØ¶Ø­ ÙƒÙŠÙÙŠØ© Ø¬Ù…Ø¹ ÙˆØ§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ­Ù…Ø§ÙŠØ© Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ.</p>
    
    <div class="title">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙŠ Ù†Ø¬Ù…Ø¹Ù‡Ø§</div>
    <p>â€¢ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨: Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙÙ‚Ø· Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©<br>
    â€¢ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª: Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª ÙˆØ§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø© Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙÙ‚Ø·<br>
    â€¢ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…: Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</p>
    
    <div class="title">ÙƒÙŠÙ Ù†Ø³ØªØ®Ø¯Ù… Ø¨ÙŠØ§Ù†Ø§ØªÙƒ</div>
    <p>â€¢ ØªÙ‚Ø¯ÙŠÙ… Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©<br>
    â€¢ ØªØ­Ø³ÙŠÙ† Ø¬ÙˆØ¯Ø© Ø§Ù„Ø®Ø¯Ù…Ø©<br>
    â€¢ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©<br>
    â€¢ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©</p>
    
    <div class="title">Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
    <p>â€¢ Ù†Ø³ØªØ®Ø¯Ù… ØªØ´ÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ù‚Ù„ ÙˆØ§Ù„ØªØ®Ø²ÙŠÙ†<br>
    â€¢ Ù†Ù„ØªØ²Ù… Ø¨Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©<br>
    â€¢ Ù„Ø§ Ù†Ø´Ø§Ø±Ùƒ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ø¹ Ø£Ø·Ø±Ø§Ù Ø«Ø§Ù„Ø«Ø©</p>
    
    <div class="title">Ø­Ù‚ÙˆÙ‚Ùƒ</div>
    <p>â€¢ Ø§Ù„Ø­Ù‚ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø¨ÙŠØ§Ù†Ø§ØªÙƒ<br>
    â€¢ Ø§Ù„Ø­Ù‚ ÙÙŠ ØªØµØ­ÙŠØ­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª<br>
    â€¢ Ø§Ù„Ø­Ù‚ ÙÙŠ Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ ÙˆØ¨ÙŠØ§Ù†Ø§ØªÙƒ<br>
    â€¢ Ø§Ù„Ø­Ù‚ ÙÙŠ Ø³Ø­Ø¨ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</p>
    
    <div class="title">Ø§ØªØµÙ„ Ø¨Ù†Ø§</div>
    <p>Ù„Ø£ÙŠ Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª Ø­ÙˆÙ„ Ø§Ù„Ø®ØµÙˆØµÙŠØ©ØŒ Ø±Ø§Ø³Ù„Ù†Ø§ Ø¹Ù„Ù‰: <a href="mailto:privacy@sixth-assistant.com">privacy@sixth-assistant.com</a></p>
  </div>
</div>

<!-- Delete Account Page -->
<div class="page" id="pageDeleteAccount">
  <div class="head">
    <h3 style="margin:0">Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
    <button class="btn flat" data-back>Ø±Ø¬ÙˆØ¹</button>
  </div>
  <div class="block">
    <div class="title">âš ï¸ ØªØ­Ø°ÙŠØ± Ù…Ù‡Ù…</div>
    <p>Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡. Ø³ÙŠØ¤Ø¯ÙŠ Ø¥Ù„Ù‰:</p>
    <ul style="color:var(--err);margin:10px 0;padding-right:20px">
      <li>Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ù…Ø­Ø§Ø¯Ø«Ø§ØªÙƒ Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù…</li>
      <li>Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©</li>
      <li>Ø­Ø°Ù Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø­Ø³Ø§Ø¨Ùƒ</li>
      <li>ÙÙ‚Ø¯Ø§Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø­Ø³Ø§Ø¨Ùƒ</li>
    </ul>
    
    <div style="margin:20px 0">
      <label style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
        <input type="checkbox" id="confirmDelete1">
        <span>Ø£ØªÙÙ‡Ù… Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡</span>
      </label>
      <label style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
        <input type="checkbox" id="confirmDelete2">
        <span>Ø£ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙŠ Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù…</span>
      </label>
      <label style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="confirmDelete3">
        <span>Ø£Ø¯Ø±Ùƒ Ø£Ù†Ù†ÙŠ Ø³Ø£ÙÙ‚Ø¯ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ù…Ø­Ø§Ø¯Ø«Ø§ØªÙŠ</span>
      </label>
    </div>
    
    <button class="btn" id="deleteAccountBtn" style="background:var(--err);color:white;border:none" disabled>Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù…</button>
    <div id="deleteMsg" style="margin-top:8px"></div>
  </div>
</div>

<!-- App -->
<section id="root">
  <div id="sideOverlay"></div>

  <aside class="sidebar" id="sidebar">
    <div class="side-head">
      <button class="toggle" id="closeSide" title="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
      <div id="subBadge" class="sub-badge">â€”</div>
    </div>
    <div class="list" id="chatList"></div>
    <div class="side-foot">
      <div class="small" id="userEmail">â€”</div>
      
      <button class="btn" id="subscriptionBtn" title="Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù…Ø¯ÙÙˆØ¹">ğŸ’ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù…Ø¯ÙÙˆØ¹</button>
      <button class="btn" id="themeToggleSidebar" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø³Ù…Ø©">Ù„ÙŠÙ„ÙŠ</button>
      
      <!-- Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
      <button class="btn" id="settingsBtn" title="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
      
      <button class="btn" id="adminBtn" title="Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…" style="display:none">ğŸ‘‘ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="left">
        <button class="toggle" id="openSide" title="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">â˜°</button>
      </div>
      
      <!-- Ù…Ø­Ø¯Ø¯ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø°ÙƒØ§Ø¡ ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ (ÙÙŠ Ø§Ù„ÙˆØ³Ø·) -->
      <div class="intelligence-selector" id="intelligenceSelector">
        <div class="intelligence-trigger" id="intelligenceTrigger">
          <span id="intelligenceDisplay">Ø°ÙƒØ§Ø¡ 50%</span>
          <span>â–¼</span>
        </div>
        <div class="intelligence-dropdown" id="intelligenceDropdown">
          <div class="intelligence-option" data-level="50">Ø°ÙƒØ§Ø¡ 50%</div>
          <div class="intelligence-option" data-level="100">Ø°ÙƒØ§Ø¡ 100%</div>
        </div>
      </div>
      
      <div class="right"><button class="btn primary" id="startChatTop">+ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©</button></div>
    </div>

    <div class="msgs" id="msgs"></div>

    <div class="inputRow" id="inputRow">
      <input class="input" id="input" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§â€¦" autocomplete="off" inputmode="text">
      <button class="attach" id="attach" title="Ø¥Ø¶Ø§ÙØ©">+</button>
      <button class="send" id="send">â¤</button>
      <input id="imgFile" type="file" class="hidden" accept="image/*">
      <div id="attachWrap" class="attach-wrap hidden"></div>
    </div>
  </main>
</section>

<!-- ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
<div class="page" id="pageSettings">
  <div class="head">
    <h3 style="margin:0">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
    <button class="btn flat" data-back>Ø±Ø¬ÙˆØ¹</button>
  </div>
  
  <div class="block">
    <div class="title">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</div>
    <div class="small" style="margin-bottom:12px" id="settingsUserEmail">â€”</div>
    
    <button class="btn" id="privacyBtn" style="width:100%;margin-bottom:8px">ğŸ“„ Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</button>
    <button class="btn" id="deleteAccountBtnSettings" style="width:100%;margin-bottom:8px;color:var(--err)">ğŸ—‘ï¸ Ø­Ø°Ù Ø­Ø³Ø§Ø¨ÙŠ</button>
    <button class="btn" id="logoutBtn" style="width:100%;color:var(--err)">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>
</div>

<!-- Subscription Plans Page -->
<div class="page" id="pageSubscription">
  <div class="head">
    <h3 style="margin:0">ğŸ’ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù…Ø¯ÙÙˆØ¹</h3>
    <button class="btn flat" data-back>Ø±Ø¬ÙˆØ¹</button>
  </div>
  
  <div class="block">
    <div class="title">Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø®Ø·Ø·</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
      <div style="text-align:center;padding:12px;background:var(--card);border-radius:12px">
        <h4 style="margin:0 0 8px 0">ğŸ†“ Ù…Ø¬Ø§Ù†ÙŠ</h4>
        <div style="font-size:12px;color:var(--muted)">Ù„Ù„Ø¨Ø¯Ø¡</div>
      </div>
      <div style="text-align:center;padding:12px;background:var(--brand);color:white;border-radius:12px">
        <h4 style="margin:0 0 8px 0">ğŸ’ Ù…Ù…ÙŠØ²</h4>
        <div style="font-size:12px;opacity:0.9">Ø§Ù„Ø£ÙØ¶Ù„</div>
      </div>
    </div>
    
    <div style="margin-top:16px">
      <div class="feature" style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--stroke)">
        <span>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</span>
        <div>
          <span style="color:var(--err)">3 ÙÙ‚Ø·</span>
          <span style="margin:0 8px">â†’</span>
          <span style="color:var(--ok)">ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯</span>
        </div>
      </div>
      <div class="feature" style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--stroke)">
        <span>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„ÙƒÙ„ Ù…Ø­Ø§Ø¯Ø«Ø©</span>
        <div>
          <span style="color:var(--err)">50 Ø±Ø³Ø§Ù„Ø©</span>
          <span style="margin:0 8px">â†’</span>
          <span style="color:var(--ok)">ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯</span>
        </div>
      </div>
      <div class="feature" style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--stroke)">
        <span>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø°ÙƒØ§Ø¡</span>
        <div>
          <span style="color:var(--err)">50% ÙÙ‚Ø·</span>
          <span style="margin:0 8px">â†’</span>
          <span style="color:var(--ok)">100% ÙƒØ§Ù…Ù„</span>
        </div>
      </div>
    </div>
  </div>

  <div class="block">
    <div class="title">Ø§Ø®ØªØ± Ø®Ø·ØªÙƒ Ø§Ù„Ù…ÙØ¶Ù„Ø©</div>
    <div class="subscription-plans">
      <div class="plan-card">
        <div class="price">$5</div>
        <div class="duration">10 Ø£ÙŠØ§Ù…</div>
        <div class="features">
          <div class="feature">Ù…Ø­Ø§Ø¯Ø«Ø§Øª ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯Ø©</div>
          <div class="feature">Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯Ø©</div>
          <div class="feature">Ø°ÙƒØ§Ø¡ 100% ÙƒØ§Ù…Ù„</div>
          <div class="feature">Ø¯Ø¹Ù… ÙÙˆØ±ÙŠ</div>
        </div>
        <button class="buy-btn" data-plan="5">Ø´Ø±Ø§Ø¡ Ù…Ù† Ù…ØªØ¬Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª</button>
      </div>
      
      <div class="plan-card featured">
        <div class="price">$10</div>
        <div class="duration">20 ÙŠÙˆÙ…</div>
        <div class="features">
          <div class="feature">Ù…Ø­Ø§Ø¯Ø«Ø§Øª ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯Ø©</div>
          <div class="feature">Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯Ø©</div>
          <div class="feature">Ø°ÙƒØ§Ø¡ 100% ÙƒØ§Ù…Ù„</div>
          <div class="feature">Ø¯Ø¹Ù… ÙÙˆØ±ÙŠ</div>
          <div class="feature">Ø§Ù„Ø£ÙƒØ«Ø± Ø´Ø¹Ø¨ÙŠØ©</div>
        </div>
        <button class="buy-btn" data-plan="10">Ø´Ø±Ø§Ø¡ Ù…Ù† Ù…ØªØ¬Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª</button>
      </div>
      
      <div class="plan-card">
        <div class="price">$15</div>
        <div class="duration">30 ÙŠÙˆÙ…</div>
        <div class="features">
          <div class="feature">Ù…Ø­Ø§Ø¯Ø«Ø§Øª ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯Ø©</div>
          <div class="feature">Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯Ø©</div>
          <div class="feature">Ø°ÙƒØ§Ø¡ 100% ÙƒØ§Ù…Ù„</div>
          <div class="feature">Ø¯Ø¹Ù… ÙÙˆØ±ÙŠ</div>
        </div>
        <button class="buy-btn" data-plan="15">Ø´Ø±Ø§Ø¡ Ù…Ù† Ù…ØªØ¬Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª</button>
      </div>
    </div>
  </div>
</div>

<!-- Admin Hub -->
<div class="page" id="pageHub">
  <div class="head"><h3 style="margin:0">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø§Ù„Ùƒ</h3><button class="btn" data-back>Ø±Ø¬ÙˆØ¹</button></div>
  <div class="hr" style="height:1px;background:var(--stroke);margin:10px 0"></div>
  <div class="block"><button class="btn" id="tileUsers">ğŸ‘¥ Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button></div>
  <div class="block"><button class="btn" id="tileSubs">â° Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</button></div>
  <div class="block"><button class="btn" id="tileTrain">ğŸ§  ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø°ÙƒØ§Ø¡</button></div>
</div>

<!-- Users page -->
<div class="page" id="pageUsers">
  <div class="head"><h3 style="margin:0">ğŸ‘¥ Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3><button class="btn" data-back>Ø±Ø¬ÙˆØ¹</button></div>
  <div class="hr" style="height:1px;background:var(--stroke);margin:10px 0"></div>
  <div class="cards">
    <div class="cardStat"><div class="name">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div><div class="num" id="statTotal">â€”</div></div>
    <div class="cardStat"><div class="name">Ø§Ù„Ù†Ø´Ø·ÙˆÙ† Ø§Ù„Ø¢Ù†</div><div class="num" id="statActiveNow">â€”</div></div>
    <div class="cardStat"><div class="name">Ù…Ø³ØªØ®Ø¯Ù…Ùˆ Ø§Ù„ÙŠÙˆÙ…</div><div class="num" id="statUsersToday">â€”</div></div>
    <div class="cardStat"><div class="name">Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙŠÙˆÙ…</div><div class="num" id="statMsgsToday">â€”</div></div>
  </div>
</div>

<!-- Subs page -->
<div class="page" id="pageSubs">
  <div class="head"><h3 style="margin:0">â° Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</h3><button class="btn" data-back>Ø±Ø¬ÙˆØ¹</button></div>
  <div class="hr" style="height:1px;background:var(--stroke);margin:10px 0"></div>

  <div class="block">
    <div class="title">â• Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ø¯ÙÙˆØ¹</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <input class="input" id="subEmail" placeholder="Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
      <select class="input" id="subPlan" style="width:140px">
        <option value="5">10 Ø£ÙŠØ§Ù… - $5</option>
        <option value="10">20 ÙŠÙˆÙ… - $10</option>
        <option value="15">30 ÙŠÙˆÙ… - $15</option>
      </select>
      <button class="btn primary" id="addSubscription">ØªÙ†ÙÙŠØ°</button>
    </div>
    <div id="subMsg" style="margin-top:8px;color:var(--ok)"></div>
  </div>

  <div class="block">
    <div class="title">ğŸ›‘ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙˆØ±Ù‹Ø§</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <input class="input" id="cancelEmail" placeholder="Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
      <button class="btn" id="cancelSub">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</button>
    </div>
    <div id="cancelMsg" style="margin-top:8px;color:var(--ok)"></div>
  </div>
</div>

<!-- Train page -->
<div class="page" id="pageTrain">
  <div class="head"><h3 style="margin:0">ğŸ§  ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø°ÙƒØ§Ø¡</h3><button class="btn" data-back>Ø±Ø¬ÙˆØ¹</button></div>
  <div class="hr" style="height:1px;background:var(--stroke);margin:10px 0"></div>
  
  <div class="block">
    <div class="title">âš™ï¸ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù†Ø¸Ø§Ù… (Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù…Ù†Ø¹/Ø§Ù„Ø³Ù…Ø§Ø­)</div>
    <textarea class="input" style="min-height:140px" id="trainRule" placeholder="Ø§ÙƒØªØ¨ Ø£ÙˆØ§Ù…Ø±/Ù‚ÙˆØ§Ø¹Ø¯ Ù„Ù„Ù†Ø¸Ø§Ù…â€¦"></textarea>
    <div style="height:8px"></div>
    <button class="btn primary" id="saveRule">Ø­ÙØ¸ Ø§Ù„Ø£ÙˆØ§Ù…Ø± (Ù‚ÙˆØ§Ø¹Ø¯)</button>
    <div id="ruleMsg" style="margin-top:8px;color:var(--ok)"></div>
  </div>
  
  <div class="block">
    <div class="title">ğŸ“ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</div>
    <textarea class="input" style="min-height:140px" id="trainInfoText" placeholder="Ø£Ø¶Ù Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙˆÙ…Ø¹Ø§Ø±Ù ÙŠØ±Ø¯Ù‘ Ø¨Ù‡Ø§ Ø§Ù„Ø°ÙƒØ§Ø¡â€¦"></textarea>
    <div style="height:8px"></div>
    <button class="btn primary" id="saveInfo">Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</button>
    <div id="infoMsg" style="margin-top:8px;color:var(--ok)"></div>
  </div>
  
  <div class="block">
    <div class="title">ğŸ“š Ø¥Ø¶Ø§ÙØ© Ù…Ù„ÙØ§Øª PDF</div>
    <input type="file" id="pdfInput" accept=".pdf" multiple class="hidden">
    <div style="display:flex; gap:8px; flex-wrap:wrap">
      <button class="btn" id="pickPdf">Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„ÙØ§Øª PDF</button>
      <button class="btn primary" id="processPdfs">Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„ÙØ§Øª</button>
    </div>
    <div style="height:8px"></div>
    <div id="fileList"></div>
    <div style="height:10px"></div>
    <div style="height:8px;background:#0b0f18;border:1px solid var(--stroke);border-radius:6px;overflow:hidden">
      <div class="bar" id="pdfBar" style="height:100%;background:var(--brand);width:0%"></div>
    </div>
    <div id="trainInfo" style="margin-top:8px;color:var(--muted);font-size:13px;white-space:pre-wrap"></div>
  </div>
</div>

<!-- Paywall -->
<div class="paywall" id="paywall">
  <div class="paybox">
    <h3 style="margin:0 0 6px 0">Ø§Ù†ØªÙ‡Øª ØªØ¬Ø±Ø¨ØªÙƒ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©</h3>
    <p>Ù„Ù‚Ø¯ Ø§Ø³ØªÙ‡Ù„ÙƒØª Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡ ÙÙŠ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©.</p>
    <div style="margin:12px 0;padding:12px;background:#f8f9fa;border-radius:8px;text-align:right">
      <div>ğŸ“Š Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: <span id="usedChats">0</span>/3 Ù…Ø­Ø§Ø¯Ø«Ø§Øª</div>
      <div>ğŸ’¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„: <span id="usedMessages">0</span>/50 Ø±Ø³Ø§Ù„Ø©</div>
    </div>
    <button class="btn primary" onclick="openPage('#pageSubscription')">ğŸ’ ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø¢Ù†</button>
    <div class="hr" style="height:1px;background:var(--stroke);margin:12px 0"></div>
    <button class="btn" id="closePaywall">Ø­Ø³Ù†Ù‹Ø§</button>
  </div>
</div>

<script>
/* ===== Ø£Ø¯ÙˆØ§Øª Ø¹Ø§Ù…Ø© ===== */
const $=(s)=>document.querySelector(s);
const saveLocal=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v));}catch{}};
const loadLocal=(k,d=null)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d;}catch{return d;}};
const SAFE_TOKENS=/[^\sA-Za-z0-9\u0600-\u06FF\u2070-\u209F\u2190-\u21FF\u2200-\u22FF\u00B0\u03A0-\u03FF\(\)\[\]\{\}\+\-\*\/=<>^_%.,:;|\\~âˆšâˆ‘âˆ†Â±Â°Î¼Ï€Î©Î±Î²Î³Î´ÎµÎ¶Î·Î¸Î¹ÎºÎ»Î¼Î½Î¾Î¿Ï€ÏÏƒÏ„Ï…Ï†Ï‡ÏˆÏ‰Ã—Ã·â€°â‚â‚‚â‚ƒâ‚„â‚…â‚†â‚‡â‚ˆâ‚‰]/g;
const toast=(t)=>{const el=document.getElementById('toast');el.textContent=t;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),1800)}

const ADMIN_EMAIL="mslmalmyaly223@gmail.com";
const firebaseConfig={apiKey:"AIzaSyD915Zh1Gzl60Z9Y5SBlls1S4tedgzU6hE",authDomain:"student-market-5940e.firebaseapp.com",projectId:"student-market-5940e",storageBucket:"student-market-5940e.appspot.com"};
const AI_ENDPOINT = "https://api.deepseek.com/v1/chat/completions";
const AI_KEY = "sk-ff429bca45194b3c87dacda66d63bfb5";

let THEME=loadLocal("THEME","dark");
let USER_INTELLIGENCE_LEVEL=loadLocal("USER_INTELLIGENCE_LEVEL",50);

function applyTheme(){ 
    if(THEME==="light") {
        document.documentElement.classList.add("light");
        $("#themeToggleSidebar").textContent="Ù†Ù‡Ø§Ø±ÙŠ";
    } else {
        document.documentElement.classList.remove("light");
        $("#themeToggleSidebar").textContent="Ù„ÙŠÙ„ÙŠ";
    } 
}

/* ===== Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ù…Ø­Ø³Ù† ===== */
function setupIntelligenceSelector() {
    const trigger = $("#intelligenceTrigger");
    const dropdown = $("#intelligenceDropdown");
    const display = $("#intelligenceDisplay");
    
    function updateDisplay() {
        display.textContent = `Ø°ÙƒØ§Ø¡ ${USER_INTELLIGENCE_LEVEL}%`;
    }
    
    function updateOptions() {
        const options = dropdown.querySelectorAll('.intelligence-option');
        options.forEach(option => {
            const level = parseInt(option.dataset.level);
            option.classList.toggle('active', level === USER_INTELLIGENCE_LEVEL);
            
            if (level === 100 && !canUseFullIntelligence()) {
                option.setAttribute('disabled', 'true');
                option.title = "ÙŠØªØ·Ù„Ø¨ Ø§Ø´ØªØ±Ø§ÙƒÙ‹Ø§ Ù…Ø¯ÙÙˆØ¹Ù‹Ø§";
            } else {
                option.removeAttribute('disabled');
                option.title = "";
            }
        });
    }
    
    trigger.onclick = (e) => {
        e.stopPropagation();
        dropdown.classList.toggle('show');
    };
    
    dropdown.querySelectorAll('.intelligence-option').forEach(option => {
        option.onclick = (e) => {
            e.stopPropagation();
            const level = parseInt(option.dataset.level);
            
            if (level === 100 && !canUseFullIntelligence()) {
                toast("ÙŠØªØ·Ù„Ø¨ Ø§Ø´ØªØ±Ø§ÙƒÙ‹Ø§ Ù…Ø¯ÙÙˆØ¹Ù‹Ø§ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ÙƒØ§Ù…Ù„");
                return;
            }
            
            USER_INTELLIGENCE_LEVEL = level;
            saveLocal("USER_INTELLIGENCE_LEVEL", USER_INTELLIGENCE_LEVEL);
            updateDisplay();
            updateOptions();
            dropdown.classList.remove('show');
            toast(`ØªÙ… ØªØºÙŠÙŠØ± Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø¥Ù„Ù‰ ${level}%`);
        };
    });
    
    document.addEventListener('click', () => {
        dropdown.classList.remove('show');
    });
    
    updateDisplay();
    updateOptions();
}

function canUseFullIntelligence() {
    return userProfileCache?.subscribed === true;
}

// ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø³Ù…Ø©
$("#themeToggleSidebar").onclick = () => {
    THEME = THEME === "dark" ? "light" : "dark";
    saveLocal("THEME", THEME);
    applyTheme();
    closeSidebar();
};

$("#openSide")?.addEventListener("click",()=>{ $("#sidebar").classList.add("open"); $("#sideOverlay").style.display="block"; });
$("#closeSide")?.addEventListener("click",closeSidebar);
$("#sideOverlay")?.addEventListener("click",closeSidebar);
function closeSidebar(){ $("#sidebar").classList.remove("open"); $("#sideOverlay").style.display="none"; }

/* Firebase */
try {
    firebase.initializeApp(firebaseConfig);
} catch (error) {
    if (!/already exists/.test(error.message)) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Firebase:', error);
    }
}
const auth=firebase.auth(), db=firebase.firestore();
try{auth.useDeviceLanguage();}catch{}
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});

/* Boot/App/Auth */
const boot=$("#boot"), app=$("#root"), authView=$("#auth");
function showBoot(){ boot.style.display="flex"; app.style.display="none"; authView.style.display="none"; }
function showApp(){ boot.style.display="none"; app.style.display="grid"; authView.style.display="none"; }
function showAuth(){ boot.style.display="none"; app.style.display="none"; authView.style.display="flex"; }
showBoot();

// Ù…Ø­Ø§ÙƒØ§Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø¹ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
function simulateBootProgress() {
    let progress = 0;
    const progressBar = $("#bootProgress");
    const bootText = $("#bootText");
    const messages = [
        "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨...",
        "Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...", 
        "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª...",
        "Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…!"
    ];
    
    const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 100) progress = 100;
        
        progressBar.style.width = progress + "%";
        
        if (progress < 30) {
            bootText.textContent = messages[0];
        } else if (progress < 60) {
            bootText.textContent = messages[1];
        } else if (progress < 90) {
            bootText.textContent = messages[2];
        } else {
            bootText.textContent = messages[3];
        }
        
        if (progress >= 100) {
            clearInterval(interval);
        }
    }, 300);
}

// Ø¨Ø¯Ø¡ Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
setTimeout(simulateBootProgress, 1000);

/* Ø­Ø§Ù„Ø© Ø¹Ø§Ù…Ø© */
let me=null,currentChatId=null,canChat=true;
let index=null,knowledgeChunks=[],rulesMemo="";
const msgs=$("#msgs"),input=$("#input"),inputRow=$("#inputRow");
let pageStack=[];
let attachedImage=null;
let attachToken=0;
const attachWrap=$("#attachWrap");
const ENABLE_OCR=true;

// ØªØ®Ø²ÙŠÙ† ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
let currentChatHistory = [];

// Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
let userUsage = {
    chatCount: 0,
    messageCount: 0,
    maxChats: 3,
    maxMessagesPerChat: 50
};

/* ===== Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªØ±ÙƒÙŠØ²/Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„ ===== */
function scrollIntoViewIfNeeded(el){ 
    try{ 
        el.scrollIntoView({block:"nearest", behavior:"smooth"}); 
    }catch{} 
}

// Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙ…Ø±ÙŠØ± - Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø®Ù„Ù
msgs.addEventListener('scroll', function() {
    // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ
});

// Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
["focusin","click","touchend"].forEach(ev=>{
    document.addEventListener(ev,(e)=>{
        const t=e.target;
        if(t && (t.tagName==="INPUT"||t.tagName==="TEXTAREA")) {
            setTimeout(()=>{
                if(document.activeElement === t) {
                    scrollIntoViewIfNeeded(t);
                }
            },100);
        }
    },{passive:true});
});

// Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ - Ù„Ø§ ÙŠØ³Ø±Ù‚ Ø§Ù„ØªØ±ÙƒÙŠØ²
msgs.addEventListener("click",(e)=>{
    if(e.target.classList.contains('msg')) {
        setTimeout(() => input.focus(), 50);
    }
},{passive:true});

let streamingEl=null, streamedText="";
let isStreaming=false;
let currentStream={id:null,chatId:null,controller:null};
function cancelCurrentStream(){
    if(currentStream.controller){ try{ currentStream.controller.abort(); }catch{} }
    currentStream={id:null,chatId:null,controller:null};
    isStreaming=false; streamingEl=null; streamedText="";
}

/* Ø¶Ø¨Ø· Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
function adjustMsgsPadding(){ const h=inputRow.getBoundingClientRect().height; msgs.style.paddingBottom=(h+16)+"px"; }
new ResizeObserver(adjustMsgsPadding).observe(inputRow);

/* ===== Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ===== */
let userProfileCache=null,timerId=null;
function watchUserProfileCountdown(){
    return db.collection("users").doc(me.uid).onSnapshot(async (s)=>{
        userProfileCache=s.data()||{};
        await loadUserUsage();
        renderUsageBadge();
        setupIntelligenceSelector();
        if(timerId) clearInterval(timerId);
        timerId=setInterval(renderUsageBadge,1000);
    });
}

async function loadUserUsage() {
    try {
        const chatsSnap = await db.collection("chats")
            .where("uid", "==", me.uid)
            .get();
        
        userUsage.chatCount = chatsSnap.size;
        
        if (currentChatId) {
            const messagesSnap = await db.collection("chats")
                .doc(currentChatId)
                .collection("messages")
                .get();
            
            userUsage.messageCount = messagesSnap.size;
        } else {
            userUsage.messageCount = 0;
        }
        
    } catch (error) {
        console.error('Error loading user usage:', error);
    }
}

function renderUsageBadge(){
    try{
        const p=userProfileCache||{};
        
        if (p.blocked === true) {
            $("#subBadge").textContent="ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ø´ØªØ±Ø§ÙƒÙƒ";
            canChat=false; 
            return;
        }

        const canCreateMoreChats = userUsage.chatCount < userUsage.maxChats;
        const canSendMoreMessages = userUsage.messageCount < userUsage.maxMessagesPerChat;
        
        canChat = p.subscribed === true || (canCreateMoreChats && canSendMoreMessages);
        
        if (p.subscribed) {
            const subEnd = p.subscriptionEnd?.toDate ? p.subscriptionEnd.toDate() : null;
            if (subEnd) {
                const now = new Date();
                const left = subEnd - now;
                if (left <= 0) {
                    $("#subBadge").textContent = "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ";
                    canChat = false;
                    return;
                }
                const days = Math.floor(left / (24 * 60 * 60 * 1000));
                $("#subBadge").textContent = `Ø§Ø´ØªØ±Ø§Ùƒ ${days} ÙŠÙˆÙ…`;
            } else {
                $("#subBadge").textContent = "Ù…Ø´ØªØ±Ùƒ ğŸ’";
            }
        } else {
            const remainingChats = userUsage.maxChats - userUsage.chatCount;
            const remainingMessages = userUsage.maxMessagesPerChat - userUsage.messageCount;
            
            $("#subBadge").textContent = `${remainingChats} Ù…Ø­Ø§Ø¯Ø«Ø© - ${remainingMessages} Ø±Ø³Ø§Ù„Ø©`;
        }
        
    } catch{ 
        $("#subBadge").textContent="â€”"; 
    }
}

function showPaywall() {
    $("#usedChats").textContent = userUsage.chatCount;
    $("#usedMessages").textContent = userUsage.messageCount;
    $("#paywall").style.display = "flex";
}

$("#closePaywall").onclick=()=>$("#paywall").style.display="none";

/* ===== Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ ===== */
$("#settingsBtn").onclick = () => {
    openPage("#pageSettings");
    closeSidebar();
};

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
function updateSettingsEmail() {
    if (me && me.email) {
        $("#settingsUserEmail").textContent = me.email;
    }
}

// Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø²Ø±Ø§Ø± ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
$("#privacyBtn").onclick = () => {
    openPage("#pagePrivacy");
};

$("#deleteAccountBtnSettings").onclick = () => {
    openPage("#pageDeleteAccount");
};

$("#logoutBtn").onclick = () => {
    if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {
        auth.signOut();
    }
};

/* ===== Ø¥Ø¯Ø§Ø±Ø© Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ ===== */
function setupDeleteAccount() {
    const checkboxes = [
        $("#confirmDelete1"),
        $("#confirmDelete2"), 
        $("#confirmDelete3")
    ];
    
    const deleteBtn = $("#deleteAccountBtn");
    
    function updateDeleteButton() {
        const allChecked = checkboxes.every(cb => cb.checked);
        deleteBtn.disabled = !allChecked;
    }
    
    checkboxes.forEach(cb => {
        cb.onchange = updateDeleteButton;
    });
    
    deleteBtn.onclick = async () => {
        if (!deleteBtn.disabled) {
            if (confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ ÙˆØ¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù…ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!")) {
                await deleteUserAccount();
            }
        }
    };
}

async function deleteUserAccount() {
    const deleteBtn = $("#deleteAccountBtn");
    const deleteMsg = $("#deleteMsg");
    
    try {
        deleteBtn.disabled = true;
        deleteBtn.textContent = "Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";
        deleteMsg.textContent = "Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ ÙˆØ¨ÙŠØ§Ù†Ø§ØªÙƒ...";
        deleteMsg.style.color = "var(--muted)";
        
        const chatsSnap = await db.collection("chats").where("uid", "==", me.uid).get();
        const deletePromises = [];
        
        for (const chatDoc of chatsSnap.docs) {
            const messagesSnap = await chatDoc.ref.collection("messages").get();
            messagesSnap.forEach(msgDoc => {
                deletePromises.push(msgDoc.ref.delete());
            });
            deletePromises.push(chatDoc.ref.delete());
        }
        
        deletePromises.push(db.collection("users").doc(me.uid).delete());
        
        await Promise.all(deletePromises);
        
        await me.delete();
        
        deleteMsg.textContent = "âœ… ØªÙ… Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ ÙˆØ¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­";
        deleteMsg.style.color = "var(--ok)";
        
        toast("ØªÙ… Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ ÙˆØ¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­");
        setTimeout(() => {
            auth.signOut();
        }, 2000);
        
    } catch (error) {
        console.error('Error deleting account:', error);
        deleteMsg.textContent = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨: " + error.message;
        deleteMsg.style.color = "var(--err)";
        deleteBtn.disabled = false;
        deleteBtn.textContent = "Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù…";
    }
}

/* ===== Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù…Ø¹ Ù…ØªØ¬Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª ===== */
document.querySelectorAll(".buy-btn").forEach(btn => {
    btn.onclick = async () => {
        const plan = btn.dataset.plan;
        const planPrices = {
            "5": { price: "$5", days: 10 },
            "10": { price: "$10", days: 20 }, 
            "15": { price: "$15", days: 30 }
        };
        
        const selectedPlan = planPrices[plan];
        
        try {
            if (window.Android && window.Android.purchaseSubscription) {
                window.Android.purchaseSubscription(plan, selectedPlan.price, selectedPlan.days);
            } else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.purchaseSubscription) {
                window.webkit.messageHandlers.purchaseSubscription.postMessage({
                    plan: plan,
                    price: selectedPlan.price,
                    days: selectedPlan.days
                });
            } else {
                const playStoreUrl = `https://play.google.com/store/apps/details?id=com.your.app&referrer=subscription_plan_${plan}`;
                window.open(playStoreUrl, '_blank');
            }
            
            toast(`Ø¬Ø§Ø±ÙŠ ÙØªØ­ Ù…ØªØ¬Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ ${selectedPlan.price}`);
            
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ Ù…ØªØ¬Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª:', error);
            toast('Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ Ù…ØªØ¬Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª');
        }
    };
});

// Ø¥Ø¶Ø§ÙØ© Ø¯Ø§Ù„Ø© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø´Ø±Ø§Ø¡
window.handlePurchaseResult = function(success, planId) {
    if (success) {
        toast('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ù†Ø¬Ø§Ø­!');
        setTimeout(() => {
            location.reload();
        }, 2000);
    } else {
        toast('âŒ ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡');
    }
};

/* ===== Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø­Ø³Ù† (Ø¨Ø¯ÙˆÙ† Google) ===== */
function mustAcceptTOS(){ return $("#tos").checked; }
function showErr(t){ $("#authError").textContent=t; setTimeout(()=>$("#authError").textContent="",5000); }

// ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„
$("#btnGoPw").onclick   =()=>{ if(!mustAcceptTOS()) return showErr("ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ· Ø£ÙˆÙ„Ø§Ù‹."); openPage("#pageLoginPw"); };
$("#btnGoSignup").onclick=()=>{ if(!mustAcceptTOS()) return showErr("ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ· Ø£ÙˆÙ„Ø§Ù‹."); openPage("#pageSignup"); };

// Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø· Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©
$("#privacyLink").onclick = (e) => {
    e.preventDefault();
    openPage("#pagePrivacy");
};

/* Password Login */
$("#loginBtn").onclick=async ()=>{
    const email=$("#emailLogin").value.trim(), pass=$("#passLogin").value.trim();
    if(!email||!pass) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±.");
    const btn=$("#loginBtn"), txt=$("#loginTxt"), spin=$("#loginSpin");
    btn.disabled=true; txt.classList.add("hidden"); spin.classList.remove("hidden");
    try{
        await auth.signInWithEmailAndPassword(email, pass);
    }catch(e){
        alert(e.message);
        btn.disabled=false; txt.classList.remove("hidden"); spin.classList.add("hidden");
    }
};

/* Reset password */
$("#reset").onclick=async (e)=>{
    e.preventDefault();
    const email=prompt("Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ:");
    if(email){ try{ await auth.sendPasswordResetEmail(email); alert("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„."); }catch(err){ alert(err.message);} }
};

/* Signup */
$("#signupBtn").onclick=async ()=>{
    const email=$("#emailSignup").value.trim();
    const p1=$("#passSignup").value.trim();
    const p2=$("#passSignup2").value.trim();
    if(!email||!p1||!p2) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.");
    if(p1!==p2) return alert("ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ø³Ø± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†.");
    const btn=$("#signupBtn"), txt=$("#signupTxt"), spin=$("#signupSpin");
    btn.disabled=true; txt.classList.add("hidden"); spin.classList.remove("hidden");
    try{
        await auth.createUserWithEmailAndPassword(email,p1);
        $("#signupMsg").textContent="ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨";
    }catch(e){ alert(e.message); }
    btn.disabled=false; txt.classList.remove("hidden"); spin.classList.add("hidden");
};

/* onAuthStateChanged */
let initStarted=false, unsubProfile=null, unSubMsgs=null;
let CHAT_CACHE = loadLocal("CHAT_CACHE", []);

auth.onAuthStateChanged(async (u)=>{
    if(u){
        me=u;
        $("#userEmail").textContent=u.email||"";
        $("#settingsUserEmail").textContent=u.email||"";
        $("#adminBtn").style.display=(me?.email===ADMIN_EMAIL)?"block":"none";
        
        document.querySelectorAll(".page").forEach(p=>p.style.display="none");
        pageStack = [];
        
        fastAfterAuth();
    }else{
        showAuth();
    }
});

function fastAfterAuth(note){
    try{
        applyTheme(); adjustMsgsPadding(); showApp();
        setupIntelligenceSelector();
        setupDeleteAccount();
        updateSettingsEmail();
        if(note) toast(note);
        if(!initStarted){ 
            initStarted=true; 
            setTimeout(() => initApp(), 100);
        }
    }catch(e){console.error('fastAfterAuth error:', e)}
}

async function initApp(){
    try{
        console.log('Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...');
        await ensureUserDoc();
        console.log('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
        
        unsubProfile = watchUserProfileCountdown();
        console.log('ØªÙ… Ø±Ø¨Ø· Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
        
        bindChatList();
        console.log('ØªÙ… Ø±Ø¨Ø· Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª');
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø±ÙØ© ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
        setTimeout(() => loadKnowledgeFromDB().catch(()=>{}), 500);
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        await newChat();
        console.log('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©');
        
    }catch(e){
        console.error('Ø®Ø·Ø£ ÙÙŠ initApp:', e);
        toast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚');
    }
}

/* Ø¥Ù†Ø´Ø§Ø¡/ØªØ­Ø¯ÙŠØ« Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
async function ensureUserDoc(){
    try {
        const ref=db.collection("users").doc(me.uid);
        const userDoc = await ref.get();
        
        if (!userDoc.exists) {
            await ref.set({
                email: me.email||null,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                trialStart: firebase.firestore.FieldValue.serverTimestamp(),
                subscribed: false,
                subscriptionEnd: null,
                blocked: false,
                lastActive: firebase.firestore.FieldValue.serverTimestamp()
            });
        } else {
            await ref.update({
                lastActive: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
    } catch (error) {
        console.error('Error in ensureUserDoc:', error);
        throw error;
    }
}

/* ===== Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ù…Ø­Ø³Ù†Ø© ===== */
function cacheSet(list){ CHAT_CACHE=list; saveLocal("CHAT_CACHE", list); }

function insertChatRowDom(id, title){
    const list=$("#chatList");
    if(list.querySelector(`.item[data-id="${id}"]`)) return;
    const row=document.createElement("div");
    row.className="item"+(id===currentChatId?" active":"");
    row.dataset.id=id;

    const t=document.createElement("div"); t.className="item-title"; t.textContent=title||"â€”";
    const ops=document.createElement("div"); ops.className="item-ops";

    const edit=document.createElement("button"); edit.className="btn"; edit.textContent="âœï¸";
    edit.onclick=async (e)=>{
        e.stopPropagation();
        const nt=prompt("Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯:", (t.textContent||"").trim() || "Ù…Ø­Ø§Ø¯Ø«Ø©");
        if(nt && nt!==t.textContent){
            t.textContent = nt;
            try{ await db.collection("chats").doc(id).update({title:nt, clientUpdated:Date.now(), updatedAt:firebase.firestore.FieldValue.serverTimestamp()}); }catch{}
            const arr = [{id, title:nt}, ...CHAT_CACHE.filter(x=>x.id!==id)];
            cacheSet(arr);
        }
    };
    const del=document.createElement("button"); del.className="btn"; del.textContent="ğŸ—‘ï¸";
    del.onclick=async (e)=>{ e.stopPropagation(); if(confirm("Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©ØŸ")) await deleteChat(id); };

    ops.appendChild(edit); ops.appendChild(del);
    row.appendChild(t); row.appendChild(ops);
    row.onclick=()=>{ loadChat(id); closeSidebar(); };
    list.prepend(row);
}

function bindChatList(){
    $("#chatList").innerHTML="";
    CHAT_CACHE.forEach(c=>insertChatRowDom(c.id, c.title));

    db.collection("chats").where("uid","==",me.uid).orderBy("clientUpdated","desc")
        .onSnapshot(snap=>{
            const list=$("#chatList"); 
            const arr=[];
            snap.forEach(doc=>{
                const c=doc.data(); const id=doc.id;
                arr.push({id, title:c.title||"Ù…Ø­Ø§Ø¯Ø«Ø©"});
                insertChatRowDom(id, c.title||"Ù…Ø­Ø§Ø¯Ø«Ø©");
            });
            cacheSet(arr);
            setActiveChatItem(currentChatId);
        }, ()=>{
            if($("#chatList").children.length===0){
                CHAT_CACHE.forEach(c=>insertChatRowDom(c.id, c.title));
            }
        });
}

// Ø¥ØµÙ„Ø§Ø­ Ø²Ø± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
$("#startChatTop").onclick = async () => {
    if (!canChat) {
        showPaywall();
        return;
    }
    
    if (userUsage.chatCount >= userUsage.maxChats && !userProfileCache?.subscribed) {
        toast("Ù„Ù‚Ø¯ ÙˆØµÙ„Øª Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©");
        showPaywall();
        return;
    }
    
    await newChat();
};

function setActiveChatItem(id){
    document.querySelectorAll("#chatList .item").forEach(x=>x.classList.toggle("active", x.dataset.id===id));
}

async function newChat(){
    try {
        cancelCurrentStream();
        currentChatHistory = [];
        
        const ref=await db.collection("chats").add({
            uid:me.uid, 
            title:"Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©",
            clientUpdated: Date.now(),
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        currentChatId=ref.id;
        insertChatRowDom(ref.id, "Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©");
        const arr=[{id:ref.id, title:"Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©"}, ...CHAT_CACHE.filter(x=>x.id!==ref.id)];
        cacheSet(arr);
        setActiveChatItem(ref.id);
        loadChat(ref.id);
        
        // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
        userUsage.chatCount++;
        renderUsageBadge();
        
        return ref.id;
    } catch (error) {
        console.error('Error creating new chat:', error);
        toast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©');
        throw error;
    }
}

async function deleteChat(id){
    try{
        if(unSubMsgs && currentChatId===id){ unSubMsgs(); unSubMsgs=null; }
        const row=document.querySelector(`#chatList .item[data-id="${id}"]`); if(row) row.remove();
        cacheSet(CHAT_CACHE.filter(x=>x.id!==id));

        const ref=db.collection("chats").doc(id);
        const msgsSnap=await ref.collection("messages").get();
        const batch=db.batch(); msgsSnap.forEach(d=>batch.delete(ref.collection("messages").doc(d.id))); await batch.commit();
        await ref.delete();

        if(currentChatId===id){
            currentChatId=null; 
            currentChatHistory = [];
            msgs.innerHTML="";
            if(CHAT_CACHE[0]) loadChat(CHAT_CACHE[0].id);
            else await newChat();
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
        userUsage.chatCount = Math.max(0, userUsage.chatCount - 1);
        renderUsageBadge();
        
    }catch(e){ alert(e.message||e); }
}

/* Ø­Ø§Ù„Ø© Ù…Ø­Ø§Ø¯Ø«Ø© ÙØ§Ø±ØºØ© */
function renderEmptyHero(){
    msgs.innerHTML="";
    const wrap=document.createElement("div");
    wrap.className="empty-hero";
    
    if (!canChat || (userUsage.chatCount >= userUsage.maxChats && !userProfileCache?.subscribed)) {
        const banner = document.createElement("div");
        banner.className = "subscription-banner";
        banner.innerHTML = `
            <h3>Ø§Ù†ØªÙ‡Øª ØªØ¬Ø±Ø¨ØªÙƒ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©</h3>
            <p>Ù„Ù‚Ø¯ Ø§Ø³ØªÙ‡Ù„ÙƒØª Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡ ÙÙŠ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©</p>
            <div style="margin:12px 0;text-align:right">
                <div>ğŸ“Š Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${userUsage.chatCount}/3 Ù…Ø­Ø§Ø¯Ø«Ø§Øª</div>
                <div>ğŸ’¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„: ${userUsage.messageCount}/50 Ø±Ø³Ø§Ù„Ø©</div>
            </div>
            <button class="btn" onclick="openPage('#pageSubscription')">ğŸ’ ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø¢Ù†</button>
        `;
        wrap.appendChild(banner);
    } else {
        wrap.innerHTML=`
            <svg class="logoMark" viewBox="0 0 128 128" fill="none" xmlns="http://www.w3.org/2000/svg">
                <defs><linearGradient id="gh" x1="0" y1="0" x2="128" y2="128"><stop stop-color="#6d83ff"/><stop offset="1" stop-color="#3b57ff"/></linearGradient></defs>
                <path d="M16 46L64 26l48 20-48 20-48-20Z" fill="url(#gh)"/>
                <path d="M32 58l32 14 32-14v14c0 10-14 18-32 18s-32-8-32-18V58Z" fill="#2a2f43"/>
                <circle cx="104" cy="73" r="6" fill="#4a6bff"/>
                <circle cx="42" cy="94" r="6" fill="#7ea0ff"/><circle cx="86" cy="94" r="6" fill="#7ea0ff"/>
                <path d="M42 94h44" stroke="#9fb3ff" stroke-width="3" stroke-linecap="round"/>
            </svg>
            <div class="name">Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ Ø£Ù†Ø§ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ ÙÙŠ Ø§Ù„Ø³Ø§Ø¯Ø³</div>
            <div class="sub">ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ</div>
        `;
    }
    msgs.appendChild(wrap);
}

function watchMessages(chatId){
    return db.collection("chats").doc(chatId).collection("messages").orderBy("clientTs","asc")
        .onSnapshot(snap=>{
            if(isStreaming) return;
            
            currentChatHistory = [];
            let firstUserMessage = null;
            
            snap.forEach(doc=>{
                const msg = doc.data();
                currentChatHistory.push({
                    role: msg.role,
                    content: msg.text || ""
                });
                
                if (msg.role === "user" && !firstUserMessage) {
                    firstUserMessage = msg.text;
                }
            });
            
            userUsage.messageCount = snap.size;
            renderUsageBadge();
            
            if (firstUserMessage && snap.size === 1) {
                updateChatTitle(chatId, firstUserMessage);
            }
            
            if(snap.empty){ 
                renderEmptyHero(); 
                return; 
            }
            msgs.innerHTML="";
            snap.forEach(doc=>{ renderMsg(doc.id, doc.data()); });
            msgs.scrollTo({top:msgs.scrollHeight+1000});
        });
}

async function loadChat(id){
    try {
        cancelCurrentStream();
        currentChatId=id; 
        currentChatHistory = [];
        setActiveChatItem(id);
        msgs.innerHTML="";
        if(unSubMsgs) unSubMsgs();
        unSubMsgs=watchMessages(id);
        
        await loadUserUsage();
    } catch (error) {
        console.error('Error loading chat:', error);
        toast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©');
    }
}

/* ===== ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª ===== */
async function updateChatTitle(chatId, firstMessage) {
    if (!firstMessage || firstMessage.length < 3) return;
    
    const title = firstMessage.length > 30 ? firstMessage.substring(0, 30) + '...' : firstMessage;
    
    try {
        await db.collection("chats").doc(chatId).update({
            title: title,
            clientUpdated: Date.now(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        const updatedCache = CHAT_CACHE.map(chat => 
            chat.id === chatId ? {...chat, title} : chat
        );
        cacheSet(updatedCache);
        
        const chatItem = document.querySelector(`.item[data-id="${chatId}"] .item-title`);
        if (chatItem) {
            chatItem.textContent = title;
        }
    } catch (error) {
        console.error('Error updating chat title:', error);
    }
}

/* ===== Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù…Ø¹ Ø²Ø± Ø§Ù„Ù†Ø³Ø® ===== */
function renderMsg(id, m){
    const isMath=/\\(frac|sqrt|sum|Delta|pi|times|div|rightarrow|left|right|alpha|beta|gamma|delta|epsilon|zeta|eta|theta|iota|kappa|lambda|mu|nu|xi|omicron|pi|rho|sigma|tau|upsilon|phi|chi|psi|omega|hbar|partial|nabla|infty|cdot|pm|mp|times|div|leq|geq|neq|approx|equiv|propto|perp|parallel|angle|circ|degree|vec|hat|tilde|dot|ddot|prime|int|oint|sum|prod|lim|exp|log|ln|sin|cos|tan|cot|sec|csc|arcsin|arccos|arctan|sinh|cosh|tanh|coth|sech|csch|det|dim|gcd|hom|ker|lg|ln|log|max|min|Pr|sup)|\$\$|H_2O|CO_2|CH_4|NaCl|H_2SO_4|NaOH|HCl/i.test(m.text||"");
    const who=m.role==="user"?"user":"bot";
    const img=m.imageDataURL||null;
    const html=(m.text||"").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    const el=document.createElement("div");
    el.className=`msg ${who}`+(isMath?" math":"");
    if(id) el.dataset.mid=id;
    el.dataset.role=m.role;
    
    if (who === "bot") {
        const copyBtn = document.createElement("button");
        copyBtn.className = "copy-btn";
        copyBtn.textContent = "Ù†Ø³Ø® Ø§Ù„Ø±Ø³Ø§Ù„Ø©";
        copyBtn.onclick = (e) => {
            e.stopPropagation();
            copyMessageText(m.text);
        };
        el.appendChild(copyBtn);
    }
    
    if(img){ 
        const container = document.createElement("div");
        container.className = "attachment-container";
        
        const im=new Image(); 
        im.className="attachment"; 
        im.src=img; 
        im.style.maxWidth="200px";
        im.style.borderRadius="8px";
        container.appendChild(im);
        
        el.appendChild(container); 
    }
    const box=document.createElement("div"); 
    box.style.cssText = "font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Tajawal', sans-serif; line-height: 1.6; word-wrap: break-word;";
    box.innerHTML=html; 
    el.appendChild(box);
    msgs.appendChild(el);
    if(isMath && window.MathJax) {
        MathJax.typesetPromise([el]).catch(()=>{});
    }
}

// Ø¯Ø§Ù„Ø© Ù†Ø³Ø® Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
function copyMessageText(text) {
    navigator.clipboard.writeText(text).then(() => {
        toast("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­");
    }).catch(() => {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand("copy");
        document.body.removeChild(textArea);
        toast("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­");
    });
}

/* Ø­ÙØ¸ Ø±Ø³Ø§Ù„Ø© */
async function appendMessageStore(role,text,imageDataURL=null, forceChatId=null){
    const chatId = forceChatId || currentChatId;
    if(!chatId) return;
    const ref=db.collection("chats").doc(chatId).collection("messages");
    await ref.add({ role, text, imageDataURL, clientTs: Date.now(), ts: firebase.firestore.FieldValue.serverTimestamp() });
    await db.collection("chats").doc(chatId).update({ clientUpdated: Date.now(), updatedAt:firebase.firestore.FieldValue.serverTimestamp() });
    try{ await db.collection("users").doc(me.uid).update({ lastActive: firebase.firestore.FieldValue.serverTimestamp() }); }catch{}
}

/* ===== Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ù…Ø­Ø³Ù† ===== */
function arNormalize(s){ return (s||"").replace(/[\u0610-\u061A\u064B-\u065F\u06D6-\u06ED]/g,'').replace(/[Ø£Ø¥Ø¢]/g,'Ø§').replace(/Ù‰/g,'ÙŠ').replace(/Ø¤/g,'Ùˆ').replace(/Ø¦/g,'ÙŠ').replace(/Ø©/g,'Ù‡').replace(/[Ù€]+/g,'').toLowerCase(); }
function chunkAll(texts){ 
    const arr=[]; 
    texts.forEach(t=>{ 
        const clean=(t||"").replace(/(\.|\!|\ØŸ|\?|Ø›)/g,'$1\n'); 
        const parts=clean.split(/\n+/).map(x=>x.trim()).filter(Boolean); 
        let buf=""; 
        for(const line of parts){ 
            if((buf+" "+line).length<=700) buf=(buf?buf+" ":"")+line; 
            else { if(buf) arr.push(buf); buf=line; } 
        } 
        if(buf) arr.push(buf); 
    }); 
    return arr.slice(-2000);
}

function buildIndex(chunks){
    const tokenize=s=>arNormalize(s).replace(SAFE_TOKENS," ").split(/\s+/).filter(w=>w.length>1);
    const docs=chunks.map(c=>({text:c,toks:tokenize(c)}));
    const df=new Map(); docs.forEach(d=>{[...new Set(d.toks)].forEach(w=>df.set(w,(df.get(w)||0)+1));});
    const N=docs.length||1;
    docs.forEach(d=>{
        const tf=new Map(); d.toks.forEach(w=>tf.set(w,(tf.get(w)||0)+1));
        d.vec=new Map();
        tf.forEach((f,w)=>{ const idf=Math.log((N+1)/((df.get(w)||1)+1))+1; d.vec.set(w,(f/d.toks.length)*idf);});
        delete d.toks;
    });
    index={docs,df:N?df:new Map(),N,tokenize};
}

function retrieve(q,k=8){
    if(!index||!index.docs.length) return [];
    const qT=index.tokenize(q);
    const tf=new Map(); qT.forEach(w=>tf.set(w,(tf.get(w)||0)+1));
    const qV=new Map(); tf.forEach((f,w)=>{ const idf=Math.log((index.N+1)/((index.df.get(w)||1)+1))+1; qV.set(w,(f/qT.length)*idf);});
    const qn=norm(qV);
    const scored=index.docs.map(d=>({text:d.text,score:dot(qV,d.vec)/(qn*norm(d.vec))})).sort((a,b)=>b.score-a.score).slice(0,k);
    return scored.filter(s=>s.score>0.01).map(s=>s.text);
    function dot(a,b){let s=0;a.forEach((va,wa)=>{s+=va*(b.get(wa)||0)});return s}
    function norm(v){let s=0;v.forEach(x=>s+=x*x);return Math.sqrt(s)||1}
}

async function loadKnowledgeFromDB(){
    try {
        const s=await db.collection("knowledge").orderBy("createdAt","desc").limit(2000).get();
        const infoTexts=[]; 
        rulesMemo="";
        s.docs.forEach(d=>{
            const x=d.data(); 
            const t=(x.type||"").toLowerCase();
            if(t==="pdf" || t==="info" || t==="text"){
                const joined=[x.note?`Ù…Ù„Ø§Ø­Ø¸Ø©: ${x.note}`:"",x.text||""].join("\n").trim();
                if(joined) infoTexts.push(joined);
            }else if(t==="rule"){ 
                if(x.text) rulesMemo=(rulesMemo?rulesMemo+"\n":"")+x.text; 
            }
        });
        knowledgeChunks=chunkAll(infoTexts); 
        buildIndex(knowledgeChunks);
        console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø±ÙØ©:', knowledgeChunks.length, 'Ù‚Ø·Ø¹Ø©ØŒ Ø§Ù„Ø£ÙˆØ§Ù…Ø±:', rulesMemo.length, 'Ø­Ø±Ù');
    } catch(e) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø±ÙØ©:', e);
    }
}

/* ===== Ù†Ø¸Ø§Ù… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø­Ø³Ù† ÙˆØ¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ===== */
$("#imgFile").addEventListener("change", async (e) => {
    const f = e.target.files?.[0]; 
    if (!f) return;
    
    const myTok = ++attachToken;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø©
    const maxSize = 5 * 1024 * 1024; // 5MB
    if (f.size > maxSize) {
        toast("Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5MB)");
        return;
    }

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ù†ÙØ³ ØªØµÙ…ÙŠÙ… DeepSeek
    attachedImage = {
        name: (f.name || "image").replace(/\.\w+$/, "") + ".jpg", 
        sizeKB: Math.round(f.size / 1024),
        dataURL: "",
        status: "Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...",
        uploadProgress: 0
    };
    
    showAttachChip();
    
    const r = new FileReader();
    r.onload = () => { 
        if (myTok !== attachToken) return; 
        
        const dataURL = r.result;
        attachedImage.dataURL = dataURL;
        
        // Ù…Ø­Ø§ÙƒØ§Ø© ØªÙ‚Ø¯Ù… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ø«Ù„ DeepSeek
        simulateUploadProgress(myTok);
        
        input.focus(); 
    };
    r.readAsDataURL(f);
    e.target.value = "";
});

// Ù…Ø­Ø§ÙƒØ§Ø© ØªÙ‚Ø¯Ù… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù†ÙØ³ ØªØµÙ…ÙŠÙ… DeepSeek
function simulateUploadProgress(token) {
    let progress = 0;
    const progressInterval = setInterval(() => {
        if (token !== attachToken) {
            clearInterval(progressInterval);
            return;
        }
        
        progress += 10;
        if (progress >= 100) {
            progress = 100;
            clearInterval(progressInterval);
            
            // Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ØŒ ØªØ¨Ø¯Ø£ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„
            if (token === attachToken && attachedImage) {
                attachedImage.status = "Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„...";
                showAttachChip();
                
                // Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© OCR Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
                setTimeout(() => {
                    processImageOCR(token);
                }, 500);
            }
        } else {
            if (attachedImage) {
                attachedImage.status = `Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„... ${progress}%`;
                showAttachChip();
            }
        }
    }, 100);
}

// ØªØ­Ø³ÙŠÙ† Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©
function showAttachChip() {
    if (!attachedImage) { 
        attachWrap.classList.add("hidden"); 
        attachWrap.innerHTML = ""; 
        return; 
    }
    
    const { name, sizeKB, dataURL, status } = attachedImage;
    
    const statusClass = status.includes("Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„") ? "processing" : 
                       status.includes("Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„") ? "analyzing" : 
                       "ready";
    
    attachWrap.innerHTML = `
        <div class="attach-chip">
            <div class="thumb">
                <img src="${dataURL}" alt="${name}">
            </div>
            <div class="name">${name}</div>
            <div class="status">
                <span class="attachment-status ${statusClass}">${status}</span>
                ${status.includes("Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„") ? "" : `<span class="size">${sizeKB} KB</span>`}
            </div>
            <div class="x" id="removeAttach">âœ•</div>
        </div>`;
    
    attachWrap.classList.remove("hidden");
    
    $("#removeAttach").onclick = () => { 
        attachedImage = null; 
        ++attachToken; 
        showAttachChip(); 
        input.focus(); 
    };
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­ÙˆÙŠÙ„ DataURL Ø¥Ù„Ù‰ Blob
function dataURLtoBlob(dataURL) {
    const byteString = atob(dataURL.split(',')[1]);
    const mimeString = dataURL.split(',')[0].split(':')[1].split(';')[0];
    const ab = new ArrayBuffer(byteString.length);
    const ia = new Uint8Array(ab);
    for (let i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
    }
    return new Blob([ab], { type: mimeString });
}

// ØªØ­Ø³ÙŠÙ† Ø¹Ù…Ù„ÙŠØ© OCR
async function processImageOCR(token) {
    if (!ENABLE_OCR) {
        if (token === attachToken && attachedImage) {
            attachedImage.status = "Ø¬Ø§Ù‡Ø²";
            attachedImage.ocrText = "";
            showAttachChip();
        }
        return;
    }
    
    try {
        if (token === attachToken && attachedImage) {
            attachedImage.status = "Ø¬Ø§Ø± Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©...";
            showAttachChip();
            
            const { data: { text } } = await Tesseract.recognize(
                dataURLtoBlob(attachedImage.dataURL), 
                'ara+eng'
            );
            
            if (token === attachToken && attachedImage) {
                attachedImage.ocrText = (text || "").trim();
                attachedImage.status = "Ø¬Ø§Ù‡Ø²";
                showAttachChip();
                toast("ØªÙ… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­");
            }
        }
    } catch (ocrError) {
        console.log('OCR Error:', ocrError);
        if (token === attachToken && attachedImage) {
            attachedImage.ocrText = "";
            attachedImage.status = "Ø¬Ø§Ù‡Ø²";
            showAttachChip();
            toast("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­");
        }
    }
}

$("#attach").onclick=()=>$("#imgFile").click();

function wantsLongExplain(t){ return /(Ø§Ø´Ø±Ø­|Ø´Ø±Ø­|ÙØ³Ø±|ÙˆØ¶Ø­|ÙØ³Ø±Ù„ÙŠ|Ø´Ø±Ø­Ù„ÙŠ|Ø­Ù„ Ø¨Ø§Ù„ØªÙØµÙŠÙ„|ØªÙØµÙŠÙ„|Ø§ÙÙ‡Ù…Ù†ÙŠ)/i.test(t||""); }
function isProblemLike(t){ return /(Ù…Ø³Ø§Ù„Ù‡|Ù…Ø¹Ø§Ø¯Ù„Ø©|Ø§Ø­Ø³Ø¨|Ø­Ù„|Ø¬Ø¯|Ù…Ø«Ø§Ù„|Ù‚Ø§Ù†ÙˆÙ†|Ù…ÙˆÙ„|ØªØ±ÙƒÙŠØ²|Ù…Ø¹Ø§ÙŠØ±Ù‡|Ø§ØªØ²Ø§Ù†|Ø­Ø±ÙƒÙ‡|Ù…Ø¬Ø§Ù„|ÙƒÙŠÙ…ÙŠØ§Ø¡|ÙÙŠØ²ÙŠØ§Ø¡|Ø±ÙŠØ§Ø¶ÙŠØ§Øª|Ø¹Ù„Ù…|Ø³Ø¤Ø§Ù„)/i.test(t||""); }

/* ===== Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø­Ø³Ù† Ù…Ø¹ Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØµÙˆØ± ===== */
async function onSend(){
    if(!canChat){ 
        showPaywall();
        return; 
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    if (userUsage.messageCount >= userUsage.maxMessagesPerChat && !userProfileCache?.subscribed) {
        toast("Ù„Ù‚Ø¯ ÙˆØµÙ„Øª Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©");
        showPaywall();
        return;
    }
    
    const userTxt = $("#input").value.trim();
    if (!userTxt && !attachedImage) {
        toast("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø±Ø³Ø§Ù„Ø© Ø£Ùˆ Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø©");
        return;
    }

    // Ø¥Ù„ØºØ§Ø¡ Ø£ÙŠ Ø¹Ù…Ù„ÙŠØ© Ø¥Ø±Ø³Ø§Ù„ Ø³Ø§Ø¨Ù‚Ø©
    cancelCurrentStream();

    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Øµ ÙÙˆØ±Ø§Ù‹ Ù…Ù† Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
    $("#input").value = "";

    // ØªØ¹Ø·ÙŠÙ„ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¤Ù‚ØªØ§Ù‹
    const sendBtn = $("#send");
    sendBtn.disabled = true;
    sendBtn.innerHTML = "â³";

    try {
        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙˆØ±Ø§Ù‹
        renderMsg(null, { 
            role: "user", 
            text: userTxt || "[ØµÙˆØ±Ø© ÙÙ‚Ø·]", 
            imageDataURL: attachedImage?.dataURL || null 
        });
        
        if (!currentChatId) await newChat();
        
        // Ø­ÙØ¸ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        await db.collection("chats").doc(currentChatId).collection("messages")
            .add({ 
                role: "user", 
                text: userTxt || "[ØµÙˆØ±Ø© ÙÙ‚Ø·]", 
                imageDataURL: attachedImage?.dataURL || null, 
                clientTs: Date.now(), 
                ts: firebase.firestore.FieldValue.serverTimestamp() 
            });
            
        await db.collection("chats").doc(currentChatId).update({ 
            clientUpdated: Date.now(), 
            updatedAt: firebase.firestore.FieldValue.serverTimestamp() 
        });

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Øµ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ø¥Ø±Ø³Ø§Ù„
        let finalPrompt = "";
        if (attachedImage) {
            const ocr = attachedImage.ocrText && attachedImage.ocrText.trim() ? attachedImage.ocrText.trim() : "";
            finalPrompt = [
                "Ù‡Ø°Ù‡ ØµÙˆØ±Ø© Ù…Ø³Ø£Ù„Ø©/Ù†Øµ. Ø­Ù„Ù‘Ù„ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø¯Ù‚Ø©:",
                ocr ? ("â€” Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬ (OCR):\n" + ocr) : "",
                userTxt ? ("â€” Ù…Ù„Ø§Ø­Ø¸ØªÙŠ/Ø³Ø¤Ø§Ù„ÙŠ:\n" + userTxt) : "",
                "Ø±Ø¬Ø§Ø¡Ù‹: Ø§Ø¹Ø±Ø¶ Ø§Ù„Ø­Ù„ Ø¨Ø®Ø·ÙˆØ§Øª Ù…Ø±Ù‚Ù…Ø© ÙˆØ¨Ù€ LaTeX Ø¯Ø§Ø®Ù„ $$ .. $$ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©."
            ].filter(Boolean).join("\n\n");
        } else {
            finalPrompt = userTxt;
        }
        
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø¨Ø¹Ø¯ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©
        attachedImage = null; 
        ++attachToken; 
        showAttachChip();

        // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø±Ø¯
        const wantsLong = wantsLongExplain(userTxt) || isProblemLike(finalPrompt);
        const problem = isProblemLike(finalPrompt);

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø±ÙØ© Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
        if (!index) { 
            try { 
                await loadKnowledgeFromDB(); 
            } catch(e) {} 
        }

        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø¹Ø±ÙØ©
        const ctxPieces = retrieve(finalPrompt, 8);
        const ctx = ctxPieces.join("\n---\n");

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨Ø«
        const reqId = Math.random().toString(36).slice(2);
        const controller = new AbortController();
        currentStream = { id: reqId, chatId: currentChatId, controller };

        // Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«
        startStreaming();
        
        try {
            await streamAI(ctx, finalPrompt, { 
                wantsLong, 
                isProblem: problem, 
                signal: controller.signal, 
                reqId 
            });
        } catch (e) {
            if (e.name === "AbortError") return;
            
            endStreaming(reqId);
            renderMsg(null, { role: "bot", text: "ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¨Ø«ØŒ Ø³Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ø¯ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©â€¦" });
            await callAIOnce(ctx, finalPrompt, { wantsLong, isProblem: problem });
        }
        
    } catch (error) {
        console.error('Error in onSend:', error);
        toast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©');
    } finally {
        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ…ÙƒÙŠÙ† Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        sendBtn.disabled = false;
        sendBtn.innerHTML = "â¤";
    }
}

// Ø¥Ø¶Ø§ÙØ© Ø§Ø³ØªÙ…Ø§Ø¹ ÙØ¹Ø§Ù„ Ù„Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
$("#send").onclick = onSend;

// Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
$("#input").addEventListener("keypress", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        onSend();
    }
});

function startStreaming(){
    isStreaming = true;
    streamingEl = document.createElement("div");
    streamingEl.className = "msg bot";
    streamingEl.dataset.role = "bot";
    streamingEl.textContent = "";
    streamedText="";
    msgs.appendChild(streamingEl);
    msgs.scrollTo({top: msgs.scrollHeight + 1000, behavior: "smooth"});
}

function pushChunk(txt, reqId){
    if(currentStream.id!==reqId) return;
    if(!streamingEl) startStreaming();
    streamingEl.textContent += txt;
    streamedText += txt;
    msgs.scrollTo({top: msgs.scrollHeight + 1000});
}

function endStreaming(reqId){
    if(currentStream.id!==reqId) return;
    if(!streamingEl){ isStreaming=false; streamedText=""; return; }
    const cleaned = cleanAI(streamedText||"");
    const html = cleaned.replace(/</g,"&lt;").replace(/>/g,"&gt;");
    const isMath = /\\(frac|sqrt|sum|Delta|pi|times|div|rightarrow|left|right|alpha|beta|gamma|delta)|\$\$|H_2O|CO_2/i.test(cleaned);
    const finalEl = document.createElement("div");
    finalEl.className = `msg bot${isMath?" math":""}`;
    finalEl.dataset.role="bot";
    
    // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„Ù†Ø³Ø®
    const copyBtn = document.createElement("button");
    copyBtn.className = "copy-btn";
    copyBtn.textContent = "Ù†Ø³Ø® Ø§Ù„Ø±Ø³Ø§Ù„Ø©";
    copyBtn.onclick = (e) => {
        e.stopPropagation();
        copyMessageText(cleaned);
    };
    finalEl.appendChild(copyBtn);
    
    const box = document.createElement("div"); 
    box.style.cssText = "font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Tajawal', sans-serif; line-height: 1.6;";
    box.innerHTML = html; 
    finalEl.appendChild(box);
    streamingEl.replaceWith(finalEl);
    if(isMath && window.MathJax) MathJax.typesetPromise([finalEl]).catch(()=>{});
    streamingEl = null; isStreaming=false;
    streamedText = cleaned;
}

/* ØªÙ†Ø¸ÙŠÙ ØªÙƒØ±Ø§Ø±Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ */
function cleanAI(s){
    if(!s) return s;
    let x=(s||"").replace(/\r/g,"").replace(/[ \t]+\n/g,"\n").replace(/\n{3,}/g,"\n\n").trim();
    const paras=x.split(/\n{2,}/).map(p=>p.trim()).filter(Boolean);
    const out=[]; const seen=new Set();
    for(const p of paras){ const key=p.replace(/\s+/g," "); if(!seen.has(key)){ out.push(p); seen.add(key);} }
    x=out.join("\n\n");
    if(x.length>120){
        const mid=Math.floor(x.length/2);
        const a=x.slice(0,mid).trim(), b=x.slice(mid).trim();
        if(a===b) x=a;
    }
    return x;
}

/* AI - Ù†Ø¸Ø§Ù… Ù…Ø­Ø³Ù† Ù…Ø¹ Ø¯Ø¹Ù… ÙƒØ§Ù…Ù„ Ù„Ù„Ø±Ù…ÙˆØ² */
function sysPrompt({wantsLong,isProblem}){
    let prompt = [
        "Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø¯Ø±Ø§Ø³ÙŠ Ø°ÙƒÙŠ Ø¬Ø¯Ù‹Ø§ Ù…ØªØ®ØµØµ ÙÙŠ Ù…Ù†Ù‡Ø¬ Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø¹Ù„Ù…ÙŠ.",
        "ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ Ø¯Ù‚ÙŠÙ‚Ø© ÙˆÙ…ÙØµÙ„Ø© ÙˆÙ…Ù†Ø§Ø³Ø¨Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª.",
        "Ø±ÙƒØ² ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© ÙˆÙ„Ø§ ØªØªØ­Ø¯Ø« Ø¹Ù† Ù…ÙˆØ§Ø¶ÙŠØ¹ Ø£Ø®Ø±Ù‰.",
        "Ø§Ù„ØªØ²Ù… Ø¨Ø§Ù„Ù…Ù†Ù‡Ø¬ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ ÙˆÙ„Ø§ ØªØ®Ø±Ø¬ Ø¹Ù†Ù‡.",
        wantsLong ? "Ø§ÙƒØªØ¨ Ø´Ø±Ø­Ù‹Ø§ ØªÙØµÙŠÙ„ÙŠÙ‹Ø§ Ù…Ø¹ Ø®Ø·ÙˆØ§Øª Ù…Ø±Ù‚Ù…Ø© ÙˆØ¹Ù†Ø§ÙˆÙŠÙ† ÙØ±Ø¹ÙŠØ©." : "Ø£Ø¬Ø¨ Ø¨ÙˆØ¶ÙˆØ­ ÙˆØ¥ÙŠØ¬Ø§Ø² Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ù‚Ø© Ø§Ù„Ø¹Ù„Ù…ÙŠØ©.",
        "Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ© ÙˆØ§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠØ© ÙˆØ§Ù„ÙÙŠØ²ÙŠØ§Ø¦ÙŠØ© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… LaTeX: $$ .. $$ Ø£Ùˆ \\( .. \\)",
        "**Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ©**: \\(\\alpha, \\beta, \\gamma, \\delta, \\Delta, \\pi, \\theta, \\lambda, \\mu, \\sigma, \\sum, \\prod, \\int, \\sqrt{}, \\frac{}{}, \\binom{}{}, \\times, \\div, \\pm, \\mp, \\leq, \\geq, \\neq, \\approx, \\equiv, \\propto, \\rightarrow, \\leftrightarrow, \\in, \\subset, \\cup, \\cap, \\forall, \\exists, \\therefore, \\because, \\angle, \\parallel, \\perp, \\circ, \\degree\\)",
        "**Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠØ©**: \\(H_2O, CO_2, CH_4, NaCl, H_2SO_4, NaOH, HCl, CaCO_3, Fe_2O_3, Al_2O_3, Mg(OH)_2\\)",
        "**Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¦ÙŠØ©**: \\(F = ma, E = mc^2, v = \\frac{d}{t}, a = \\frac{\\Delta v}{\\Delta t}, P = \\frac{F}{A}, W = F \\cdot d, P = \\frac{W}{t}\\)",
        isProblem ? "Ù„Ù„Ù…Ø³Ø§Ø¦Ù„: Ø§Ø³ØªØ®Ø¯Ù… Ø®Ø·ÙˆØ§Øª Ù…Ø±Ù‚Ù…Ø© 1,2,3â€¦ Ù…Ø¹ ØªØ¨Ø±ÙŠØ± Ø¹Ù„Ù…ÙŠ Ù…ÙˆØ¬Ø² Ù„ÙƒÙ„ Ø®Ø·ÙˆØ©." : "",
        "Ù‚Ø¯Ù… Ø£Ù…Ø«Ù„Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©.",
        "Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ø¨Ù„Ø·Ù ğŸ§ âœ¨ğŸ“šğŸ”",
        "ØªØ°ÙƒØ± Ø§Ù„Ø³ÙŠØ§Ù‚ ÙˆØ§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¨Ø´ÙƒÙ„ Ù…ØªØ±Ø§Ø¨Ø·.",
        "Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„Ù…Ù†Ø·Ù‚ÙŠØ© ÙˆØ§Ù„ØªØ¨Ø±ÙŠØ±Ø§Øª Ø§Ù„Ø¹Ù„Ù…ÙŠØ©.",
        "**ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©**: Ù…Ù‚Ø¯Ù…Ø© â† Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ù„ â† Ù†ØªÙŠØ¬Ø© â† Ù…Ù„Ø®Øµ."
    ].filter(Boolean).join("\n");

    if (rulesMemo) {
        prompt += "\n\n### Ø§Ù„Ø£ÙˆØ§Ù…Ø± ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª:\n" + rulesMemo;
    }

    if (knowledgeChunks.length > 0) {
        const recentKnowledge = knowledgeChunks.slice(0, 5).join("\n\n");
        prompt += "\n\n### Ø§Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ©:\n" + recentKnowledge;
    }

    return prompt;
}

async function streamAI(context, user, {wantsLong,isProblem,signal,reqId}){
    try {
        const messages = [
            {
                role: "system", 
                content: sysPrompt({wantsLong, isProblem})
            },
            { role: "user", content: user }
        ];

        const body = {
            model: "deepseek-chat",
            messages: messages,
            stream: true,
            max_tokens: USER_INTELLIGENCE_LEVEL === 100 ? 4000 : 2000
        };

        const res = await fetch(AI_ENDPOINT, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${AI_KEY}`
            },
            body: JSON.stringify(body),
            signal
        });

        if (!res.ok) {
            throw new Error(`HTTP ${res.status}`);
        }

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        
        while (true) {
            const {done, value} = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');

            for (const line of lines) {
                if (line.startsWith('data: ') && !line.includes('[DONE]')) {
                    try {
                        const data = JSON.parse(line.slice(6));
                        const content = data.choices[0]?.delta?.content;
                        if (content) {
                            pushChunk(content, reqId);
                        }
                    } catch (e) {
                        // ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù€ JSON
                    }
                }
            }
        }

        const finalText = cleanAI(streamedText);
        endStreaming(reqId);
        await appendMessageStore("bot", finalText, null, currentStream.chatId);

    } catch (error) {
        if (error.name !== "AbortError") {
            throw error;
        }
    }
}

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© callAIOnce
async function callAIOnce(context, user, {wantsLong, isProblem}) {
    try {
        const messages = [
            {
                role: "system", 
                content: sysPrompt({wantsLong, isProblem})
            },
            { role: "user", content: user }
        ];

        const body = {
            model: "deepseek-chat",
            messages: messages,
            max_tokens: USER_INTELLIGENCE_LEVEL === 100 ? 4000 : 2000
        };

        const res = await fetch(AI_ENDPOINT, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${AI_KEY}`
            },
            body: JSON.stringify(body)
        });

        if (!res.ok) {
            throw new Error(`HTTP ${res.status}`);
        }

        const data = await res.json();
        const responseText = data.choices[0]?.message?.content || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø§Ø¨Ø©";
        
        const cleaned = cleanAI(responseText);
        renderMsg(null, {role: "bot", text: cleaned});
        await appendMessageStore("bot", cleaned, null, currentChatId);
        
        return cleaned;
    } catch (error) {
        console.error('AI Error:', error);
        const errorMsg = "Ø¹Ø°Ø±Ù‹Ø§ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
        renderMsg(null, {role: "bot", text: errorMsg});
        await appendMessageStore("bot", errorMsg, null, currentChatId);
        throw error;
    }
}

/* ===== Ø§Ø­ØµØ§Ø¡Ø§Øª ===== */
async function refreshUserStats(){
    if(me?.email!==ADMIN_EMAIL){
        $("#statTotal").textContent="â€”";
        $("#statActiveNow").textContent="â€”";
        $("#statUsersToday").textContent="â€”";
        $("#statMsgsToday").textContent="â€”";
        return alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©.");
    }
    const now=new Date(); const startOfDay=new Date(now.getFullYear(),now.getMonth(),now.getDate());
    const usersSnap=await db.collection("users").get();
    const totalUsers=usersSnap.size;
    const fiveMinAgo=new Date(now.getTime()-5*60*1000);
    let activeNow=0, usersToday=0;
    usersSnap.forEach(d=>{
        const u=d.data(); const la=u.lastActive?.toDate?u.lastActive.toDate():null;
        if(la){ if(la>=fiveMinAgo) activeNow++; if(la>=startOfDay) usersToday++; }
    });
    let msgsToday=0;
    const chatsSnap=await db.collection("chats").where("updatedAt",">=", firebase.firestore.Timestamp.fromDate(startOfDay)).get().catch(()=>({docs:[]}));
    for(const ch of (chatsSnap.docs||[])){
        const mSnap=await db.collection("chats").doc(ch.id).collection("messages").where("ts",">=", firebase.firestore.Timestamp.fromDate(startOfDay)).get().catch(()=>({size:0}));
        msgsToday+=(mSnap.size||0);
    }
    $("#statTotal").textContent=totalUsers;
    $("#statActiveNow").textContent=activeNow;
    $("#statUsersToday").textContent=usersToday;
    $("#statMsgsToday").textContent=msgsToday;
}

/* ===== ØµÙØ­Ø§Øª ===== */
function openPage(id){ const el=$(id); if(!el) return; el.style.display="block"; pageStack.push(id); }
function goBack(){
    if(pageStack.length<=1){ pageStack=[]; document.querySelectorAll(".page").forEach(p=>p.style.display="none"); return; }
    const cur=pageStack.pop(); if(cur) $(cur).style.display="none"; const prev=pageStack[pageStack.length-1]; if(prev) $(prev).style.display="block";
}
document.querySelectorAll("[data-back]").forEach(b=>b.addEventListener("click",goBack));

// Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
$("#subscriptionBtn").onclick = () => openPage("#pageSubscription");

$("#adminBtn").onclick=()=>{ if(me?.email!==ADMIN_EMAIL){ alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©."); return; } openPage("#pageHub"); };
$("#tileUsers").onclick=()=>{ $("#pageHub").style.display="none"; openPage("#pageUsers"); refreshUserStats(); };
$("#tileSubs").onclick =()=>{ $("#pageHub").style.display="none"; openPage("#pageSubs"); };
$("#tileTrain").onclick=()=>{ $("#pageHub").style.display="none"; openPage("#pageTrain"); };

/* ===== Ø§Ø´ØªØ±Ø§ÙƒØ§Øª: Ø¥Ø¶Ø§ÙØ© + Ø¥Ù„ØºØ§Ø¡ ===== */
$("#addSubscription").onclick=async ()=>{
    if(me?.email!==ADMIN_EMAIL) return alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©.");
    const email=($("#subEmail").value||"").trim();
    const plan=parseInt($("#subPlan").value||"5",10);
    if(!email) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯.");
    
    const planDays = {
        5: 10,
        10: 20,
        15: 30
    };
    
    const days = planDays[plan] || 10;
    
    const q=await db.collection("users").where("email","==",email).limit(1).get();
    if(q.empty) return $("#subMsg").textContent="Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.";
    const ref=q.docs[0].ref;
    
    const now=new Date();
    const newEnd=new Date(now.getTime() + (days * 24 * 60 * 60 * 1000));
    
    await ref.update({
        subscribed: true,
        subscriptionEnd: firebase.firestore.Timestamp.fromDate(newEnd),
        blocked: false
    });
    
    $("#subMsg").textContent=`ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù„Ù…Ø¯Ø© ${days} ÙŠÙˆÙ…. Ø§Ù„Ù†Ù‡Ø§ÙŠØ©: ${newEnd.toLocaleDateString('ar-SA')}`;
    $("#subEmail").value = "";
};

$("#cancelSub").onclick=async ()=>{
    if(me?.email!==ADMIN_EMAIL) return alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©.");
    const email=($("#cancelEmail").value||"").trim();
    if(!email) return alert("Ø§ÙƒØªØ¨ Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….");
    const q=await db.collection("users").where("email","==",email).limit(1).get();
    if(q.empty) return $("#cancelMsg").textContent="Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.";
    const ref=q.docs[0].ref;
    await ref.update({
        subscribed: false,
        subscriptionEnd: null,
        blocked: true,
        canceledAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    $("#cancelMsg").textContent="ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙˆØ±Ù‹Ø§. Ø³ÙŠØ¸Ù‡Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Paywall Ø­ØªÙ‰ ÙŠØ¹ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ.";
    $("#cancelEmail").value = "";
};

// Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
function cleanup() {
    if (unsubProfile) {
        unsubProfile();
        unsubProfile = null;
    }
    if (unSubMsgs) {
        unSubMsgs();
        unSubMsgs = null;
    }
    if (timerId) {
        clearInterval(timerId);
        timerId = null;
    }
    cancelCurrentStream();
}

window.addEventListener('beforeunload', cleanup);
window.addEventListener("load",()=>{ applyTheme(); adjustMsgsPadding(); });

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/mslm2/sw.js')
    .then(function(registration) {
      console.log('SW registered');
    });
}
</script>
</body>
</html>
