<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ ÙÙŠ Ø§Ù„Ø³Ø§Ø¯Ø³ | Sixth Assistant</title>

<!-- Firebase v9 (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- pdf.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>try{pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';}catch{}</script>

<!-- Tesseract.js -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<!-- MathJax -->
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<style>
:root{--bg:#0c0d10;--panel:#13151a;--card:#0f1116;--stroke:#242833;--text:#e9ecf1;--muted:#9aa4b2;--brand:#4a6bff;--ok:#2ecc71;--err:#e74c3c;--user-dark:#2e333d;--bot-dark:#0f1320;--user-light:#3b57ff;--bot-light:#ffffff}
:root.light{--bg:#f6f7fb;--panel:#ffffff;--card:#ffffff;--stroke:#dbe1ea;--text:#0b1220;--muted:#5b6473;--brand:#3b57ff;--ok:#1f9d5a;--err:#cf3434}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Tajawal",sans-serif;overflow:hidden}
.hidden{display:none}

/* Toast ØµØºÙŠØ± Ù„Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø±ÙŠØ¹ */
.toast{position:fixed;inset-inline:0;top:12px;margin:auto;max-width:520px;background:#121826;color:#fff;border:1px solid var(--stroke);border-radius:12px;padding:10px 14px;text-align:center;z-index:999;opacity:0;transform:translateY(-8px);transition:.2s}
.toast.show{opacity:1;transform:translateY(0)}

/* Boot */
#boot{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--bg);z-index:100;color:var(--muted);gap:10px}
#boot .dot{width:8px;height:8px;border-radius:50%;background:var(--muted);animation:b 1s infinite}
#boot .dot:nth-child(2){animation-delay:.15s}
#boot .dot:nth-child(3){animation-delay:.3s}
@keyframes b{0%,80%,100%{opacity:.2;transform:translateY(0)}40%{opacity:1;transform:translateY(-6px)}}

#root{position:fixed;inset:0;display:none;grid-template-columns:280px 1fr;width:100vw;height:100vh}

/* Sidebar */
.sidebar{background:var(--panel);border-inline-end:1px solid var(--stroke);display:flex;flex-direction:column;min-width:260px;z-index:30}
.side-head{padding:10px;border-bottom:1px solid var(--stroke);display:flex;align-items:center;gap:8px}
.toggle{width:42px;height:42px;border-radius:12px;border:1px solid var(--stroke);background:#141821;color:#fff;font-weight:900;display:flex;align-items:center;justify-content:center;cursor:pointer}
:root.light .toggle{background:#eef1f8;color:#0b1220}
.sub-badge{margin-inline-start:auto;font-size:12px;padding:8px 10px;border:1px solid var(--stroke);border-radius:999px;background:#0e1422;white-space:nowrap}
:root.light .sub-badge{background:#eef2fb;color:#0b1220}
.btn{height:48px;border-radius:12px;border:1px solid var(--stroke);background:#141821;color:#fff;display:flex;align-items:center;justify-content:center;gap:8px;font-weight:700;cursor:pointer;padding:0 14px}
:root.light .btn{background:#eef1f8;color:#0b1220}
.btn.primary{background:var(--brand);border-color:transparent;color:#fff}
.btn.flat{background:transparent}
.btn[disabled]{opacity:.6;cursor:not-allowed}
.list{flex:1;overflow:auto;padding:8px 6px}
.item{padding:10px 12px;border-radius:10px;border:1px solid transparent;display:flex;align-items:center;gap:8px}
.item:hover{background:#151a23}:root.light .item:hover{background:#eef2fb}
.item.active{background:#0f1420;border-color:#2b3342}:root.light .item.active{background:#eaf0ff;border-color:#cfd9ff}
.item-title{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.item-ops{display:flex;gap:6px}
.side-foot{padding:10px;border-top:1px solid var(--stroke);display:flex;flex-direction:column;gap:8px}
.small{font-size:12px;color:var(--muted)}
#sideOverlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:20}

/* Main */
.main{display:grid;grid-template-rows:auto 1fr auto;min-width:0;min-height:0;position:relative;z-index:10;background:#0b0d12}
:root.light .main{background:#f6f7fb}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--stroke);background:linear-gradient(180deg,#0d1016,#0c0d10)}
:root.light .topbar{background:linear-gradient(180deg,#ffffff,#f1f3f8)}
.topbar .left{display:flex;gap:8px;align-items:center}

/* Messages */
.msgs{overflow:auto;-webkit-overflow-scrolling:touch;min-height:0;background:#0a0c11;padding:16px;padding-bottom:88px}
:root.light .msgs{background:#f6f7fb}
.msg {
    max-width: 92%;
    padding: 12px 14px;
    border-radius: 16px;
    margin: 8px 0;
    border: 1px solid var(--stroke);
    line-height: 1.0;  /* ØµØ§Ø± 1.5 Ø¨Ø¯Ù„ 1.6 */
    word-wrap: break-word;
    white-space: pre-wrap;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,"Tajawal",sans-serif;
    font-size: 12px;  /* Ø²ÙŠØ¯ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± */
}
.msg.user{margin-right:auto;background:var(--user-dark);color:#e9ecf1}
.msg.bot{margin-left:auto;background:var(--bot-dark);border-color:#283047}
:root.light .msg.user{background:var(--user-light);color:#fff}
:root.light .msg.bot{background:#fff;border-color:#dbe1ea;color:#0b1220}
.empty-hero{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:8px;color:#cfd6e6;text-align:center}
.empty-hero .name{font-size:24px;font-weight:900;color:#dbe5ff}
.empty-hero .sub{font-size:16px;color:#a7b1c6}
.logoMark{width:84px;height:84px}

/* Math messages */
.msg.math{direction:ltr;text-align:left;max-width:98%}
.msg.math .mjx-container{font-size:10%}

/* Input row */
.inputRow{display:flex;gap:8px;padding:10px 12px;border-top:1px solid var(--stroke);background:#0e1016;position:sticky;bottom:0}
:root.light .inputRow{background:#ffffff}
.input{flex:1;height:48px;border-radius:22px;border:1px solid transparent;background:#0b0e16;color:var(--text);padding:0 14px;outline:none;-webkit-user-select:text;user-select:text;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Tajawal",sans-serif}
:root.light .input{background:#f8faff;color:#0b1220}
.send,.attach{width:52px;min-width:52px;border-radius:50%;border:1px solid var(--stroke)}
.send{background:var(--brand);color:#fff;font-weight:900}
.attach{background:#1d2330;color:#fff;font-size:22px;font-weight:900;line-height:48px}
.attach-chip{display:flex;align-items:center;gap:10px;background:#161b26;border:1px solid var(--stroke);border-radius:14px;padding:8px 10px;max-width:65%}
.attach-chip .thumb{width:28px;height:28px;border-radius:6px;overflow:hidden;border:1px solid var(--stroke)}
.attach-chip .thumb img{width:100%;height:100%;object-fit:cover}
.attach-chip .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px}
.attach-chip .x{margin-inline-start:auto;cursor:pointer;border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;border:1px solid var(--stroke)}
.attach-wrap{position:absolute;bottom:70px;right:14px}

/* Pages */
.page{position:fixed;inset:0;background:var(--panel);display:none;z-index:40;padding:14px;border:1px solid var(--stroke);overflow:auto}
.page .head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.block{padding:10px;border-bottom:1px solid var(--stroke)}
.block .title{font-weight:800;margin-bottom:6px}

/* Admin cards */
.cards{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.cardStat{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:14px}
.cardStat .name{font-weight:800;font-size:14px;color:var(--muted);margin-bottom:8px}
.cardStat .num{font-weight:900;font-size:26px}

/* AUTH (Home with 3 buttons) */
.auth{display:none;align-items:center;justify-content:center;position:fixed;inset:0}
.authCard{width:92%;max-width:520px;background:var(--panel);border:1px solid var(--stroke);border-radius:16px;padding:16px;text-align:center}
.authBtns{display:flex;flex-direction:column;gap:10px;margin-top:12px}
.logoRow{display:flex;flex-direction:column;align-items:center;gap:8px}
.brandName{font-weight:900;font-size:22px}
.tosRow{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:12px;margin-top:6px;justify-content:center}

/* Paywall */
.paywall{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:60}
.paybox{width:92%;max-width:420px;background:var(--panel);border:1px solid var(--stroke);border-radius:14px;padding:16px;text-align:center}
.paybox .tg{display:inline-flex;align-items:center;gap:8px;background:#229ED9;border:1px solid #229ED9;color:#fff;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer;text-decoration:none}

a{color:#9eb6ff}

/* Mobile */
@media (max-width:900px){
  #root{grid-template-columns:0 1fr}
  .sidebar{transform:translateX(100%);transition:transform .25s}
  .sidebar.open{transform:translateX(0)}
}

/* Theme Toggle */
.theme-toggle{position:fixed;top:12px;left:12px;z-index:1000}
.theme-btn{width:42px;height:42px;border-radius:50%;background:var(--panel);border:1px solid var(--stroke);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px}
</style>
</head>
<body>

<div class="theme-toggle">
  <button class="theme-btn" id="themeToggle">ğŸŒ™</button>
</div>

<div id="toast" class="toast"></div>

<!-- Boot -->
<div id="boot">
  <span>Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„</span>
  <div class="dot"></div><div class="dot"></div><div class="dot"></div>
</div>

<!-- AUTH HOME -->
<section class="auth" id="auth">
  <div class="authCard">
    <div class="logoRow">
      <!-- Ø´Ø¹Ø§Ø± -->
      <svg class="logoMark" viewBox="0 0 128 128" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="Logo">
        <defs><linearGradient id="g" x1="0" y1="0" x2="128" y2="128"><stop stop-color="#6d83ff"/><stop offset="1" stop-color="#3b57ff"/></linearGradient></defs>
        <path d="M16 46L64 26l48 20-48 20-48-20Z" fill="url(#g)"/>
        <path d="M32 58l32 14 32-14v14c0 10-14 18-32 18s-32-8-32-18V58Z" fill="#2a2f43"/>
        <circle cx="104" cy="73" r="6" fill="#4a6bff"/>
        <circle cx="42" cy="94" r="6" fill="#7ea0ff"/><circle cx="86" cy="94" r="6" fill="#7ea0ff"/>
        <path d="M42 94h44" stroke="#9fb3ff" stroke-width="3" stroke-linecap="round"/>
      </svg>
      <div class="brandName">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ ÙÙŠ Ø§Ù„Ø³Ø§Ø¯Ø³</div>
    </div>

    <div class="authBtns">
      <button class="btn" id="btnGoGoogle">Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Google ğŸŒ</button>
      <button class="btn" id="btnGoPw">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ğŸ”</button>
      <button class="btn" id="btnGoSignup">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ ğŸ“</button>
    </div>

    <label class="tosRow"><input type="checkbox" id="tos"> <span>Ø£ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø®ØµÙˆØµÙŠØ©</span></label>
    <div id="authError" style="color:var(--err);margin-top:6px;font-size:13px"></div>
  </div>
</section>

<!-- Google page -->
<div class="page" id="pageGoogle">
  <div class="head">
    <h3 style="margin:0">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Google</h3>
    <button class="btn flat" data-back>Ø±Ø¬ÙˆØ¹</button>
  </div>
  <div class="block">
    <div class="title">Ø§Ø®ØªØ± Ø­Ø³Ø§Ø¨Ù‹Ø§ Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ</div>
    <p style="color:var(--muted)">Ø³ÙŠÙÙØªØ­ Ù…ÙÙ†ØªÙ‚ÙŠ Ø­Ø³Ø§Ø¨Ø§Øª Google.</p>
    <button class="btn primary" id="googleBtn">
      <span id="gTxt">ÙØªØ­ Ù…ÙÙ†ØªÙ‚ÙŠ Ø­Ø³Ø§Ø¨Ø§Øª Google</span>
      <span id="gSpin" class="hidden">â€¦ Ø¬Ø§Ø±Ù Ø§Ù„ÙØªØ­</span>
    </button>
    <div id="gErr" style="color:var(--err);margin-top:8px;font-size:13px"></div>
  </div>
</div>

<!-- Password Login -->
<div class="page" id="pageLoginPw">
  <div class="head">
    <h3 style="margin:0">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
    <button class="btn flat" data-back>Ø±Ø¬ÙˆØ¹</button>
  </div>
  <div class="block">
    <input class="input" id="emailLogin" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" autocomplete="email" inputmode="email">
    <div style="height:8px"></div>
    <input class="input" id="passLogin" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" autocomplete="current-password">
    <div style="height:12px"></div>
    <button class="btn primary" id="loginBtn"><span id="loginTxt">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span><span id="loginSpin" class="hidden">â€¦ Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span></button>
    <div style="margin-top:8px"><a href="#" id="reset">Ù‡Ù„ Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ØŸ</a></div>
  </div>
</div>

<!-- Signup -->
<div class="page" id="pageSignup">
  <div class="head">
    <h3 style="margin:0">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h3>
    <button class="btn flat" data-back>Ø±Ø¬ÙˆØ¹</button>
  </div>
  <div class="block">
    <input class="input" id="emailSignup" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" autocomplete="email" inputmode="email">
    <div style="height:8px"></div>
    <input class="input" id="passSignup" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" autocomplete="new-password">
    <div style="height:8px"></div>
    <input class="input" id="passSignup2" type="password" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" autocomplete="new-password">
    <div style="height:12px"></div>
    <button class="btn primary" id="signupBtn"><span id="signupTxt">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</span><span id="signupSpin" class="hidden">â€¦ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨</span></button>
    <div id="signupMsg" style="margin-top:8px;color:var(--ok)"></div>
  </div>
</div>

<!-- App -->
<section id="root">
  <div id="sideOverlay"></div>

  <aside class="sidebar" id="sidebar">
    <div class="side-head">
      <button class="toggle" id="closeSide" title="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
      <div id="subBadge" class="sub-badge">â€”</div>
    </div>
    <div class="list" id="chatList"></div>
<div class="side-foot">
  <div class="small" id="userEmail">â€”</div>
  <button class="btn" id="adminBtn" title="Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…" style="display:none">ğŸ‘‘ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
  
  <!-- Ø²ÙŠØ¯ Ù‡Ø§Ù„Ø²Ø± Ù‡Ù†Ø§ -->
  <button class="btn" id="themeToggleSidebar">ğŸŒ™ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø³Ù…Ø©</button>
  
  <button class="btn" id="logout">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="left"><button class="toggle" id="openSide" title="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">â˜°</button></div>
      <div class="right"><button class="btn primary" id="startChatTop">+ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©</button></div>
    </div>

    <div class="msgs" id="msgs"></div>

    <div class="inputRow" id="inputRow">
      <input class="input" id="input" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§â€¦" autocomplete="off" inputmode="text">
      <button class="attach" id="attach" title="Ø¥Ø¶Ø§ÙØ©">+</button>
      <button class="send" id="send">â¤</button>
      <input id="imgFile" type="file" class="hidden" accept="image/*">
      <div id="attachWrap" class="attach-wrap hidden"></div>
    </div>
  </main>
</section>

<!-- Admin Hub -->
<div class="page" id="pageHub">
  <div class="head"><h3 style="margin:0">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø§Ù„Ùƒ</h3><button class="btn" data-back>Ø±Ø¬ÙˆØ¹</button></div>
  <div class="hr" style="height:1px;background:var(--stroke);margin:10px 0"></div>
  <div class="block"><button class="btn" id="tileUsers">ğŸ‘¥ Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button></div>
  <div class="block"><button class="btn" id="tileSubs">â° Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</button></div>
  <div class="block"><button class="btn" id="tileTrain">ğŸ§  ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø°ÙƒØ§Ø¡</button></div>
</div>

<!-- Users page -->
<div class="page" id="pageUsers">
  <div class="head"><h3 style="margin:0">ğŸ‘¥ Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3><button class="btn" data-back>Ø±Ø¬ÙˆØ¹</button></div>
  <div class="hr" style="height:1px;background:var(--stroke);margin:10px 0"></div>
  <div class="cards">
    <div class="cardStat"><div class="name">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div><div class="num" id="statTotal">â€”</div></div>
    <div class="cardStat"><div class="name">Ø§Ù„Ù†Ø´Ø·ÙˆÙ† Ø§Ù„Ø¢Ù†</div><div class="num" id="statActiveNow">â€”</div></div>
    <div class="cardStat"><div class="name">Ù…Ø³ØªØ®Ø¯Ù…Ùˆ Ø§Ù„ÙŠÙˆÙ…</div><div class="num" id="statUsersToday">â€”</div></div>
    <div class="cardStat"><div class="name">Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙŠÙˆÙ…</div><div class="num" id="statMsgsToday">â€”</div></div>
  </div>
</div>

<!-- Subs page -->
<div class="page" id="pageSubs">
  <div class="head"><h3 style="margin:0">â° Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</h3><button class="btn" data-back>Ø±Ø¬ÙˆØ¹</button></div>
  <div class="hr" style="height:1px;background:var(--stroke);margin:10px 0"></div>

  <div class="block">
    <div class="title">â• Ø²ÙŠØ§Ø¯Ø© Ù…Ø¯Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <input class="input" id="subEmail" placeholder="Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
      <input class="input" id="subDays" type="number" placeholder="Ø£ÙŠØ§Ù…" style="width:130px">
      <button class="btn primary" id="addDays">ØªÙ†ÙÙŠØ°</button>
    </div>
    <div id="subMsg" style="margin-top:8px;color:var(--ok)"></div>
  </div>

  <div class="block">
    <div class="title">ğŸ›‘ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙˆØ±Ù‹Ø§</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <input class="input" id="cancelEmail" placeholder="Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
      <button class="btn" id="cancelSub">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</button>
    </div>
    <div id="cancelMsg" style="margin-top:8px;color:var(--ok)"></div>
  </div>

  <!-- Ù‚Ø³Ù… Ø­Ø¸Ø± Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø¶Ø§Ù -->
  <div class="block">
    <div class="title">ğŸš« Ø­Ø¸Ø± Ø£Ø¬Ù‡Ø²Ø©</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <input class="input" id="blockDeviceId" placeholder="Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù‡Ø§Ø²">
      <input class="input" id="blockReason" placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø¸Ø±">
      <button class="btn" id="blockDeviceBtn">Ø­Ø¸Ø± Ø§Ù„Ø¬Ù‡Ø§Ø²</button>
    </div>
    <div id="blockMsg" style="margin-top:8px"></div>
  </div>
</div>

<!-- Train page -->
<div class="page" id="pageTrain">
  <div class="head"><h3 style="margin:0">ğŸ§  ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø°ÙƒØ§Ø¡</h3><button class="btn" data-back>Ø±Ø¬ÙˆØ¹</button></div>
  <div class="hr" style="height:1px;background:var(--stroke);margin:10px 0"></div>
  
  <div class="block">
    <div class="title">âš™ï¸ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù†Ø¸Ø§Ù… (Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù…Ù†Ø¹/Ø§Ù„Ø³Ù…Ø§Ø­)</div>
    <textarea class="input" style="min-height:140px" id="trainRule" placeholder="Ø§ÙƒØªØ¨ Ø£ÙˆØ§Ù…Ø±/Ù‚ÙˆØ§Ø¹Ø¯ Ù„Ù„Ù†Ø¸Ø§Ù…â€¦"></textarea>
    <div style="height:8px"></div>
    <button class="btn primary" id="saveRule">Ø­ÙØ¸ Ø§Ù„Ø£ÙˆØ§Ù…Ø± (Ù‚ÙˆØ§Ø¹Ø¯)</button>
    <div id="ruleMsg" style="margin-top:8px;color:var(--ok)"></div>
  </div>
  
  <div class="block">
    <div class="title">ğŸ“ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</div>
    <textarea class="input" style="min-height:140px" id="trainInfoText" placeholder="Ø£Ø¶Ù Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙˆÙ…Ø¹Ø§Ø±Ù ÙŠØ±Ø¯Ù‘ Ø¨Ù‡Ø§ Ø§Ù„Ø°ÙƒØ§Ø¡â€¦"></textarea>
    <div style="height:8px"></div>
    <button class="btn primary" id="saveInfo">Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</button>
    <div id="infoMsg" style="margin-top:8px;color:var(--ok)"></div>
  </div>
  
  <div class="block">
    <div class="title">ğŸ“š Ø¥Ø¶Ø§ÙØ© Ù…Ù„ÙØ§Øª PDF</div>
    <input type="file" id="pdfInput" accept=".pdf" multiple class="hidden">
    <div style="display:flex; gap:8px; flex-wrap:wrap">
      <button class="btn" id="pickPdf">Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„ÙØ§Øª PDF</button>
      <button class="btn primary" id="processPdfs">Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„ÙØ§Øª</button>
    </div>
    <div style="height:8px"></div>
    <div id="fileList"></div>
    <div style="height:10px"></div>
    <div style="height:8px;background:#0b0f18;border:1px solid var(--stroke);border-radius:6px;overflow:hidden">
      <div class="bar" id="pdfBar" style="height:100%;background:var(--brand);width:0%"></div>
    </div>
    <div id="trainInfo" style="margin-top:8px;color:var(--muted);font-size:13px;white-space:pre-wrap"></div>
  </div>
</div>

<!-- Paywall -->
<div class="paywall" id="paywall">
  <div class="paybox">
    <h3 style="margin:0 0 6px 0">Ø§Ù†ØªÙ‡Øª ØªØ¬Ø±Ø¨ØªÙƒ/Ø§Ø´ØªØ±Ø§ÙƒÙƒ</h3>
    <p>Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ.</p>
    <a class="tg" href="https://t.me/MSLM_ALMYALY" target="_blank">ğŸ“¨ Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ</a>
    <div class="hr" style="height:1px;background:var(--stroke);margin:12px 0"></div>
    <button class="btn" id="closePaywall">Ø­Ø³Ù†Ù‹Ø§</button>
  </div>
</div>

<script>
/* ===== Ø£Ø¯ÙˆØ§Øª Ø¹Ø§Ù…Ø© ===== */
const $=(s)=>document.querySelector(s);
const saveLocal=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v));}catch{}};
const loadLocal=(k,d=null)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d;}catch{return d;}};
const SAFE_TOKENS=/[^\sA-Za-z0-9\u0600-\u06FF\u2070-\u209F\u2190-\u21FF\u2200-\u22FF\u00B0\u03A0-\u03FF\(\)\[\]\{\}\+\-\*\/=<>^_%.,:;|\\~âˆšâˆ‘âˆ†Â±Â°Î¼Ï€Î©Î±Î²Î³Î´ÎµÎ¶Î·Î¸Î¹ÎºÎ»Î¼Î½Î¾Î¿Ï€ÏÏƒÏ„Ï…Ï†Ï‡ÏˆÏ‰Ã—Ã·â€°â‚â‚‚â‚ƒâ‚„â‚…â‚†â‚‡â‚ˆâ‚‰]/g;
const toast=(t)=>{const el=document.getElementById('toast');el.textContent=t;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),1800)}

const ADMIN_EMAIL="mslmalmyaly223@gmail.com";
const firebaseConfig={apiKey:"AIzaSyD915Zh1Gzl60Z9Y5SBlls1S4tedgzU6hE",authDomain:"student-market-5940e.firebaseapp.com",projectId:"student-market-5940e",storageBucket:"student-market-5940e.appspot.com"};
const AI_ENDPOINT = "https://api.deepseek.com/v1/chat/completions";
const AI_KEY = "sk-ff429bca45194b3c87dacda66d63bfb5";

let THEME=loadLocal("THEME","dark");
function applyTheme(){ 
    if(THEME==="light") {
        document.documentElement.classList.add("light");
        $("#themeToggle").textContent="â˜€ï¸";
    } else {
        document.documentElement.classList.remove("light");
        $("#themeToggle").textContent="ğŸŒ™";
    } 
}

// ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø³Ù…Ø©
$("#themeToggle").onclick = () => {
    THEME = THEME === "dark" ? "light" : "dark";
    saveLocal("THEME", THEME);
    applyTheme();
};

$("#openSide")?.addEventListener("click",()=>{ $("#sidebar").classList.add("open"); $("#sideOverlay").style.display="block"; });
$("#closeSide")?.addEventListener("click",closeSidebar);
$("#sideOverlay")?.addEventListener("click",closeSidebar);
function closeSidebar(){ $("#sidebar").classList.remove("open"); $("#sideOverlay").style.display="none"; }

/* Firebase */
try {
    firebase.initializeApp(firebaseConfig);
} catch (error) {
    if (!/already exists/.test(error.message)) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Firebase:', error);
    }
}
const auth=firebase.auth(), db=firebase.firestore();
try{auth.useDeviceLanguage();}catch{}
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});

/* Boot/App/Auth */
const boot=$("#boot"), app=$("#root"), authView=$("#auth");
function showBoot(){ boot.style.display="flex"; app.style.display="none"; authView.style.display="none"; }
function showApp(){ boot.style.display="none"; app.style.display="grid"; authView.style.display="none"; }
function showAuth(){ boot.style.display="none"; app.style.display="none"; authView.style.display="flex"; }
showBoot();

/* Ø­Ø§Ù„Ø© Ø¹Ø§Ù…Ø© */
let me=null,currentChatId=null,canChat=true;
let index=null,knowledgeChunks=[],rulesMemo="";
const msgs=$("#msgs"),input=$("#input"),inputRow=$("#inputRow");
let pageStack=[];
let attachedImage=null;
let attachToken=0;
const attachWrap=$("#attachWrap");
const ENABLE_OCR=true;

// ØªØ®Ø²ÙŠÙ† ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
let currentChatHistory = [];

/* ===== Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªØ±ÙƒÙŠØ²/Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„ ===== */
function scrollIntoViewIfNeeded(el){ 
    try{ 
        el.scrollIntoView({block:"nearest", behavior:"smooth"}); 
    }catch{} 
}

// Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙ…Ø±ÙŠØ± - Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø®Ù„Ù
msgs.addEventListener('scroll', function() {
    // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ
});

// Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
["focusin","click","touchend"].forEach(ev=>{
    document.addEventListener(ev,(e)=>{
        const t=e.target;
        if(t && (t.tagName==="INPUT"||t.tagName==="TEXTAREA")) {
            setTimeout(()=>{
                if(document.activeElement === t) {
                    scrollIntoViewIfNeeded(t);
                }
            },100);
        }
    },{passive:true});
});

// Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ - Ù„Ø§ ÙŠØ³Ø±Ù‚ Ø§Ù„ØªØ±ÙƒÙŠØ²
msgs.addEventListener("click",(e)=>{
    if(e.target.classList.contains('msg')) {
        setTimeout(() => input.focus(), 50);
    }
},{passive:true});

let streamingEl=null, streamedText="";
let isStreaming=false;
let currentStream={id:null,chatId:null,controller:null};
function cancelCurrentStream(){
    if(currentStream.controller){ try{ currentStream.controller.abort(); }catch{} }
    currentStream={id:null,chatId:null,controller:null};
    isStreaming=false; streamingEl=null; streamedText="";
}

/* Ø¶Ø¨Ø· Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
function adjustMsgsPadding(){ const h=inputRow.getBoundingClientRect().height; msgs.style.paddingBottom=(h+16)+"px"; }
new ResizeObserver(adjustMsgsPadding).observe(inputRow);

/* ===== Ø§Ø´ØªØ±Ø§Ùƒ ÙˆØªØ¬Ø±Ø¨Ø© ===== */
let userProfileCache=null,timerId=null;
function watchUserProfileCountdown(){
    return db.collection("users").doc(me.uid).onSnapshot(s=>{
        userProfileCache=s.data()||{};
        renderDaysBadge();
        if(timerId) clearInterval(timerId);
        timerId=setInterval(renderDaysBadge,1000);
    });
}

function renderDaysBadge(){
    try{
        const p=userProfileCache||{};
        if (p.blocked === true) {
            $("#subBadge").textContent="ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ø´ØªØ±Ø§ÙƒÙƒ";
            canChat=false; $("#paywall").style.display="flex"; return;
        }
        const start=p.trialStart?.toDate?p.trialStart.toDate():new Date();
        const endTrial=new Date(start.getTime() + 24 * 60 * 60 * 1000); // ØªØºÙŠÙŠØ± Ø¥Ù„Ù‰ 24 Ø³Ø§Ø¹Ø© ÙÙ‚Ø·
        const subEnd=p.subscriptionEnd?.toDate?p.subscriptionEnd.toDate():null;
        const now=new Date();
        const end=(p.subscribed&&subEnd)?subEnd:endTrial;
        const left=end-now;
        const badge=$("#subBadge");
        if(left<=0){
            badge.textContent="Ø§Ù†ØªÙ‡Øª Ø§Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©";
            canChat=false;
            $("#paywall").style.display="flex";
            return;
        }
        canChat=true; $("#paywall").style.display="none";

        const days=Math.floor(left/(24*60*60*1000));
        const hours=Math.floor((left%(24*60*60*1000))/(60*60*1000));
        const minutes=Math.floor((left%(60*60*1000))/(60*1000));
        const seconds=Math.floor((left%(60*1000))/1000);
        
        if(days>0){
            badge.textContent=`Ù…ØªØ¨Ù‚ÙŠ ${days} ÙŠÙˆÙ… Ùˆ${hours} Ø³Ø§Ø¹Ø©`; 
        } else if(hours>0){
            badge.textContent=`Ù…ØªØ¨Ù‚ÙŠ ${hours} Ø³Ø§Ø¹Ø© Ùˆ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
        } else {
            badge.textContent=`Ù…ØªØ¨Ù‚ÙŠ ${minutes} Ø¯Ù‚ÙŠÙ‚Ø© Ùˆ${seconds} Ø«Ø§Ù†ÙŠØ©`;
        }
    }catch{ $("#subBadge").textContent="â€”"; }
}

/* ===== Ø¥ØµÙ„Ø§Ø­ ÙƒØ§Ù…Ù„ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google ===== */
function mustAcceptTOS(){ return $("#tos").checked; }
function showErr(t){ $("#authError").textContent=t; setTimeout(()=>$("#authError").textContent="",5000); }
$("#btnGoGoogle").onclick=()=>{ if(!mustAcceptTOS()) return showErr("ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ· Ø£ÙˆÙ„Ø§Ù‹."); openPage("#pageGoogle"); };
$("#btnGoPw").onclick   =()=>{ if(!mustAcceptTOS()) return showErr("ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ· Ø£ÙˆÙ„Ø§Ù‹."); openPage("#pageLoginPw"); };
$("#btnGoSignup").onclick=()=>{ if(!mustAcceptTOS()) return showErr("ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ· Ø£ÙˆÙ„Ø§Ù‹."); openPage("#pageSignup"); };

$("#googleBtn").onclick=async ()=>{
    const btn=$("#googleBtn"), t=$("#gTxt"), s=$("#gSpin");
    btn.disabled=true; t.classList.add("hidden"); s.classList.remove("hidden");
    
    try {
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.addScope('email');
        provider.addScope('profile');
        
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø­Ø³Ù†Ø© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø¶Ù…Ù†Ø©
        provider.setCustomParameters({
            prompt: 'select_account',
            display: 'popup'
        });

        const isWebView = /Telegram|Twitter|Facebook|Line|KAKAOTALK|Instagram|Snapchat|WebView|FBAN|FBAV/i.test(navigator.userAgent);
        
        if (isWebView) {
            // Ù„Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø¶Ù…Ù†Ø© Ù…Ø«Ù„ Telegram
            await auth.signInWithRedirect(provider);
            return;
        } else {
            // Ù„Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
            try {
                await auth.signInWithPopup(provider);
            } catch (popupErr) {
                console.log('Popup failed, trying redirect:', popupErr);
                await auth.signInWithRedirect(provider);
                return;
            }
        }
        
    } catch (error) {
        console.error('Google Auth Error:', error);
        let errorMessage = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
        
        if (error.code === 'auth/unauthorized-domain') {
            errorMessage = "Ø§Ù„Ù†Ø·Ø§Ù‚ ØºÙŠØ± Ù…ØµØ±Ø­ Ø¨Ù‡. ÙŠØ±Ø¬Ù‰ ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ Ù…ØªØµÙØ­ Ø¹Ø§Ø¯ÙŠ.";
        } else if (error.code === 'auth/popup-blocked') {
            errorMessage = "ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹.";
        } else if (error.code === 'auth/popup-closed-by-user') {
            errorMessage = "ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
        } else if (error.code === 'auth/network-request-failed') {
            errorMessage = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.";
        } else {
            errorMessage = error.message || "ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Google";
        }
        
        $("#gErr").textContent = errorMessage;
        btn.disabled = false;
        t.classList.remove("hidden");
        s.classList.add("hidden");
    }
};

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ù†ØªÙŠØ¬Ø© Redirect
auth.getRedirectResult().then((result) => {
    if (result.user) {
        console.log('Redirect login successful:', result.user.email);
        fastAfterAuth("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!");
    }
}).catch((error) => {
    console.log('Redirect result error:', error);
    if (error.code !== 'auth/unknown') {
        $("#gErr").textContent = "ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + (error.message || "Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ");
    }
});

/* Password Login */
$("#loginBtn").onclick=async ()=>{
    const email=$("#emailLogin").value.trim(), pass=$("#passLogin").value.trim();
    if(!email||!pass) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±.");
    const btn=$("#loginBtn"), txt=$("#loginTxt"), spin=$("#loginSpin");
    btn.disabled=true; txt.classList.add("hidden"); spin.classList.remove("hidden");
    try{
        await auth.signInWithEmailAndPassword(email, pass);
    }catch(e){
        alert(e.message);
        btn.disabled=false; txt.classList.remove("hidden"); spin.classList.add("hidden");
    }
};

/* Reset password */
$("#reset").onclick=async (e)=>{
    e.preventDefault();
    const email=prompt("Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ:");
    if(email){ try{ await auth.sendPasswordResetEmail(email); alert("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„."); }catch(err){ alert(err.message);} }
};

// ===== Ù†Ø¸Ø§Ù… Ù…Ù†Ø¹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ù…Ø­Ø³Ù† =====

// Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„Ù„Ø¬Ù‡Ø§Ø² Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡
async function getDeviceId() {
    try {
        let deviceId = localStorage.getItem('deviceFingerprint');
        
        if (!deviceId) {
            // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ØµÙ…Ø© Ø¬Ù‡Ø§Ø² ÙØ±ÙŠØ¯Ø© Ù…Ù† Ø¹Ø¯Ø© Ù…ØµØ§Ø¯Ø±
            const components = [];
            
            // 1. Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØµÙØ­
            const navigatorData = {
                userAgent: navigator.userAgent,
                language: navigator.language,
                languages: navigator.languages?.join(','),
                platform: navigator.platform,
                hardwareConcurrency: navigator.hardwareConcurrency || 'unknown',
                deviceMemory: navigator.deviceMemory || 'unknown'
            };
            
            // 2. Ø´Ø§Ø´Ø© Ø§Ù„Ø¬Ù‡Ø§Ø²
            const screenData = {
                width: screen.width,
                height: screen.height,
                colorDepth: screen.colorDepth,
                pixelDepth: screen.pixelDepth
            };
            
            // 3. Ø§Ù„Ø·Ø§Ø¨Ø¹ Ø§Ù„Ø²Ù…Ù†ÙŠ
            const timeData = {
                timezone: new Date().getTimezoneOffset(),
                timestamp: Date.now()
            };
            
            // Ø¯Ù…Ø¬ ÙƒÙ„ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª
            const fingerprintData = JSON.stringify({
                nav: navigatorData,
                screen: screenData,
                time: timeData
            });
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø§Ø´ ÙØ±ÙŠØ¯
            deviceId = 'device_' + await generateHash(fingerprintData);
            localStorage.setItem('deviceFingerprint', deviceId);
            
            // Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
            localStorage.setItem('deviceBackup', deviceId);
        }
        
        return deviceId;
    } catch (error) {
        console.error('Error generating device ID:', error);
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø¯ÙŠÙ„ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
        return 'fallback_device_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
    }
}

// Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø§Ø´ Ø¨Ø³ÙŠØ·
async function generateHash(str) {
    try {
        const encoder = new TextEncoder();
        const data = encoder.encode(str);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        return hashHex.substr(0, 16); // Ø£Ø®Ø° Ø£ÙˆÙ„ 16 Ø­Ø±Ù
    } catch (error) {
        // Ø¨Ø¯ÙŠÙ„ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† crypto Ù…ØªØ§Ø­
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash;
        }
        return Math.abs(hash).toString(36);
    }
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ IP Ø­Ù‚ÙŠÙ‚ÙŠ Ù…Ù† Ø¹Ø¯Ø© Ù…ØµØ§Ø¯Ø±
async function getIPAddress() {
    try {
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ù† Ù…ØµØ¯Ø± Ø£ÙˆÙ„
        try {
            const response = await fetch('https://api.ipify.org?format=json', { timeout: 5000 });
            const data = await response.json();
            if (data && data.ip) return data.ip;
        } catch (e) {}
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ù† Ù…ØµØ¯Ø± Ø«Ø§Ù†ÙŠ
        try {
            const response = await fetch('https://api64.ipify.org?format=json', { timeout: 5000 });
            const data = await response.json();
            if (data && data.ip) return data.ip;
        } catch (e) {}
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ù† Ù…ØµØ¯Ø± Ø«Ø§Ù„Ø«
        try {
            const response = await fetch('https://ipapi.co/json/', { timeout: 5000 });
            const data = await response.json();
            if (data && data.ip) return data.ip;
        } catch (e) {}
        
        return 'unknown_ip';
    } catch (error) {
        console.error('Error getting IP:', error);
        return 'failed_ip';
    }
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ù‚ÙˆØ©
async function checkExistingAccounts(email) {
    try {
        const deviceId = await getDeviceId();
        const ipAddress = await getIPAddress();
        
        console.log('Checking accounts for:', { email, deviceId, ipAddress });
        
        // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
        const emailQuery = await db.collection("users")
            .where("email", "==", email)
            .limit(1)
            .get();
            
        if (!emailQuery.empty) {
            return { 
                exists: true, 
                reason: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹",
                type: "email"
            };
        }

        // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù‡Ø§Ø² (Ø§Ù„Ø­Ø¯: Ø­Ø³Ø§Ø¨ÙŠÙ† ÙÙ‚Ø· Ù…Ù† Ù†ÙØ³ Ø§Ù„Ø¬Ù‡Ø§Ø²)
        const deviceQuery = await db.collection("users")
            .where("deviceId", "==", deviceId)
            .get();

        if (deviceQuery.size >= 2) {
            return { 
                exists: true, 
                reason: "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² (2 Ø­Ø³Ø§Ø¨ ÙÙ‚Ø·)",
                type: "device",
                count: deviceQuery.size
            };
        }

        // 3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ù†ÙˆØ§Ù† IP (Ø§Ù„Ø­Ø¯: 3 Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ù† Ù†ÙØ³ IP)
        const ipQuery = await db.collection("users")
            .where("ipAddress", "==", ipAddress)
            .get();

        if (ipQuery.size >= 3) {
            return { 
                exists: true, 
                reason: "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† IP (3 Ø­Ø³Ø§Ø¨Ø§Øª ÙÙ‚Ø·)",
                type: "ip",
                count: ipQuery.size
            };
        }

        // 4. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²
        const blockedQuery = await db.collection("blockedDevices")
            .where("deviceId", "==", deviceId)
            .limit(1)
            .get();

        if (!blockedQuery.empty) {
            const blockData = blockedQuery.docs[0].data();
            return { 
                exists: true, 
                reason: `Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù…Ø­Ø¸ÙˆØ± Ù…Ù† Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©. Ø§Ù„Ø³Ø¨Ø¨: ${blockData.reason || "Ø§Ù†ØªÙ‡Ø§Ùƒ Ø§Ù„Ø´Ø±ÙˆØ·"}`,
                type: "blocked"
            };
        }

        return { 
            exists: false,
            deviceId: deviceId,
            ipAddress: ipAddress
        };
    } catch (error) {
        console.error('Error checking existing accounts:', error);
        return { 
            exists: true, 
            reason: "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹."
        };
    }
}

// ØªØ³Ø¬ÙŠÙ„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ (Ù„Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©)
async function logAccountCreationAttempt(email, success, reason = "") {
    try {
        const deviceId = await getDeviceId();
        const ipAddress = await getIPAddress();
        
        await db.collection("accountAttempts").add({
            email: email,
            deviceId: deviceId,
            ipAddress: ipAddress,
            success: success,
            reason: reason,
            userAgent: navigator.userAgent,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
    } catch (error) {
        console.error('Error logging attempt:', error);
    }
}

// ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
$("#signupBtn").onclick = async ()=>{
    const email = $("#emailSignup").value.trim();
    const p1 = $("#passSignup").value.trim();
    const p2 = $("#passSignup2").value.trim();
    
    if(!email || !p1 || !p2) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.");
    if(p1 !== p2) return alert("ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ø³Ø± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†.");
    if(p1.length < 6) return alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");
    
    const btn = $("#signupBtn"), txt = $("#signupTxt"), spin = $("#signupSpin");
    btn.disabled = true; 
    txt.classList.add("hidden"); 
    spin.classList.remove("hidden");

    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
        const checkResult = await checkExistingAccounts(email);
        
        if (checkResult.exists) {
            await logAccountCreationAttempt(email, false, checkResult.reason);
            alert(`âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: ${checkResult.reason}`);
            btn.disabled = false; 
            txt.classList.remove("hidden"); 
            spin.classList.add("hidden");
            return;
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨
        const userCredential = await auth.createUserWithEmailAndPassword(email, p1);
        const user = userCredential.user;
        const deviceId = checkResult.deviceId;
        const ipAddress = checkResult.ipAddress;

        // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        await db.collection("users").doc(user.uid).set({
            email: email,
            deviceId: deviceId,
            ipAddress: ipAddress,
            userAgent: navigator.userAgent,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            trialStart: firebase.firestore.FieldValue.serverTimestamp(),
            subscribed: false,
            subscriptionEnd: null,
            blocked: false,
            lastActive: firebase.firestore.FieldValue.serverTimestamp(),
            accountType: "trial"
        });

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù†Ø§Ø¬Ø­Ø©
        await logAccountCreationAttempt(email, true, "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­");
        
        $("#signupMsg").textContent = "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­ - Ù„Ø¯ÙŠÙƒ 24 Ø³Ø§Ø¹Ø© Ù…Ø¬Ø§Ù†ÙŠØ©";
        
    } catch(e) { 
        await logAccountCreationAttempt(email, false, e.message);
        
        if (e.code === 'auth/email-already-in-use') {
            alert("âŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹");
        } else if (e.code === 'auth/weak-password') {
            alert("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹");
        } else if (e.code === 'auth/invalid-email') {
            alert("âŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­");
        } else {
            alert(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: ${e.message}`); 
        }
    }
    
    btn.disabled = false; 
    txt.classList.remove("hidden"); 
    spin.classList.add("hidden");
};

/* onAuthStateChanged */
let initStarted=false, unsubProfile=null, unSubMsgs=null;
let CHAT_CACHE = loadLocal("CHAT_CACHE", []);

auth.onAuthStateChanged(async (u)=>{
    const btn=$("#googleBtn"), t=$("#gTxt"), s=$("#gSpin");
    if(btn){ btn.disabled=false; t?.classList.remove("hidden"); s?.classList.add("hidden"); }

    if(u){
        me=u;
        $("#userEmail").textContent=u.email||"";
        $("#adminBtn").style.display=(me?.email===ADMIN_EMAIL)?"block":"none";
        
        document.querySelectorAll(".page").forEach(p=>p.style.display="none");
        pageStack = [];
        
        fastAfterAuth();
    }else{
        showAuth();
    }
});

function fastAfterAuth(note){
    try{
        applyTheme(); adjustMsgsPadding(); showApp();
        if(note) toast(note);
        if(!initStarted){ 
            initStarted=true; 
            setTimeout(() => initApp(), 100);
        }
    }catch(e){console.error('fastAfterAuth error:', e)}
}

async function initApp(){
    try{
        await ensureUserDoc();
        unsubProfile = watchUserProfileCountdown();
        bindChatList();
        setTimeout(() => loadKnowledgeFromDB().catch(()=>{}), 500);
        await ensureFirstChat();
    }catch(e){console.error('initApp error:', e)}
}

/* Ø¥Ù†Ø´Ø§Ø¡/ØªØ­Ø¯ÙŠØ« Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
async function ensureUserDoc(){
    const ref=db.collection("users").doc(me.uid);
    const userDoc = await ref.get();
    
    if (!userDoc.exists) {
        await ref.set({
            email: me.email||null,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            trialStart: firebase.firestore.FieldValue.serverTimestamp(),
            subscribed: false,
            subscriptionEnd: null,
            blocked: false,
            lastActive: firebase.firestore.FieldValue.serverTimestamp()
        });
    } else {
        await ref.update({
            lastActive: firebase.firestore.FieldValue.serverTimestamp()
        });
    }
}

/* ===== Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ù…Ø­Ø³Ù†Ø© ===== */
function cacheSet(list){ CHAT_CACHE=list; saveLocal("CHAT_CACHE", list); }

function insertChatRowDom(id, title){
    const list=$("#chatList");
    if(list.querySelector(`.item[data-id="${id}"]`)) return;
    const row=document.createElement("div");
    row.className="item"+(id===currentChatId?" active":"");
    row.dataset.id=id;

    const t=document.createElement("div"); t.className="item-title"; t.textContent=title||"â€”";
    const ops=document.createElement("div"); ops.className="item-ops";

    const edit=document.createElement("button"); edit.className="btn"; edit.textContent="âœï¸";
    edit.onclick=async (e)=>{
        e.stopPropagation();
        const nt=prompt("Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯:", (t.textContent||"").trim() || "Ù…Ø­Ø§Ø¯Ø«Ø©");
        if(nt && nt!==t.textContent){
            t.textContent = nt;
            try{ await db.collection("chats").doc(id).update({title:nt, clientUpdated:Date.now(), updatedAt:firebase.firestore.FieldValue.serverTimestamp()}); }catch{}
            const arr = [{id, title:nt}, ...CHAT_CACHE.filter(x=>x.id!==id)];
            cacheSet(arr);
        }
    };
    const del=document.createElement("button"); del.className="btn"; del.textContent="ğŸ—‘ï¸";
    del.onclick=async (e)=>{ e.stopPropagation(); if(confirm("Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©ØŸ")) await deleteChat(id); };

    ops.appendChild(edit); ops.appendChild(del);
    row.appendChild(t); row.appendChild(ops);
    row.onclick=()=>{ loadChat(id); closeSidebar(); };
    list.prepend(row);
}

function bindChatList(){
    $("#chatList").innerHTML="";
    CHAT_CACHE.forEach(c=>insertChatRowDom(c.id, c.title));

    db.collection("chats").where("uid","==",me.uid).orderBy("clientUpdated","desc")
        .onSnapshot(snap=>{
            const list=$("#chatList"); 
            const arr=[];
            snap.forEach(doc=>{
                const c=doc.data(); const id=doc.id;
                arr.push({id, title:c.title||"Ù…Ø­Ø§Ø¯Ø«Ø©"});
                insertChatRowDom(id, c.title||"Ù…Ø­Ø§Ø¯Ø«Ø©");
            });
            cacheSet(arr);
            setActiveChatItem(currentChatId);
        }, ()=>{
            if($("#chatList").children.length===0){
                CHAT_CACHE.forEach(c=>insertChatRowDom(c.id, c.title));
            }
        });
}

// Ø¥ØµÙ„Ø§Ø­ Ø²Ø± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
$("#startChatTop").onclick = () => newChat();

function setActiveChatItem(id){
    document.querySelectorAll("#chatList .item").forEach(x=>x.classList.toggle("active", x.dataset.id===id));
}

async function ensureFirstChat(){
    const existing = await db.collection("chats").where("uid","==",me.uid).limit(1).get();
    if(!existing.empty){
        currentChatId = existing.docs[0].id;
        loadChat(currentChatId);
    }else{
        await newChat();
    }
}

// ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
async function updateChatTitle(chatId, firstMessage) {
    if (!firstMessage || firstMessage.length < 3) return;
    
    const title = firstMessage.length > 30 ? firstMessage.substring(0, 30) + '...' : firstMessage;
    
    try {
        await db.collection("chats").doc(chatId).update({
            title: title,
            clientUpdated: Date.now(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„ÙŠ
        const updatedCache = CHAT_CACHE.map(chat => 
            chat.id === chatId ? {...chat, title} : chat
        );
        cacheSet(updatedCache);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        const chatItem = document.querySelector(`.item[data-id="${chatId}"] .item-title`);
        if (chatItem) {
            chatItem.textContent = title;
        }
    } catch (error) {
        console.error('Error updating chat title:', error);
    }
}

async function newChat(){
    cancelCurrentStream();
    currentChatHistory = [];
    
    const ref=await db.collection("chats").add({
        uid:me.uid, 
        title:"Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©",
        clientUpdated: Date.now(),
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    currentChatId=ref.id;
    insertChatRowDom(ref.id, "Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©");
    const arr=[{id:ref.id, title:"Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©"}, ...CHAT_CACHE.filter(x=>x.id!==ref.id)];
    cacheSet(arr);
    setActiveChatItem(ref.id);
    loadChat(ref.id);
    return ref.id;
}

async function deleteChat(id){
    try{
        if(unSubMsgs && currentChatId===id){ unSubMsgs(); unSubMsgs=null; }
        const row=document.querySelector(`#chatList .item[data-id="${id}"]`); if(row) row.remove();
        cacheSet(CHAT_CACHE.filter(x=>x.id!==id));

        const ref=db.collection("chats").doc(id);
        const msgsSnap=await ref.collection("messages").get();
        const batch=db.batch(); msgsSnap.forEach(d=>batch.delete(ref.collection("messages").doc(d.id))); await batch.commit();
        await ref.delete();

        if(currentChatId===id){
            currentChatId=null; 
            currentChatHistory = [];
            msgs.innerHTML="";
            if(CHAT_CACHE[0]) loadChat(CHAT_CACHE[0].id);
            else await newChat();
        }
    }catch(e){ alert(e.message||e); }
}

/* Ø­Ø§Ù„Ø© Ù…Ø­Ø§Ø¯Ø«Ø© ÙØ§Ø±ØºØ© */
function renderEmptyHero(){
    msgs.innerHTML="";
    const wrap=document.createElement("div");
    wrap.className="empty-hero";
    wrap.innerHTML=`
        <svg class="logoMark" viewBox="0 0 128 128" fill="none" xmlns="http://www.w3.org/2000/svg">
            <defs><linearGradient id="gh" x1="0" y1="0" x2="128" y2="128"><stop stop-color="#6d83ff"/><stop offset="1" stop-color="#3b57ff"/></linearGradient></defs>
            <path d="M16 46L64 26l48 20-48 20-48-20Z" fill="url(#gh)"/>
            <path d="M32 58l32 14 32-14v14c0 10-14 18-32 18s-32-8-32-18V58Z" fill="#2a2f43"/>
            <circle cx="104" cy="73" r="6" fill="#4a6bff"/>
            <circle cx="42" cy="94" r="6" fill="#7ea0ff"/><circle cx="86" cy="94" r="6" fill="#7ea0ff"/>
            <path d="M42 94h44" stroke="#9fb3ff" stroke-width="3" stroke-linecap="round"/>
        </svg>
        <div class="name">Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ Ø£Ù†Ø§ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ ÙÙŠ Ø§Ù„Ø³Ø§Ø¯Ø³</div>
        <div class="sub">ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ</div>
    `;
    msgs.appendChild(wrap);
}

function watchMessages(chatId){
    return db.collection("chats").doc(chatId).collection("messages").orderBy("clientTs","asc")
        .onSnapshot(snap=>{
            if(isStreaming) return;
            
            currentChatHistory = [];
            let firstUserMessage = null;
            
            snap.forEach(doc=>{
                const msg = doc.data();
                currentChatHistory.push({
                    role: msg.role,
                    content: msg.text || ""
                });
                
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙˆÙ„ Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
                if (msg.role === "user" && !firstUserMessage) {
                    firstUserMessage = msg.text;
                }
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¬Ø¯ÙŠØ¯Ø©
            if (firstUserMessage && snap.size === 1) {
                updateChatTitle(chatId, firstUserMessage);
            }
            
            if(snap.empty){ 
                renderEmptyHero(); 
                return; 
            }
            msgs.innerHTML="";
            snap.forEach(doc=>{ renderMsg(doc.id, doc.data()); });
            msgs.scrollTo({top:msgs.scrollHeight+1000});
        });
}

async function loadChat(id){
    cancelCurrentStream();
    currentChatId=id; 
    currentChatHistory = [];
    setActiveChatItem(id);
    msgs.innerHTML="";
    if(unSubMsgs) unSubMsgs();
    unSubMsgs=watchMessages(id);
}

/* Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© */
function renderMsg(id, m){
    const isMath=/\\(frac|sqrt|sum|Delta|pi|times|div|rightarrow|left|right|alpha|beta|gamma|delta|epsilon|zeta|eta|theta|iota|kappa|lambda|mu|nu|xi|omicron|pi|rho|sigma|tau|upsilon|phi|chi|psi|omega|hbar|partial|nabla|infty|cdot|pm|mp|times|div|leq|geq|neq|approx|equiv|propto|perp|parallel|angle|circ|degree|vec|hat|tilde|dot|ddot|prime|int|oint|sum|prod|lim|exp|log|ln|sin|cos|tan|cot|sec|csc|arcsin|arccos|arctan|sinh|cosh|tanh|coth|sech|csch|det|dim|gcd|hom|ker|lg|ln|log|max|min|Pr|sup)|\$\$|H_2O|CO_2|CH_4|NaCl|H_2SO_4|NaOH|HCl/i.test(m.text||"");
    const who=m.role==="user"?"user":"bot";
    const img=m.imageDataURL||null;
    const html=(m.text||"").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    const el=document.createElement("div");
    el.className=`msg ${who}`+(isMath?" math":"");
    if(id) el.dataset.mid=id;
    el.dataset.role=m.role;
    if(img){ 
        const im=new Image(); 
        im.className="attachment"; 
        im.src=img; 
        im.style.maxWidth="200px";
        im.style.borderRadius="8px";
        el.appendChild(im); 
    }
    const box=document.createElement("div"); 
    box.style.cssText = "font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Tajawal', sans-serif; line-height: 1.6; word-wrap: break-word;";
    box.innerHTML=html; 
    el.appendChild(box);
    msgs.appendChild(el);
    if(isMath && window.MathJax) {
        MathJax.typesetPromise([el]).catch(()=>{});
    }
}

/* Ø­ÙØ¸ Ø±Ø³Ø§Ù„Ø© */
async function appendMessageStore(role,text,imageDataURL=null, forceChatId=null){
    const chatId = forceChatId || currentChatId;
    if(!chatId) return;
    const ref=db.collection("chats").doc(chatId).collection("messages");
    await ref.add({ role, text, imageDataURL, clientTs: Date.now(), ts: firebase.firestore.FieldValue.serverTimestamp() });
    await db.collection("chats").doc(chatId).update({ clientUpdated: Date.now(), updatedAt:firebase.firestore.FieldValue.serverTimestamp() });
    try{ await db.collection("users").doc(me.uid).update({ lastActive: firebase.firestore.FieldValue.serverTimestamp() }); }catch{}
}

/* ===== Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ù…Ø­Ø³Ù† ===== */
function arNormalize(s){ return (s||"").replace(/[\u0610-\u061A\u064B-\u065F\u06D6-\u06ED]/g,'').replace(/[Ø£Ø¥Ø¢]/g,'Ø§').replace(/Ù‰/g,'ÙŠ').replace(/Ø¤/g,'Ùˆ').replace(/Ø¦/g,'ÙŠ').replace(/Ø©/g,'Ù‡').replace(/[Ù€]+/g,'').toLowerCase(); }
function chunkAll(texts){ 
    const arr=[]; 
    texts.forEach(t=>{ 
        const clean=(t||"").replace(/(\.|\!|\ØŸ|\?|Ø›)/g,'$1\n'); 
        const parts=clean.split(/\n+/).map(x=>x.trim()).filter(Boolean); 
        let buf=""; 
        for(const line of parts){ 
            if((buf+" "+line).length<=700) buf=(buf?buf+" ":"")+line; 
            else { if(buf) arr.push(buf); buf=line; } 
        } 
        if(buf) arr.push(buf); 
    }); 
    return arr.slice(-2000); // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø³Ø¹Ø©
}

function buildIndex(chunks){
    const tokenize=s=>arNormalize(s).replace(SAFE_TOKENS," ").split(/\s+/).filter(w=>w.length>1);
    const docs=chunks.map(c=>({text:c,toks:tokenize(c)}));
    const df=new Map(); docs.forEach(d=>{[...new Set(d.toks)].forEach(w=>df.set(w,(df.get(w)||0)+1));});
    const N=docs.length||1;
    docs.forEach(d=>{
        const tf=new Map(); d.toks.forEach(w=>tf.set(w,(tf.get(w)||0)+1));
        d.vec=new Map();
        tf.forEach((f,w)=>{ const idf=Math.log((N+1)/((df.get(w)||1)+1))+1; d.vec.set(w,(f/d.toks.length)*idf);});
        delete d.toks;
    });
    index={docs,df:N?df:new Map(),N,tokenize};
}

function retrieve(q,k=8){ // Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    if(!index||!index.docs.length) return [];
    const qT=index.tokenize(q);
    const tf=new Map(); qT.forEach(w=>tf.set(w,(tf.get(w)||0)+1));
    const qV=new Map(); tf.forEach((f,w)=>{ const idf=Math.log((index.N+1)/((index.df.get(w)||1)+1))+1; qV.set(w,(f/qT.length)*idf);});
    const qn=norm(qV);
    const scored=index.docs.map(d=>({text:d.text,score:dot(qV,d.vec)/(qn*norm(d.vec))})).sort((a,b)=>b.score-a.score).slice(0,k);
    return scored.filter(s=>s.score>0.01).map(s=>s.text);
    function dot(a,b){let s=0;a.forEach((va,wa)=>{s+=va*(b.get(wa)||0)});return s}
    function norm(v){let s=0;v.forEach(x=>s+=x*x);return Math.sqrt(s)||1}
}

async function loadKnowledgeFromDB(){
    try {
        const s=await db.collection("knowledge").orderBy("createdAt","desc").limit(2000).get(); // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø­Ø¯
        const infoTexts=[]; 
        rulesMemo="";
        s.docs.forEach(d=>{
            const x=d.data(); 
            const t=(x.type||"").toLowerCase();
            if(t==="pdf" || t==="info" || t==="text"){
                const joined=[x.note?`Ù…Ù„Ø§Ø­Ø¸Ø©: ${x.note}`:"",x.text||""].join("\n").trim();
                if(joined) infoTexts.push(joined);
            }else if(t==="rule"){ 
                if(x.text) rulesMemo=(rulesMemo?rulesMemo+"\n":"")+x.text; 
            }
        });
        knowledgeChunks=chunkAll(infoTexts); 
        buildIndex(knowledgeChunks);
        console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø±ÙØ©:', knowledgeChunks.length, 'Ù‚Ø·Ø¹Ø©ØŒ Ø§Ù„Ø£ÙˆØ§Ù…Ø±:', rulesMemo.length, 'Ø­Ø±Ù');
    } catch(e) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø±ÙØ©:', e);
    }
}

/* ===== Ø¥ØµÙ„Ø§Ø­ Ø£Ø²Ø±Ø§Ø± Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ===== */
$("#saveRule").onclick = async () => {
    const ruleText = $("#trainRule").value.trim();
    if (!ruleText) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø£ÙˆÙ„Ø§Ù‹");
    
    try {
        await db.collection("knowledge").add({
            type: "rule",
            text: ruleText,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            addedBy: me.email
        });
        
        $("#ruleMsg").textContent = "âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø¨Ù†Ø¬Ø§Ø­";
        $("#trainRule").value = "";
        
        setTimeout(() => loadKnowledgeFromDB(), 1000);
    } catch (e) {
        $("#ruleMsg").textContent = "âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø£ÙˆØ§Ù…Ø±: " + e.message;
    }
};

$("#saveInfo").onclick = async () => {
    const infoText = $("#trainInfoText").value.trim();
    if (!infoText) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£ÙˆÙ„Ø§Ù‹");
    
    try {
        await db.collection("knowledge").add({
            type: "info",
            text: infoText,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            addedBy: me.email
        });
        
        $("#infoMsg").textContent = "âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¨Ù†Ø¬Ø§Ø­";
        $("#trainInfoText").value = "";
        
        setTimeout(() => loadKnowledgeFromDB(), 1000);
    } catch (e) {
        $("#infoMsg").textContent = "âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª: " + e.message;
    }
};

// Ù…Ø¹Ø§Ù„Ø¬Ø© PDF Ù…Ø­Ø³Ù†Ø©
let selectedPdfFiles = [];
$("#pickPdf").onclick = () => document.getElementById("pdfInput").click();

document.getElementById("pdfInput").addEventListener("change", (e) => {
    selectedPdfFiles = Array.from(e.target.files || []);
    const list = document.getElementById("fileList");
    list.innerHTML = selectedPdfFiles.map(f => `<div>ğŸ“„ ${f.name} (${(f.size/1024/1024).toFixed(2)} MB)</div>`).join("");
});

$("#processPdfs").onclick = async () => {
    if (selectedPdfFiles.length === 0) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„ÙØ§Øª PDF Ø£ÙˆÙ„Ø§Ù‹");
    
    const processBtn = $("#processPdfs");
    const originalText = processBtn.textContent;
    processBtn.disabled = true;
    processBtn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...";
    
    const progressBar = $("#pdfBar");
    const trainInfo = $("#trainInfo");
    
    try {
        let processedCount = 0;
        let totalPages = 0;
        progressBar.style.width = "0%";
        
        // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙØ­Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
        for (const file of selectedPdfFiles) {
            try {
                const pdf = await pdfjsLib.getDocument(URL.createObjectURL(file)).promise;
                totalPages += pdf.numPages;
            } catch (e) {
                console.error('Error counting pages:', e);
            }
        }
        
        let currentPage = 0;
        
        for (const file of selectedPdfFiles) {
            trainInfo.textContent = `Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø©: ${file.name}...`;
            
            try {
                const textContent = await extractTextFromPDF(file);
                
                if (textContent && textContent.trim()) {
                    // ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ Ø£Ø¬Ø²Ø§Ø¡ Ø£ØµØºØ±
                    const chunks = splitTextIntoChunks(textContent, 1500);
                    
                    for (const chunk of chunks) {
                        if (chunk.trim()) {
                            await db.collection("knowledge").add({
                                type: "pdf",
                                text: chunk,
                                fileName: file.name,
                                fileSize: file.size,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                addedBy: me.email
                            });
                        }
                    }
                    
                    processedCount++;
                    progressBar.style.width = `${(processedCount / selectedPdfFiles.length) * 100}%`;
                    trainInfo.textContent = `âœ… ØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© ${file.name} (${processedCount}/${selectedPdfFiles.length})`;
                } else {
                    trainInfo.textContent = `âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù†Øµ Ù…Ù† ${file.name}`;
                }
            } catch (fileError) {
                trainInfo.textContent = `âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© ${file.name}: ${fileError.message}`;
            }
            
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
        
        trainInfo.textContent = `âœ… ØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© ${processedCount}/${selectedPdfFiles.length} Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­`;
        $("#fileList").innerHTML = "";
        selectedPdfFiles = [];
        
        setTimeout(() => loadKnowledgeFromDB(), 1000);
        
    } catch (e) {
        trainInfo.textContent = "âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„ÙØ§Øª: " + e.message;
    } finally {
        processBtn.disabled = false;
        processBtn.textContent = originalText;
    }
};

// Ø¯Ø§Ù„Ø© Ù„ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ Ø£Ø¬Ø²Ø§Ø¡
function splitTextIntoChunks(text, maxChunkSize) {
    const chunks = [];
    const sentences = text.split(/(?<=[.!?])\s+/);
    let currentChunk = "";
    
    for (const sentence of sentences) {
        if ((currentChunk + sentence).length > maxChunkSize && currentChunk) {
            chunks.push(currentChunk.trim());
            currentChunk = sentence;
        } else {
            currentChunk += (currentChunk ? " " : "") + sentence;
        }
    }
    
    if (currentChunk.trim()) {
        chunks.push(currentChunk.trim());
    }
    
    return chunks;
}

// Ø¯Ø§Ù„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ù…Ù† PDF Ù…Ø­Ø³Ù†Ø©
async function extractTextFromPDF(file) {
    return new Promise((resolve, reject) => {
        const fileReader = new FileReader();
        
        fileReader.onload = async function() {
            try {
                const typedarray = new Uint8Array(this.result);
                const pdf = await pdfjsLib.getDocument(typedarray).promise;
                let fullText = '';
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    try {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        fullText += pageText + '\n\n';
                    } catch (pageError) {
                        console.error(`Error extracting page ${i}:`, pageError);
                        continue;
                    }
                }
                
                resolve(fullText.trim());
            } catch (error) {
                reject(new Error(`ÙØ´Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ: ${error.message}`));
            }
        };
        
        fileReader.onerror = function() {
            reject(new Error('ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù'));
        };
        
        fileReader.readAsArrayBuffer(file);
    });
}

/* Ø¥Ø¯Ø®Ø§Ù„ + Ù…Ø±ÙÙ‚Ø§Øª + Ø¥Ø±Ø³Ø§Ù„ */
$("#send").onclick=onSend;
$("#input").addEventListener("keydown",e=>{if(e.key==="Enter")onSend();});
$("#attach").onclick=()=>$("#imgFile").click();
$("#imgFile").addEventListener("change", async (e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    const myTok=++attachToken;
    const r=new FileReader();
    r.onload=()=>{ 
        if(myTok!==attachToken) return; 
        const dataURL=r.result; 
        attachedImage={
            name:(f.name||"image").replace(/\.\w+$/,"")+".jpg", 
            sizeKB:Math.round(f.size/1024), 
            dataURL
        }; 
        showAttachChip(); 
        input.focus(); 
    };
    r.readAsDataURL(f);
    
    try{
        if(ENABLE_OCR){
            toast("Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ±Ø©...");
            const {data:{text}}=await Tesseract.recognize(f,'ara+eng');
            if(myTok===attachToken && attachedImage) {
                attachedImage.ocrText=(text||"").trim();
                toast("ØªÙ… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­");
            }
        }
    }catch(ocrError){
        console.log('OCR Error:', ocrError);
        if(myTok===attachToken && attachedImage) {
            attachedImage.ocrText = "";
        }
    }
    e.target.value="";
});

function showAttachChip(){
    if(!attachedImage){ 
        attachWrap.classList.add("hidden"); 
        attachWrap.innerHTML=""; 
        return; 
    }
    const {name,sizeKB,dataURL}=attachedImage;
    attachWrap.innerHTML=`
        <div class="attach-chip">
            <div class="thumb"><img src="${dataURL}"></div>
            <div class="name">${name} Â· ${sizeKB}KB</div>
            <div class="x" id="removeAttach">âœ•</div>
        </div>`;
    attachWrap.classList.remove("hidden");
    $("#removeAttach").onclick=()=>{ 
        attachedImage=null; 
        ++attachToken; 
        showAttachChip(); 
        input.focus(); 
    };
}

function wantsLongExplain(t){ return /(Ø§Ø´Ø±Ø­|Ø´Ø±Ø­|ÙØ³Ø±|ÙˆØ¶Ø­|ÙØ³Ø±Ù„ÙŠ|Ø´Ø±Ø­Ù„ÙŠ|Ø­Ù„ Ø¨Ø§Ù„ØªÙØµÙŠÙ„|ØªÙØµÙŠÙ„|Ø§ÙÙ‡Ù…Ù†ÙŠ)/i.test(t||""); }
function isProblemLike(t){ return /(Ù…Ø³Ø§Ù„Ù‡|Ù…Ø¹Ø§Ø¯Ù„Ø©|Ø§Ø­Ø³Ø¨|Ø­Ù„|Ø¬Ø¯|Ù…Ø«Ø§Ù„|Ù‚Ø§Ù†ÙˆÙ†|Ù…ÙˆÙ„|ØªØ±ÙƒÙŠØ²|Ù…Ø¹Ø§ÙŠØ±Ù‡|Ø§ØªØ²Ø§Ù†|Ø­Ø±ÙƒÙ‡|Ù…Ø¬Ø§Ù„|ÙƒÙŠÙ…ÙŠØ§Ø¡|ÙÙŠØ²ÙŠØ§Ø¡|Ø±ÙŠØ§Ø¶ÙŠØ§Øª|Ø¹Ù„Ù…|Ø³Ø¤Ø§Ù„)/i.test(t||""); }

async function onSend(){
    if(!canChat){ $("#paywall").style.display="flex"; return; }
    const userTxt=$("#input").value.trim();
    if(!userTxt && !attachedImage) return;

    cancelCurrentStream();

    renderMsg(null,{role:"user",text:userTxt || "[ØµÙˆØ±Ø© ÙÙ‚Ø·]",imageDataURL:attachedImage?.dataURL || null});
    if(!currentChatId) await newChat();
    await db.collection("chats").doc(currentChatId).collection("messages")
        .add({ role:"user", text:userTxt || "[ØµÙˆØ±Ø© ÙÙ‚Ø·]", imageDataURL:attachedImage?.dataURL||null, clientTs: Date.now(), ts: firebase.firestore.FieldValue.serverTimestamp() });
    await db.collection("chats").doc(currentChatId).update({ clientUpdated: Date.now(), updatedAt:firebase.firestore.FieldValue.serverTimestamp() });

    let finalPrompt="";
    if(attachedImage){
        const ocr=attachedImage.ocrText && attachedImage.ocrText.trim()? attachedImage.ocrText.trim() : "";
        finalPrompt=[
            "Ù‡Ø°Ù‡ ØµÙˆØ±Ø© Ù…Ø³Ø£Ù„Ø©/Ù†Øµ. Ø­Ù„Ù‘Ù„ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø¯Ù‚Ø©:",
            ocr?("â€” Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬ (OCR):\n"+ocr):"",
            userTxt?("â€” Ù…Ù„Ø§Ø­Ø¸ØªÙŠ/Ø³Ø¤Ø§Ù„ÙŠ:\n"+userTxt):"",
            "Ø±Ø¬Ø§Ø¡Ù‹: Ø§Ø¹Ø±Ø¶ Ø§Ù„Ø­Ù„ Ø¨Ø®Ø·ÙˆØ§Øª Ù…Ø±Ù‚Ù…Ø© ÙˆØ¨Ù€ LaTeX Ø¯Ø§Ø®Ù„ $$ .. $$ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©."
        ].filter(Boolean).join("\n\n");
    }else{
        finalPrompt=userTxt;
    }
    $("#input").value="";
    attachedImage=null; ++attachToken; showAttachChip();

    const wantsLong = wantsLongExplain(userTxt) || isProblemLike(finalPrompt);
    const problem = isProblemLike(finalPrompt);

    if(!index){ try{ await loadKnowledgeFromDB(); }catch{} }

    const ctxPieces=retrieve(finalPrompt,8);
    const ctx=ctxPieces.join("\n---\n");

    const reqId=Math.random().toString(36).slice(2);
    const controller=new AbortController();
    currentStream={id:reqId,chatId:currentChatId,controller};

    startStreaming();
    try{
        await streamAI(ctx, finalPrompt, {wantsLong,isProblem:problem,signal:controller.signal,reqId});
    }catch(e){
        if(e.name==="AbortError") return;
        endStreaming(reqId);
        renderMsg(null,{role:"bot",text:"ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¨Ø«ØŒ Ø³Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ø¯ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©â€¦"});
        await callAIOnce(ctx, finalPrompt, {wantsLong,isProblem:problem});
    }
}

/* ØªÙ†Ø¸ÙŠÙ ØªÙƒØ±Ø§Ø±Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ */
function cleanAI(s){
    if(!s) return s;
    let x=(s||"").replace(/\r/g,"").replace(/[ \t]+\n/g,"\n").replace(/\n{3,}/g,"\n\n").trim();
    const paras=x.split(/\n{2,}/).map(p=>p.trim()).filter(Boolean);
    const out=[]; const seen=new Set();
    for(const p of paras){ const key=p.replace(/\s+/g," "); if(!seen.has(key)){ out.push(p); seen.add(key);} }
    x=out.join("\n\n");
    if(x.length>120){
        const mid=Math.floor(x.length/2);
        const a=x.slice(0,mid).trim(), b=x.slice(mid).trim();
        if(a===b) x=a;
    }
    return x;
}

/* AI - Ù†Ø¸Ø§Ù… Ù…Ø­Ø³Ù† Ù…Ø¹ Ø¯Ø¹Ù… ÙƒØ§Ù…Ù„ Ù„Ù„Ø±Ù…ÙˆØ² */
function sysPrompt({wantsLong,isProblem}){
    let prompt = [
        "Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø¯Ø±Ø§Ø³ÙŠ Ø°ÙƒÙŠ Ø¬Ø¯Ù‹Ø§ Ù…ØªØ®ØµØµ ÙÙŠ Ù…Ù†Ù‡Ø¬ Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø¹Ù„Ù…ÙŠ.",
        "ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ Ø¯Ù‚ÙŠÙ‚Ø© ÙˆÙ…ÙØµÙ„Ø© ÙˆÙ…Ù†Ø§Ø³Ø¨Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª.",
        wantsLong ? "Ø§ÙƒØªØ¨ Ø´Ø±Ø­Ù‹Ø§ ØªÙØµÙŠÙ„ÙŠÙ‹Ø§ Ù…Ø¹ Ø®Ø·ÙˆØ§Øª Ù…Ø±Ù‚Ù…Ø© ÙˆØ¹Ù†Ø§ÙˆÙŠÙ† ÙØ±Ø¹ÙŠØ©." : "Ø£Ø¬Ø¨ Ø¨ÙˆØ¶ÙˆØ­ ÙˆØ¥ÙŠØ¬Ø§Ø² Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ù‚Ø© Ø§Ù„Ø¹Ù„Ù…ÙŠØ©.",
        "Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ© ÙˆØ§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠØ© ÙˆØ§Ù„ÙÙŠØ²ÙŠØ§Ø¦ÙŠØ© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… LaTeX: $$ .. $$ Ø£Ùˆ \\( .. \\)",
        "**Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ©**: \\(\\alpha, \\beta, \\gamma, \\delta, \\Delta, \\pi, \\theta, \\lambda, \\mu, \\sigma, \\sum, \\prod, \\int, \\sqrt{}, \\frac{}{}, \\binom{}{}, \\times, \\div, \\pm, \\mp, \\leq, \\geq, \\neq, \\approx, \\equiv, \\propto, \\rightarrow, \\leftrightarrow, \\in, \\subset, \\cup, \\cap, \\forall, \\exists, \\therefore, \\because, \\angle, \\parallel, \\perp, \\circ, \\degree\\)",
        "**Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠØ©**: \\(H_2O, CO_2, CH_4, NaCl, H_2SO_4, NaOH, HCl, CaCO_3, Fe_2O_3, Al_2O_3, Mg(OH)_2\\)",
        "**Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¦ÙŠØ©**: \\(F = ma, E = mc^2, v = \\frac{d}{t}, a = \\frac{\\Delta v}{\\Delta t}, P = \\frac{F}{A}, W = F \\cdot d, P = \\frac{W}{t}\\)",
        isProblem ? "Ù„Ù„Ù…Ø³Ø§Ø¦Ù„: Ø§Ø³ØªØ®Ø¯Ù… Ø®Ø·ÙˆØ§Øª Ù…Ø±Ù‚Ù…Ø© 1,2,3â€¦ Ù…Ø¹ ØªØ¨Ø±ÙŠØ± Ø¹Ù„Ù…ÙŠ Ù…ÙˆØ¬Ø² Ù„ÙƒÙ„ Ø®Ø·ÙˆØ©." : "",
        "Ù‚Ø¯Ù… Ø£Ù…Ø«Ù„Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©.",
        "Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ø¨Ù„Ø·Ù ğŸ§ âœ¨ğŸ“šğŸ”",
        "ØªØ°ÙƒØ± Ø§Ù„Ø³ÙŠØ§Ù‚ ÙˆØ§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¨Ø´ÙƒÙ„ Ù…ØªØ±Ø§Ø¨Ø·.",
        "Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„Ù…Ù†Ø·Ù‚ÙŠØ© ÙˆØ§Ù„ØªØ¨Ø±ÙŠØ±Ø§Øª Ø§Ù„Ø¹Ù„Ù…ÙŠØ©.",
        "**ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©**: Ù…Ù‚Ø¯Ù…Ø© â† Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ù„ â† Ù†ØªÙŠØ¬Ø© â† Ù…Ù„Ø®Øµ."
    ].filter(Boolean).join("\n");

    if (rulesMemo) {
        prompt += "\n\n### Ø§Ù„Ø£ÙˆØ§Ù…Ø± ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª:\n" + rulesMemo;
    }

    if (knowledgeChunks.length > 0) {
        const recentKnowledge = knowledgeChunks.slice(0, 5).join("\n\n");
        prompt += "\n\n### Ø§Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ©:\n" + recentKnowledge;
    }

    return prompt;
}

function startStreaming(){
    isStreaming = true;
    streamingEl = document.createElement("div");
    streamingEl.className = "msg bot";
    streamingEl.dataset.role = "bot";
    streamingEl.textContent = "";
    streamedText="";
    msgs.appendChild(streamingEl);
    msgs.scrollTo({top: msgs.scrollHeight + 1000, behavior: "smooth"});
}

function pushChunk(txt, reqId){
    if(currentStream.id!==reqId) return;
    if(!streamingEl) startStreaming();
    streamingEl.textContent += txt;
    streamedText += txt;
    msgs.scrollTo({top: msgs.scrollHeight + 1000});
}

function endStreaming(reqId){
    if(currentStream.id!==reqId) return;
    if(!streamingEl){ isStreaming=false; streamedText=""; return; }
    const cleaned = cleanAI(streamedText||"");
    const html = cleaned.replace(/</g,"&lt;").replace(/>/g,"&gt;");
    const isMath = /\\(frac|sqrt|sum|Delta|pi|times|div|rightarrow|left|right|alpha|beta|gamma|delta)|\$\$|H_2O|CO_2/i.test(cleaned);
    const finalEl = document.createElement("div");
    finalEl.className = `msg bot${isMath?" math":""}`;
    finalEl.dataset.role="bot";
    const box = document.createElement("div"); 
    box.style.cssText = "font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Tajawal', sans-serif; line-height: 1.6;";
    box.innerHTML = html; 
    finalEl.appendChild(box);
    streamingEl.replaceWith(finalEl);
    if(isMath && window.MathJax) MathJax.typesetPromise([finalEl]).catch(()=>{});
    streamingEl = null; isStreaming=false;
    streamedText = cleaned;
}

async function streamAI(context, user, {wantsLong,isProblem,signal,reqId}){
    try {
        const messages = [
            {
                role: "system", 
                content: sysPrompt({wantsLong, isProblem})
            },
            { role: "user", content: user }
        ];

        const body = {
            model: "deepseek-chat",
            messages: messages,
            stream: true,
            max_tokens: 2000
        };

        const res = await fetch(AI_ENDPOINT, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${AI_KEY}`
            },
            body: JSON.stringify(body),
            signal
        });

        if (!res.ok) {
            throw new Error(`HTTP ${res.status}`);
        }

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        
        while (true) {
            const {done, value} = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');

            for (const line of lines) {
                if (line.startsWith('data: ') && !line.includes('[DONE]')) {
                    try {
                        const data = JSON.parse(line.slice(6));
                        const content = data.choices[0]?.delta?.content;
                        if (content) {
                            pushChunk(content, reqId);
                        }
                    } catch (e) {
                        // ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù€ JSON
                    }
                }
            }
        }

        const finalText = cleanAI(streamedText);
        endStreaming(reqId);
        await appendMessageStore("bot", finalText, null, currentStream.chatId);

    } catch (error) {
        if (error.name !== "AbortError") {
            throw error;
        }
    }
}

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© callAIOnce
async function callAIOnce(context, user, {wantsLong, isProblem}) {
    try {
        const messages = [
            {
                role: "system", 
                content: sysPrompt({wantsLong, isProblem})
            },
            { role: "user", content: user }
        ];

        const body = {
            model: "deepseek-chat",
            messages: messages,
            max_tokens: 2000
        };

        const res = await fetch(AI_ENDPOINT, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${AI_KEY}`
            },
            body: JSON.stringify(body)
        });

        if (!res.ok) {
            throw new Error(`HTTP ${res.status}`);
        }

        const data = await res.json();
        const responseText = data.choices[0]?.message?.content || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø§Ø¨Ø©";
        
        const cleaned = cleanAI(responseText);
        renderMsg(null, {role: "bot", text: cleaned});
        await appendMessageStore("bot", cleaned, null, currentChatId);
        
        return cleaned;
    } catch (error) {
        console.error('AI Error:', error);
        const errorMsg = "Ø¹Ø°Ø±Ù‹Ø§ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
        renderMsg(null, {role: "bot", text: errorMsg});
        await appendMessageStore("bot", errorMsg, null, currentChatId);
        throw error;
    }
}

/* ===== Ø§Ø­ØµØ§Ø¡Ø§Øª ===== */
async function refreshUserStats(){
    if(me?.email!==ADMIN_EMAIL){
        $("#statTotal").textContent="â€”";
        $("#statActiveNow").textContent="â€”";
        $("#statUsersToday").textContent="â€”";
        $("#statMsgsToday").textContent="â€”";
        return alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©.");
    }
    const now=new Date(); const startOfDay=new Date(now.getFullYear(),now.getMonth(),now.getDate());
    const usersSnap=await db.collection("users").get();
    const totalUsers=usersSnap.size;
    const fiveMinAgo=new Date(now.getTime()-5*60*1000);
    let activeNow=0, usersToday=0;
    usersSnap.forEach(d=>{
        const u=d.data(); const la=u.lastActive?.toDate?u.lastActive.toDate():null;
        if(la){ if(la>=fiveMinAgo) activeNow++; if(la>=startOfDay) usersToday++; }
    });
    let msgsToday=0;
    const chatsSnap=await db.collection("chats").where("updatedAt",">=", firebase.firestore.Timestamp.fromDate(startOfDay)).get().catch(()=>({docs:[]}));
    for(const ch of (chatsSnap.docs||[])){
        const mSnap=await db.collection("chats").doc(ch.id).collection("messages").where("ts",">=", firebase.firestore.Timestamp.fromDate(startOfDay)).get().catch(()=>({size:0}));
        msgsToday+=(mSnap.size||0);
    }
    $("#statTotal").textContent=totalUsers;
    $("#statActiveNow").textContent=activeNow;
    $("#statUsersToday").textContent=usersToday;
    $("#statMsgsToday").textContent=msgsToday;
}

/* ===== ØµÙØ­Ø§Øª ===== */
function openPage(id){ const el=$(id); if(!el) return; el.style.display="block"; pageStack.push(id); }
function goBack(){
    if(pageStack.length<=1){ pageStack=[]; document.querySelectorAll(".page").forEach(p=>p.style.display="none"); return; }
    const cur=pageStack.pop(); if(cur) $(cur).style.display="none"; const prev=pageStack[pageStack.length-1]; if(prev) $(prev).style.display="block";
}
document.querySelectorAll("[data-back]").forEach(b=>b.addEventListener("click",goBack));
$("#adminBtn").onclick=()=>{ if(me?.email!==ADMIN_EMAIL){ alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©."); return; } openPage("#pageHub"); };
$("#tileUsers").onclick=()=>{ $("#pageHub").style.display="none"; openPage("#pageUsers"); refreshUserStats(); };
$("#tileSubs").onclick =()=>{ $("#pageHub").style.display="none"; openPage("#pageSubs"); };
$("#tileTrain").onclick=()=>{ $("#pageHub").style.display="none"; openPage("#pageTrain"); };
$("#logout").onclick=()=>auth.signOut();

/* ===== Ø§Ø´ØªØ±Ø§ÙƒØ§Øª: Ø¥Ø¶Ø§ÙØ© + Ø¥Ù„ØºØ§Ø¡ ===== */
$("#addDays").onclick=async ()=>{
    if(me?.email!==ADMIN_EMAIL) return alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©.");
    const email=($("#subEmail").value||"").trim();
    const days=parseInt($("#subDays").value||"0",10);
    if(!email || !days || days<=0) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆØ¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… (>0).");
    const q=await db.collection("users").where("email","==",email).limit(1).get();
    if(q.empty) return $("#subMsg").textContent="Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.";
    const ref=q.docs[0].ref; const doc=await ref.get(); const d=doc.data();
    const now=new Date();
    
    let curEnd = now;
    if (d.subscribed && d.subscriptionEnd?.toDate) {
        curEnd = d.subscriptionEnd.toDate();
        if (curEnd < now) curEnd = now;
    }
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ÙŠØ§Ù… Ø¨Ø§Ù„Ø¶Ø¨Ø· (Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ)
    const newEnd=new Date(curEnd.getTime() + (days * 24 * 60 * 60 * 1000));
    
    await ref.update({
        subscribed: true,
        subscriptionEnd: firebase.firestore.Timestamp.fromDate(newEnd),
        blocked: false
    });
    
    $("#subMsg").textContent=`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${days} ÙŠÙˆÙ…. Ø§Ù„Ù†Ù‡Ø§ÙŠØ©: ${newEnd.toLocaleDateString('ar-SA')}`;
    $("#subEmail").value = "";
    $("#subDays").value = "";
};

$("#cancelSub").onclick=async ()=>{
    if(me?.email!==ADMIN_EMAIL) return alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©.");
    const email=($("#cancelEmail").value||"").trim();
    if(!email) return alert("Ø§ÙƒØªØ¨ Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….");
    const q=await db.collection("users").where("email","==",email).limit(1).get();
    if(q.empty) return $("#cancelMsg").textContent="Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.";
    const ref=q.docs[0].ref;
    await ref.update({
        subscribed: false,
        subscriptionEnd: null,
        blocked: true,
        canceledAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    $("#cancelMsg").textContent="ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙˆØ±Ù‹Ø§. Ø³ÙŠØ¸Ù‡Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Paywall Ø­ØªÙ‰ ÙŠØ¹ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ.";
    $("#cancelEmail").value = "";
};

// Ø²Ø± Ø­Ø¸Ø± Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©
$("#blockDeviceBtn").onclick = async () => {
    if(me?.email!==ADMIN_EMAIL) return alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©.");
    const deviceId = $("#blockDeviceId").value.trim();
    const reason = $("#blockReason").value.trim() || "Ø§Ù†ØªÙ‡Ø§Ùƒ Ø´Ø±ÙˆØ· Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…";
    
    if (!deviceId) return alert("Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù‡Ø§Ø²");
    
    try {
        await db.collection("blockedDevices").add({
            deviceId: deviceId,
            reason: reason,
            blockedBy: me.email,
            blockedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        $("#blockMsg").textContent = "âœ… ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¨Ù†Ø¬Ø§Ø­";
        $("#blockDeviceId").value = "";
        $("#blockReason").value = "";
    } catch (e) {
        $("#blockMsg").textContent = "âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø¸Ø± Ø§Ù„Ø¬Ù‡Ø§Ø²: " + e.message;
    }
};

// Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
function cleanup() {
    if (unsubProfile) {
        unsubProfile();
        unsubProfile = null;
    }
    if (unSubMsgs) {
        unSubMsgs();
        unSubMsgs = null;
    }
    if (timerId) {
        clearInterval(timerId);
        timerId = null;
    }
    cancelCurrentStream();
}

window.addEventListener('beforeunload', cleanup);
window.addEventListener("load",()=>{ applyTheme(); adjustMsgsPadding(); });

// Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± ÙÙŠ Ø§Ù„Ø¢Ø®Ø±
$("#themeToggleSidebar").onclick = () => {
    THEME = THEME === "dark" ? "light" : "dark";
    saveLocal("THEME", THEME);
    applyTheme();
    closeSidebar();
};
$(".theme-toggle").style.display = "none";
</script>
</body>
</html>
